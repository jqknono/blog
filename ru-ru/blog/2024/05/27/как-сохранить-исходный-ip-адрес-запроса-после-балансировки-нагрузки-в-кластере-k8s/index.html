<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=ru-ru class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Как сохранить исходный IP-адрес запроса после балансировки нагрузки в кластере K8s | jqknono Blogs</title><meta name=description content="Введение Развертывание приложений не всегда сводится к простому установке и запуску, иногда также приходится учитывать проблемы сети. В этой статье описывается, как в кластере k8s сделать так, чтобы сервис мог получить исходный IP запроса.
Приложения, предоставляющие услуги, обычно зависят от входной информации. Если входная информация не зависит от пятерки (исходный IP, исходный порт, целевой IP, целевой порт, протокол), то такое приложение имеет низкую связанность с сетью и не нуждается в деталях сети."><meta property="og:url" content="https://blog.jqknono.com/ru-ru/blog/2024/05/27/%D0%BA%D0%B0%D0%BA-%D1%81%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B8%D1%82%D1%8C-%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D1%8B%D0%B9-ip-%D0%B0%D0%B4%D1%80%D0%B5%D1%81-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0-%D0%BF%D0%BE%D1%81%D0%BB%D0%B5-%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8-%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8-%D0%B2-%D0%BA%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B5-k8s/"><meta property="og:site_name" content="jqknono Blogs"><meta property="og:title" content="Как сохранить исходный IP-адрес запроса после балансировки нагрузки в кластере K8s"><meta property="og:description" content="Введение Развертывание приложений не всегда сводится к простому установке и запуску, иногда также приходится учитывать проблемы сети. В этой статье описывается, как в кластере k8s сделать так, чтобы сервис мог получить исходный IP запроса.
Приложения, предоставляющие услуги, обычно зависят от входной информации. Если входная информация не зависит от пятерки (исходный IP, исходный порт, целевой IP, целевой порт, протокол), то такое приложение имеет низкую связанность с сетью и не нуждается в деталях сети."><meta property="og:locale" content="ru_ru"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-05-27T11:52:22+08:00"><meta property="article:modified_time" content="2024-05-27T11:52:22+08:00"><meta property="article:tag" content="Сети"><meta property="article:tag" content="Blog"><meta itemprop=name content="Как сохранить исходный IP-адрес запроса после балансировки нагрузки в кластере K8s"><meta itemprop=description content="Введение Развертывание приложений не всегда сводится к простому установке и запуску, иногда также приходится учитывать проблемы сети. В этой статье описывается, как в кластере k8s сделать так, чтобы сервис мог получить исходный IP запроса.
Приложения, предоставляющие услуги, обычно зависят от входной информации. Если входная информация не зависит от пятерки (исходный IP, исходный порт, целевой IP, целевой порт, протокол), то такое приложение имеет низкую связанность с сетью и не нуждается в деталях сети."><meta itemprop=datePublished content="2024-05-27T11:52:22+08:00"><meta itemprop=dateModified content="2024-05-27T11:52:22+08:00"><meta itemprop=wordCount content="1393"><meta itemprop=keywords content="Сети,Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Как сохранить исходный IP-адрес запроса после балансировки нагрузки в кластере K8s"><meta name=twitter:description content="Введение Развертывание приложений не всегда сводится к простому установке и запуску, иногда также приходится учитывать проблемы сети. В этой статье описывается, как в кластере k8s сделать так, чтобы сервис мог получить исходный IP запроса.
Приложения, предоставляющие услуги, обычно зависят от входной информации. Если входная информация не зависит от пятерки (исходный IP, исходный порт, целевой IP, целевой порт, протокол), то такое приложение имеет низкую связанность с сетью и не нуждается в деталях сети."><link rel=preload href=/scss/main.min.19deb9bb49a16bab1391617801cf2d75f58ded83cae46516f211ba8fc3e9f6f9.css as=style integrity="sha256-Gd65u0mha6sTkWF4Ac8tdfWN7YPK5GUW8hG6j8Pp9vk=" crossorigin=anonymous><link href=/scss/main.min.19deb9bb49a16bab1391617801cf2d75f58ded83cae46516f211ba8fc3e9f6f9.css rel=stylesheet integrity="sha256-Gd65u0mha6sTkWF4Ac8tdfWN7YPK5GUW8hG6j8Pp9vk=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3FFTG72NE"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3FFTG72NE")}</script></head><body class="td-page td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/ru-ru/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>jqknono Blogs</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://jqknono.com target=_blank rel=noopener><span>About</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class=nav-item><a class=nav-link href=https://github.com/jqknono target=_blank rel=noopener><i class="fab fa-github" aria-hidden=true></i><span>GitHub</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class="nav-item td-navbar__lang-menu"><div class="td-lang-menu dropdown"><a class="nav-link dropdown-toggle td-lang-menu__title" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class=td-lang-menu__title-text>Русский</span>
<span class=td-lang-menu__title-code>RU-RU</span></a><ul class=dropdown-menu><li><a class=dropdown-item href=/blog/2024/05/27/how-to-preserve-the-source-ip-of-requests-after-load-balancing-in-a-k8s-cluster/>English</a></li><li><a class=dropdown-item href=/zh-tw/blog/2024/05/27/k8s%E5%8F%A2%E9%9B%86%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BF%9D%E7%95%99%E8%B2%A0%E8%BC%89%E5%9D%87%E8%A1%A1%E5%BE%8C%E7%9A%84%E8%AB%8B%E6%B1%82%E6%BA%90ip/>繁體中文</a></li><li><a class=dropdown-item href=/ja-jp/blog/1/01/01/>日本語</a></li><li><a class=dropdown-item href=/ko-kr/blog/2024/05/27/k8s-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%EC%97%90%EC%84%9C-%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%8B%B1-%ED%9B%84-%EC%9A%94%EC%B2%AD-%EC%9B%90%EB%B3%B8-ip%EB%A5%BC-%EB%B3%B4%EC%A1%B4%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95/>한국어</a></li><li><a class=dropdown-item href=/ar-sa/blog/1/01/01/>العربية</a></li><li><a class=dropdown-item href=/de-de/blog/2024/05/27/wie-beh%C3%A4lt-man-in-einem-k8s-cluster-die-quell-ip-der-anfragen-nach-der-lastverteilung-bei/>Deutsch</a></li><li><a class=dropdown-item href=/fr-fr/blog/2024/05/27/comment-conserver-lip-source-des-requ%C3%AAtes-apr%C3%A8s-%C3%A9quilibrage-de-charge-dans-un-cluster-k8s/>Français</a></li><li><a class=dropdown-item href=/hi-in/blog/2024/05/27/k8s-%E0%A4%95%E0%A5%8D%E0%A4%B2%E0%A4%B8%E0%A5%8D%E0%A4%9F%E0%A4%B0-%E0%A4%AE%E0%A5%87%E0%A4%82-%E0%A4%B2%E0%A5%8B%E0%A4%A1-%E0%A4%AC%E0%A5%88%E0%A4%B2%E0%A5%87%E0%A4%82%E0%A4%B8%E0%A4%B0-%E0%A4%95%E0%A5%87-%E0%A4%AC%E0%A4%BE%E0%A4%A6-%E0%A4%95%E0%A5%87-%E0%A4%85%E0%A4%A8%E0%A5%81%E0%A4%B0%E0%A5%8B%E0%A4%A7-%E0%A4%B8%E0%A5%8D%E0%A4%B0%E0%A5%8B%E0%A4%A4-ip-%E0%A4%95%E0%A5%8B-%E0%A4%95%E0%A5%88%E0%A4%B8%E0%A5%87-%E0%A4%AC%E0%A4%A8%E0%A4%BE%E0%A4%8F-%E0%A4%B0%E0%A4%96%E0%A5%87%E0%A4%82/>हिंदी</a></li><li><a class=dropdown-item href=/es-es/blog/2024/05/27/c%C3%B3mo-conservar-la-ip-de-origen-de-las-solicitudes-despu%C3%A9s-de-la-equilibraci%C3%B3n-de-carga-en-un-cl%C3%BAster-de-k8s/>Español</a></li><li><a class=dropdown-item href=/pt-br/blog/2024/05/27/como-preservar-o-ip-de-origem-da-solicita%C3%A7%C3%A3o-ap%C3%B3s-o-balanceamento-de-carga-em-um-cluster-k8s/>Português</a></li><li><span class="dropdown-item active">Русский</span></li><li><a class=dropdown-item href=/it-it/blog/2024/05/27/come-preservare-lip-sorgente-delle-richieste-dopo-il-bilanciamento-del-carico-in-un-cluster-k8s/>Italiano</a></li><li><span class="dropdown-item disabled">Bahasa Indonesia</span></li><li><a class=dropdown-item href=/tr-tr/blog/2024/05/27/k8s-k%C3%BCmesinde-y%C3%BCk-dengeleme-sonras%C4%B1-istek-kaynak-ipsini-nas%C4%B1l-koruyabiliriz/>Türkçe</a></li><li><a class=dropdown-item href=/nl-nl/blog/2024/05/27/hoe-behoud-je-het-bron-ip-van-verzoeken-na-load-balancing-in-een-k8s-cluster/>Nederlands</a></li><li><a class=dropdown-item href=/pl-pl/blog/2024/05/27/jak-zachowa%C4%87-oryginalny-ip-%C5%BAr%C3%B3d%C5%82a-%C5%BC%C4%85dania-po-r%C3%B3wnowa%C5%BCeniu-obci%C4%85%C5%BCenia-w-klastrze-k8s/>Polski</a></li><li><a class=dropdown-item href=/ar-ae/blog/1/01/01/>العربية</a></li><li><a class=dropdown-item href=/zh-cn/blog/2024/05/27/k8s%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BF%9D%E7%95%99%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%90%8E%E7%9A%84%E8%AF%B7%E6%B1%82%E6%BA%90ip/>简体中文</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Поиск по сайту…" aria-label="Поиск по сайту…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d95ef0ca12d5cc9ab843f58f1bb7856a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main data-bs-spy=scroll data-bs-target=.td-toc data-bs-root-margin="0px 0px -10%"><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Поиск по сайту…" aria-label="Поиск по сайту…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.d95ef0ca12d5cc9ab843f58f1bb7856a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="td-sidebar-nav collapse td-sidebar-nav--search-disabled foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-ru-rublog-li><a href=/ru-ru/blog/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-ru-rublog><span>Blogs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20251203d180d0b5d0bad0bed0bcd0b5d0bdd0b4d183d0b5d182d181d18f-d0bfd0bed0bad0b0-d0bdd0b5-d0b8d181d0bfd0bed0bbd18cd0b7d0bed0b2d0b0d182d18c-d184d183d0bdd0bad186d0b8d18e-esa_page-d0bed182-alibaba-cloud-li><input type=checkbox id=m-ru-rublog20251203d180d0b5d0bad0bed0bcd0b5d0bdd0b4d183d0b5d182d181d18f-d0bfd0bed0bad0b0-d0bdd0b5-d0b8d181d0bfd0bed0bbd18cd0b7d0bed0b2d0b0d182d18c-d184d183d0bdd0bad186d0b8d18e-esa_page-d0bed182-alibaba-cloud-check>
<label for=m-ru-rublog20251203d180d0b5d0bad0bed0bcd0b5d0bdd0b4d183d0b5d182d181d18f-d0bfd0bed0bad0b0-d0bdd0b5-d0b8d181d0bfd0bed0bbd18cd0b7d0bed0b2d0b0d182d18c-d184d183d0bdd0bad186d0b8d18e-esa_page-d0bed182-alibaba-cloud-check><a href=/ru-ru/blog/2025/12/03/%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%B5%D0%BD%D0%B4%D1%83%D0%B5%D1%82%D1%81%D1%8F-%D0%BF%D0%BE%D0%BA%D0%B0-%D0%BD%D0%B5-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8E-esa_page-%D0%BE%D1%82-alibaba-cloud/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20251203d180d0b5d0bad0bed0bcd0b5d0bdd0b4d183d0b5d182d181d18f-d0bfd0bed0bad0b0-d0bdd0b5-d0b8d181d0bfd0bed0bbd18cd0b7d0bed0b2d0b0d182d18c-d184d183d0bdd0bad186d0b8d18e-esa_page-d0bed182-alibaba-cloud><span>Рекомендуется пока не использовать функцию ESA_page от Alibaba Cloud</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20251202d0bfd0bed0b4d0b2d0bed0b4d0bdd18bd0b5-d0bad0b0d0bcd0bdd0b8-alibaba-esa-d0b8-oss-li><input type=checkbox id=m-ru-rublog20251202d0bfd0bed0b4d0b2d0bed0b4d0bdd18bd0b5-d0bad0b0d0bcd0bdd0b8-alibaba-esa-d0b8-oss-check>
<label for=m-ru-rublog20251202d0bfd0bed0b4d0b2d0bed0b4d0bdd18bd0b5-d0bad0b0d0bcd0bdd0b8-alibaba-esa-d0b8-oss-check><a href=/ru-ru/blog/2025/12/02/%D0%BF%D0%BE%D0%B4%D0%B2%D0%BE%D0%B4%D0%BD%D1%8B%D0%B5-%D0%BA%D0%B0%D0%BC%D0%BD%D0%B8-alibaba-esa-%D0%B8-oss/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20251202d0bfd0bed0b4d0b2d0bed0b4d0bdd18bd0b5-d0bad0b0d0bcd0bdd0b8-alibaba-esa-d0b8-oss><span>Подводные камни Alibaba ESA и OSS</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20251202d0bcd0bed0b6d0bdd0be-d0bbd0b8-d0bfd0bed0bbd0bdd0bed181d182d18cd18e-d0b4d0bed0b2d0b5d180d18fd182d18c-cloudflare-li><input type=checkbox id=m-ru-rublog20251202d0bcd0bed0b6d0bdd0be-d0bbd0b8-d0bfd0bed0bbd0bdd0bed181d182d18cd18e-d0b4d0bed0b2d0b5d180d18fd182d18c-cloudflare-check>
<label for=m-ru-rublog20251202d0bcd0bed0b6d0bdd0be-d0bbd0b8-d0bfd0bed0bbd0bdd0bed181d182d18cd18e-d0b4d0bed0b2d0b5d180d18fd182d18c-cloudflare-check><a href=/ru-ru/blog/2025/12/02/%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE-%D0%BB%D0%B8-%D0%BF%D0%BE%D0%BB%D0%BD%D0%BE%D1%81%D1%82%D1%8C%D1%8E-%D0%B4%D0%BE%D0%B2%D0%B5%D1%80%D1%8F%D1%82%D1%8C-cloudflare/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20251202d0bcd0bed0b6d0bdd0be-d0bbd0b8-d0bfd0bed0bbd0bdd0bed181d182d18cd18e-d0b4d0bed0b2d0b5d180d18fd182d18c-cloudflare><span>Можно ли полностью доверять Cloudflare</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20251201d0b7d0b0d0b3d0b0d0b4d0bad0b0-d183d0bbd183d187d188d0b5d0bdd0b8d18f-d0b7d180d0b5d0bdd0b8d18f-li><input type=checkbox id=m-ru-rublog20251201d0b7d0b0d0b3d0b0d0b4d0bad0b0-d183d0bbd183d187d188d0b5d0bdd0b8d18f-d0b7d180d0b5d0bdd0b8d18f-check>
<label for=m-ru-rublog20251201d0b7d0b0d0b3d0b0d0b4d0bad0b0-d183d0bbd183d187d188d0b5d0bdd0b8d18f-d0b7d180d0b5d0bdd0b8d18f-check><a href=/ru-ru/blog/2025/12/01/%D0%B7%D0%B0%D0%B3%D0%B0%D0%B4%D0%BA%D0%B0-%D1%83%D0%BB%D1%83%D1%87%D1%88%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B7%D1%80%D0%B5%D0%BD%D0%B8%D1%8F/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20251201d0b7d0b0d0b3d0b0d0b4d0bad0b0-d183d0bbd183d187d188d0b5d0bdd0b8d18f-d0b7d180d0b5d0bdd0b8d18f><span>Загадка улучшения зрения</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20230506d0bfd180d0bed0b1d0bbd0b5d0bcd0b0-ipv6-d0bfd180d0b8-d0b1d180d0b8d0b4d0b6d0b8d0bdd0b3d0b5-d0b2-windows-li><input type=checkbox id=m-ru-rublog20230506d0bfd180d0bed0b1d0bbd0b5d0bcd0b0-ipv6-d0bfd180d0b8-d0b1d180d0b8d0b4d0b6d0b8d0bdd0b3d0b5-d0b2-windows-check>
<label for=m-ru-rublog20230506d0bfd180d0bed0b1d0bbd0b5d0bcd0b0-ipv6-d0bfd180d0b8-d0b1d180d0b8d0b4d0b6d0b8d0bdd0b3d0b5-d0b2-windows-check><a href=/ru-ru/blog/2023/05/06/%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D0%B0-ipv6-%D0%BF%D1%80%D0%B8-%D0%B1%D1%80%D0%B8%D0%B4%D0%B6%D0%B8%D0%BD%D0%B3%D0%B5-%D0%B2-windows/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20230506d0bfd180d0bed0b1d0bbd0b5d0bcd0b0-ipv6-d0bfd180d0b8-d0b1d180d0b8d0b4d0b6d0b8d0bdd0b3d0b5-d0b2-windows><span>Проблема IPv6 при бриджинге в Windows</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20240527d183d181d182d0b0d0bdd0bed0b2d0bad0b0-d0b8-d0b0d0bad182d0b8d0b2d0b0d186d0b8d18f-d181d0b8d181d182d0b5d0bcd18b-windows-li><input type=checkbox id=m-ru-rublog20240527d183d181d182d0b0d0bdd0bed0b2d0bad0b0-d0b8-d0b0d0bad182d0b8d0b2d0b0d186d0b8d18f-d181d0b8d181d182d0b5d0bcd18b-windows-check>
<label for=m-ru-rublog20240527d183d181d182d0b0d0bdd0bed0b2d0bad0b0-d0b8-d0b0d0bad182d0b8d0b2d0b0d186d0b8d18f-d181d0b8d181d182d0b5d0bcd18b-windows-check><a href=/ru-ru/blog/2024/05/27/%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B8-%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%B0%D1%86%D0%B8%D1%8F-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B-windows/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20240527d183d181d182d0b0d0bdd0bed0b2d0bad0b0-d0b8-d0b0d0bad182d0b8d0b2d0b0d186d0b8d18f-d181d0b8d181d182d0b5d0bcd18b-windows><span>Установка и активация системы Windows</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-ru-rublog20240527d0bad0b0d0ba-d181d0bed185d180d0b0d0bdd0b8d182d18c-d0b8d181d185d0bed0b4d0bdd18bd0b9-ip-d0b0d0b4d180d0b5d181-d0b7d0b0d0bfd180d0bed181d0b0-d0bfd0bed181d0bbd0b5-d0b1d0b0d0bbd0b0d0bdd181d0b8d180d0bed0b2d0bad0b8-d0bdd0b0d0b3d180d183d0b7d0bad0b8-d0b2-d0bad0bbd0b0d181d182d0b5d180d0b5-k8s-li><input type=checkbox id=m-ru-rublog20240527d0bad0b0d0ba-d181d0bed185d180d0b0d0bdd0b8d182d18c-d0b8d181d185d0bed0b4d0bdd18bd0b9-ip-d0b0d0b4d180d0b5d181-d0b7d0b0d0bfd180d0bed181d0b0-d0bfd0bed181d0bbd0b5-d0b1d0b0d0bbd0b0d0bdd181d0b8d180d0bed0b2d0bad0b8-d0bdd0b0d0b3d180d183d0b7d0bad0b8-d0b2-d0bad0bbd0b0d181d182d0b5d180d0b5-k8s-check checked>
<label for=m-ru-rublog20240527d0bad0b0d0ba-d181d0bed185d180d0b0d0bdd0b8d182d18c-d0b8d181d185d0bed0b4d0bdd18bd0b9-ip-d0b0d0b4d180d0b5d181-d0b7d0b0d0bfd180d0bed181d0b0-d0bfd0bed181d0bbd0b5-d0b1d0b0d0bbd0b0d0bdd181d0b8d180d0bed0b2d0bad0b8-d0bdd0b0d0b3d180d183d0b7d0bad0b8-d0b2-d0bad0bbd0b0d181d182d0b5d180d0b5-k8s-check><a href=/ru-ru/blog/2024/05/27/%D0%BA%D0%B0%D0%BA-%D1%81%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B8%D1%82%D1%8C-%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D1%8B%D0%B9-ip-%D0%B0%D0%B4%D1%80%D0%B5%D1%81-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0-%D0%BF%D0%BE%D1%81%D0%BB%D0%B5-%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8-%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8-%D0%B2-%D0%BA%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B5-k8s/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20240527d0bad0b0d0ba-d181d0bed185d180d0b0d0bdd0b8d182d18c-d0b8d181d185d0bed0b4d0bdd18bd0b9-ip-d0b0d0b4d180d0b5d181-d0b7d0b0d0bfd180d0bed181d0b0-d0bfd0bed181d0bbd0b5-d0b1d0b0d0bbd0b0d0bdd181d0b8d180d0bed0b2d0bad0b8-d0bdd0b0d0b3d180d183d0b7d0bad0b8-d0b2-d0bad0bbd0b0d181d182d0b5d180d0b5-k8s><span class=td-sidebar-nav-active-item>Как сохранить исходный IP-адрес запроса после балансировки нагрузки в кластере K8s</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20240521d0bfd0bed0bbd0bdd0bed0b5-d180d0b5d188d0b5d0bdd0b8d0b5-wireguard-d0bfd180d0bed182d0b8d0b2-udp-qos-d0bed0bfd0b5d180d0b0d182d0bed180d0bed0b2-li><input type=checkbox id=m-ru-rublog20240521d0bfd0bed0bbd0bdd0bed0b5-d180d0b5d188d0b5d0bdd0b8d0b5-wireguard-d0bfd180d0bed182d0b8d0b2-udp-qos-d0bed0bfd0b5d180d0b0d182d0bed180d0bed0b2-check>
<label for=m-ru-rublog20240521d0bfd0bed0bbd0bdd0bed0b5-d180d0b5d188d0b5d0bdd0b8d0b5-wireguard-d0bfd180d0bed182d0b8d0b2-udp-qos-d0bed0bfd0b5d180d0b0d182d0bed180d0bed0b2-check><a href=/ru-ru/blog/2024/05/21/%D0%BF%D0%BE%D0%BB%D0%BD%D0%BE%D0%B5-%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5-wireguard-%D0%BF%D1%80%D0%BE%D1%82%D0%B8%D0%B2-udp-qos-%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20240521d0bfd0bed0bbd0bdd0bed0b5-d180d0b5d188d0b5d0bdd0b8d0b5-wireguard-d0bfd180d0bed182d0b8d0b2-udp-qos-d0bed0bfd0b5d180d0b0d182d0bed180d0bed0b2><span>Полное решение WireGuard против UDP QoS операторов</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20240520d0bfd180d0b5d0b4d181d182d0b0d0b2d0bbd0b5d0bdd0b8d0b5-d0bdd0bed0b2d0b8d187d0bad0b0e5b091e695b0e6b4be-li><input type=checkbox id=m-ru-rublog20240520d0bfd180d0b5d0b4d181d182d0b0d0b2d0bbd0b5d0bdd0b8d0b5-d0bdd0bed0b2d0b8d187d0bad0b0e5b091e695b0e6b4be-check>
<label for=m-ru-rublog20240520d0bfd180d0b5d0b4d181d182d0b0d0b2d0bbd0b5d0bdd0b8d0b5-d0bdd0bed0b2d0b8d187d0bad0b0e5b091e695b0e6b4be-check><a href=/ru-ru/blog/2024/05/20/%D0%BF%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BD%D0%BE%D0%B2%D0%B8%D1%87%D0%BA%D0%B0%E5%B0%91%E6%95%B0%E6%B4%BE/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20240520d0bfd180d0b5d0b4d181d182d0b0d0b2d0bbd0b5d0bdd0b8d0b5-d0bdd0bed0b2d0b8d187d0bad0b0e5b091e695b0e6b4be><span>Представление новичка少数派</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20240509d0bfd0b5d180d181d0bed0bdd0b0d0bbd0b8d0b7d0b8d180d0bed0b2d0b0d0bdd0bdd18bd0b5-d180d0b5d0bad0bed0bcd0b5d0bdd0b4d0b0d186d0b8d0b8-d183d0b4d0bed0b1d0bdd18bd0b9-d0b8d0bdd181d182d180d183d0bcd0b5d0bdd182-d0b8d0bbd0b8-d0bbd0bed0b2d183d188d0bad0b0-d0b4d0bbd18f-d0bfd0bed0b7d0bdd0b0d0bdd0b8d18f-li><input type=checkbox id=m-ru-rublog20240509d0bfd0b5d180d181d0bed0bdd0b0d0bbd0b8d0b7d0b8d180d0bed0b2d0b0d0bdd0bdd18bd0b5-d180d0b5d0bad0bed0bcd0b5d0bdd0b4d0b0d186d0b8d0b8-d183d0b4d0bed0b1d0bdd18bd0b9-d0b8d0bdd181d182d180d183d0bcd0b5d0bdd182-d0b8d0bbd0b8-d0bbd0bed0b2d183d188d0bad0b0-d0b4d0bbd18f-d0bfd0bed0b7d0bdd0b0d0bdd0b8d18f-check>
<label for=m-ru-rublog20240509d0bfd0b5d180d181d0bed0bdd0b0d0bbd0b8d0b7d0b8d180d0bed0b2d0b0d0bdd0bdd18bd0b5-d180d0b5d0bad0bed0bcd0b5d0bdd0b4d0b0d186d0b8d0b8-d183d0b4d0bed0b1d0bdd18bd0b9-d0b8d0bdd181d182d180d183d0bcd0b5d0bdd182-d0b8d0bbd0b8-d0bbd0bed0b2d183d188d0bad0b0-d0b4d0bbd18f-d0bfd0bed0b7d0bdd0b0d0bdd0b8d18f-check><a href=/ru-ru/blog/2024/05/09/%D0%BF%D0%B5%D1%80%D1%81%D0%BE%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5-%D1%80%D0%B5%D0%BA%D0%BE%D0%BC%D0%B5%D0%BD%D0%B4%D0%B0%D1%86%D0%B8%D0%B8-%D1%83%D0%B4%D0%BE%D0%B1%D0%BD%D1%8B%D0%B9-%D0%B8%D0%BD%D1%81%D1%82%D1%80%D1%83%D0%BC%D0%B5%D0%BD%D1%82-%D0%B8%D0%BB%D0%B8-%D0%BB%D0%BE%D0%B2%D1%83%D1%88%D0%BA%D0%B0-%D0%B4%D0%BB%D1%8F-%D0%BF%D0%BE%D0%B7%D0%BD%D0%B0%D0%BD%D0%B8%D1%8F/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20240509d0bfd0b5d180d181d0bed0bdd0b0d0bbd0b8d0b7d0b8d180d0bed0b2d0b0d0bdd0bdd18bd0b5-d180d0b5d0bad0bed0bcd0b5d0bdd0b4d0b0d186d0b8d0b8-d183d0b4d0bed0b1d0bdd18bd0b9-d0b8d0bdd181d182d180d183d0bcd0b5d0bdd182-d0b8d0bbd0b8-d0bbd0bed0b2d183d188d0bad0b0-d0b4d0bbd18f-d0bfd0bed0b7d0bdd0b0d0bdd0b8d18f><span>Персонализированные рекомендации: удобный инструмент или ловушка для познания?</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog20240509d0bed0bfd18bd182-d181d0bed0b7d0b4d0b0d0bdd0b8d18f-d0bad0bed0bdd182d0b5d0bdd182d0b0-d0b2-d181d0bed0bed0b1d189d0b5d181d182d0b2d0b5-d180d0b0d0b7d180d0b0d0b1d0bed182d187d0b8d0bad0bed0b2-tencent-cloud-li><input type=checkbox id=m-ru-rublog20240509d0bed0bfd18bd182-d181d0bed0b7d0b4d0b0d0bdd0b8d18f-d0bad0bed0bdd182d0b5d0bdd182d0b0-d0b2-d181d0bed0bed0b1d189d0b5d181d182d0b2d0b5-d180d0b0d0b7d180d0b0d0b1d0bed182d187d0b8d0bad0bed0b2-tencent-cloud-check>
<label for=m-ru-rublog20240509d0bed0bfd18bd182-d181d0bed0b7d0b4d0b0d0bdd0b8d18f-d0bad0bed0bdd182d0b5d0bdd182d0b0-d0b2-d181d0bed0bed0b1d189d0b5d181d182d0b2d0b5-d180d0b0d0b7d180d0b0d0b1d0bed182d187d0b8d0bad0bed0b2-tencent-cloud-check><a href=/ru-ru/blog/2024/05/09/%D0%BE%D0%BF%D1%8B%D1%82-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D1%8F-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%BD%D1%82%D0%B0-%D0%B2-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D1%81%D1%82%D0%B2%D0%B5-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%BE%D0%B2-tencent-cloud/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog20240509d0bed0bfd18bd182-d181d0bed0b7d0b4d0b0d0bdd0b8d18f-d0bad0bed0bdd182d0b5d0bdd182d0b0-d0b2-d181d0bed0bed0b1d189d0b5d181d182d0b2d0b5-d180d0b0d0b7d180d0b0d0b1d0bed182d187d0b8d0bad0bed0b2-tencent-cloud><span>Опыт создания контента в сообществе разработчиков Tencent Cloud</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog10101-li><input type=checkbox id=m-ru-rublog10101-check>
<label for=m-ru-rublog10101-check><a href=/ru-ru/blog/1/01/01/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog10101><span></span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-ru-rublog10101-li><input type=checkbox id=m-ru-rublog10101-check>
<label for=m-ru-rublog10101-check><a href=/ru-ru/blog/1/01/01/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-ru-rublog10101><span></span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"></div><div class=td-toc data-proofer-ignore><div class=td-toc-title><span class=td-toc-title__text></span>
<a class=td-toc-title__link title href=#></a></div><nav id=TableOfContents><ul><li><a href=#введение>Введение</a></li><li><a href=#почему-теряется-информация-о-исходном-ip>Почему теряется информация о исходном IP?</a></li><li><a href=#как-сохранить-исходный-ip>Как сохранить исходный IP?</a></li><li><a href=#руководство-по-операциям-в-k8s>Руководство по операциям в K8S</a><ul><li><a href=#создание-deployment>Создание Deployment</a></li><li><a href=#создание-service>Создание Service</a></li><li><a href=#создание-ingress>Создание Ingress</a></li></ul></li><li><a href=#заключение>Заключение</a></li><li><a href=#ссылки>Ссылки</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Taxonomy Cloud</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/2025/ data-taxonomy-term=2025><span class=taxonomy-label>2025</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>Blog</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/udp-qos/ data-taxonomy-term=udp-qos><span class=taxonomy-label>UDP QoS</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/vpn/ data-taxonomy-term=vpn><span class=taxonomy-label>VPN</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/wireguard/ data-taxonomy-term=wireguard><span class=taxonomy-label>WireGuard</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/ data-taxonomy-term=%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5><span class=taxonomy-label>Администрирование</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D0%B7%D0%B0%D0%BC%D0%B5%D1%82%D0%BA%D0%B8/ data-taxonomy-term=%D0%B7%D0%B0%D0%BC%D0%B5%D1%82%D0%BA%D0%B8><span class=taxonomy-label>Заметки</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D0%BD%D0%B5-%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D1%86%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BE/ data-taxonomy-term=%D0%BD%D0%B5-%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D1%86%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BE><span class=taxonomy-label>Не Классифицировано</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D0%BE%D0%B1%D0%B7%D0%BE%D1%80/ data-taxonomy-term=%D0%BE%D0%B1%D0%B7%D0%BE%D1%80><span class=taxonomy-label>Обзор</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8/ data-taxonomy-term=%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8><span class=taxonomy-label>Операции</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D1%81%D0%B5%D1%82%D0%B8/ data-taxonomy-term=%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D1%81%D0%B5%D1%82%D0%B8><span class=taxonomy-label>Оптимизация Сети</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D0%BF%D0%BB%D0%B0%D1%82%D1%84%D0%BE%D1%80%D0%BC%D0%B0-%D0%B4%D0%BB%D1%8F-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%BE%D0%B2/ data-taxonomy-term=%D0%BF%D0%BB%D0%B0%D1%82%D1%84%D0%BE%D1%80%D0%BC%D0%B0-%D0%B4%D0%BB%D1%8F-%D0%B0%D0%B2%D1%82%D0%BE%D1%80%D0%BE%D0%B2><span class=taxonomy-label>Платформа Для Авторов</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D1%80%D0%B0%D0%B7%D0%BD%D0%BE%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BD%D1%8B%D0%B5-%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B/ data-taxonomy-term=%D1%80%D0%B0%D0%B7%D0%BD%D0%BE%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BD%D1%8B%D0%B5-%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D1%8B><span class=taxonomy-label>Разнообразные Проблемы</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D1%80%D1%83%D0%BA%D0%BE%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE/ data-taxonomy-term=%D1%80%D1%83%D0%BA%D0%BE%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE><span class=taxonomy-label>Руководство</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D1%81%D0%B5%D1%82%D0%B8/ data-taxonomy-term=%D1%81%D0%B5%D1%82%D0%B8><span class=taxonomy-label>Сети</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D1%81%D0%B5%D1%82%D1%8C/ data-taxonomy-term=%D1%81%D0%B5%D1%82%D1%8C><span class=taxonomy-label>Сеть</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F-%D0%B8%D0%B3%D1%80/ data-taxonomy-term=%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F-%D0%B8%D0%B3%D1%80><span class=taxonomy-label>Теория Игр</span><span class=taxonomy-count>1</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/ data-taxonomy-term=%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5><span class=taxonomy-label>Администрирование</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D0%B7%D0%B0%D0%BC%D0%B5%D1%82%D0%BA%D0%B8/ data-taxonomy-term=%D0%B7%D0%B0%D0%BC%D0%B5%D1%82%D0%BA%D0%B8><span class=taxonomy-label>Заметки</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D0%BD%D0%B5-%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D1%86%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BE/ data-taxonomy-term=%D0%BD%D0%B5-%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%84%D0%B8%D1%86%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BE><span class=taxonomy-label>Не Классифицировано</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D0%BE%D0%B1%D0%B7%D0%BE%D1%80/ data-taxonomy-term=%D0%BE%D0%B1%D0%B7%D0%BE%D1%80><span class=taxonomy-label>Обзор</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8/ data-taxonomy-term=%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8><span class=taxonomy-label>Операции</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D1%80%D1%83%D0%BA%D0%BE%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE/ data-taxonomy-term=%D1%80%D1%83%D0%BA%D0%BE%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE><span class=taxonomy-label>Руководство</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D1%8B%D0%B5-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8/ data-taxonomy-term=%D1%81%D0%B5%D1%82%D0%B5%D0%B2%D1%8B%D0%B5-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8><span class=taxonomy-label>Сетевые Технологии</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D1%81%D0%B5%D1%82%D0%B8/ data-taxonomy-term=%D1%81%D0%B5%D1%82%D0%B8><span class=taxonomy-label>Сети</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D1%81%D0%B5%D1%82%D1%8C/ data-taxonomy-term=%D1%81%D0%B5%D1%82%D1%8C><span class=taxonomy-label>Сеть</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F-%D0%B8%D0%B3%D1%80/ data-taxonomy-term=%D1%82%D0%B5%D0%BE%D1%80%D0%B8%D1%8F-%D0%B8%D0%B3%D1%80><span class=taxonomy-label>Теория Игр</span><span class=taxonomy-count>1</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><a class=td-rss-button title=RSS href=/ru-ru/blog/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/ru-ru/blog/>Blogs</a></li><li class="breadcrumb-item active" aria-current=page>Как сохранить исходный IP-адрес запроса после балансировки нагрузки в кластере K8s</li></ol></nav><div class=td-content><h1>Как сохранить исходный IP-адрес запроса после балансировки нагрузки в кластере K8s</h1><div class="td-byline mb-4"><time datetime=2024-05-27 class=text-body-secondary>Monday, May 27, 2024</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/%D1%81%D0%B5%D1%82%D0%B8/ data-taxonomy-term=%D1%81%D0%B5%D1%82%D0%B8><span class=taxonomy-label>Сети</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>Blog</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/ru-ru/categories/%D1%81%D0%B5%D1%82%D0%B8/ data-taxonomy-term=%D1%81%D0%B5%D1%82%D0%B8><span class=taxonomy-label>Сети</span></a></li></ul></div></header><h2 id=введение>Введение</h2><p><strong>Развертывание приложений</strong> не всегда сводится к простому <strong>установке</strong> и <strong>запуску</strong>, иногда также приходится учитывать проблемы <strong>сети</strong>. В этой статье описывается, как в <strong>кластере k8s</strong> сделать так, чтобы сервис мог получить <strong>исходный IP</strong> запроса.</p><p>Приложения, предоставляющие услуги, обычно зависят от входной информации. Если входная информация не зависит от <strong>пятерки</strong> (исходный IP, исходный порт, целевой IP, целевой порт, протокол), то такое приложение имеет <strong>низкую связанность с сетью</strong> и не нуждается в деталях сети.</p><p>Поэтому большинству людей нет необходимости читать эту статью. Если вы интересуетесь сетями или хотите расширить кругозор, можете продолжить чтение, чтобы узнать о дополнительных сценариях сервисов.</p><p>Статья основана на k8s <code>v1.29.4</code>. В тексте частично смешиваются термины pod и endpoint; в контексте статьи их можно считать эквивалентными.</p><p><strong>Если есть ошибки,欢迎 исправить, я timely исправлю.</strong></p><h2 id=почему-теряется-информация-о-исходном-ip>Почему теряется информация о исходном IP?</h2><p>Сначала уточним, что такое исходный IP. Когда A отправляет запрос B, а B пересылает запрос C, хотя C видит в протоколе IP исходный IP как IP B, в этой статье <strong>IP A</strong> считается исходным IP.</p><p>Есть два основных типа поведения, приводящих к потере исходной информации:</p><ol><li><strong>Преобразование сетевых адресов (NAT)</strong>, цель — экономия публичных IPv4, балансировка нагрузки и т.д. Это приводит к тому, что сервер видит исходный IP как IP устройства <strong>NAT</strong>, а не реальный исходный IP.</li><li><strong>Прокси (Proxy)</strong>, <strong>обратный прокси</strong> (RP, Reverse Proxy) и <strong>балансировщик нагрузки</strong> (LB, Load Balancer) относятся к этой категории, в дальнейшем统称为 <strong>прокси-серверы</strong>. Такие прокси-серверы пересылают запросы backend-сервисам, но заменяют исходный IP на свой собственный.</li></ol><ul><li>NAT простыми словами — это <strong>обмен пространством портов на пространство IP</strong>. Адреса IPv4 ограничены, один IP может отображать 65535 портов, и в большинстве случаев эти порты не исчерпываются, поэтому несколько подсетей IP могут использовать один публичный IP, отличаясь портами. Форма использования: <code>public IP:public port -> private IP_1:private port</code>. Подробнее читайте в <a href="https://www.google.com/search?q=%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2">Преобразование сетевых адресов</a></li><li>Прокси-сервисы используются для <strong>скрытия или экспонирования</strong>. Прокси-сервер пересылает запрос backend-сервису, заменяя исходный IP на свой, чтобы скрыть реальный IP backend-сервиса и защитить его безопасность. Форма использования: <code>client IP -> proxy IP -> server IP</code>. Подробнее читайте в <a href="https://www.google.com/search?q=%E4%BB%A3%E7%90%86">Прокси</a></li></ul><p><strong>NAT</strong> и <strong>прокси-серверы</strong> очень распространены, большинство сервисов не могут получить исходный IP запроса.</p><p><em>Это два распространенных способа изменения исходного IP. Дополнения欢迎.</em></p><h2 id=как-сохранить-исходный-ip>Как сохранить исходный IP?</h2><p>Вот пример <code>HTTP-запроса</code>:</p><table><thead><tr><th>Поле</th><th>Длина (байты)</th><th>Смещение бита</th><th>Описание</th></tr></thead><tbody><tr><td><strong>Заголовок IP</strong></td><td></td><td></td><td></td></tr><tr><td><code>Исходный IP</code></td><td>4</td><td>0-31</td><td>IP-адрес отправителя</td></tr><tr><td>Целевой IP</td><td>4</td><td>32-63</td><td>IP-адрес получателя</td></tr><tr><td><strong>Заголовок TCP</strong></td><td></td><td></td><td></td></tr><tr><td>Исходный порт</td><td>2</td><td>0-15</td><td>Номер отправного порта</td></tr><tr><td>Целевой порт</td><td>2</td><td>16-31</td><td>Номер целевого порта</td></tr><tr><td>Номер последовательности</td><td>4</td><td>32-63</td><td>Для идентификации потока байтов, отправленного отправителем</td></tr><tr><td>Номер подтверждения</td><td>4</td><td>64-95</td><td>Если установлен флаг ACK, то это следующий ожидаемый номер последовательности</td></tr><tr><td>Смещение данных</td><td>4</td><td>96-103</td><td>Количество байтов от начала данных относительно заголовка TCP</td></tr><tr><td>Зарезервировано</td><td>4</td><td>104-111</td><td>Зарезервированное поле, не используется, устанавливается в 0</td></tr><tr><td>Флаги</td><td>2</td><td>112-127</td><td>Различные контрольные флаги, такие как SYN, ACK, FIN и т.д.</td></tr><tr><td>Размер окна</td><td>2</td><td>128-143</td><td>Объем данных, который может принять получатель</td></tr><tr><td>Контрольная сумма</td><td>2</td><td>144-159</td><td>Для обнаружения ошибок в данных во время передачи</td></tr><tr><td>Указатель срочности</td><td>2</td><td>160-175</td><td>Позиция срочных данных, которые отправитель хочет, чтобы получатель обработал как можно скорее</td></tr><tr><td>Опции</td><td>Переменная</td><td>176-&mldr;</td><td>Может включать временные метки, максимальную длину сегмента и т.д.</td></tr><tr><td><strong>Заголовок HTTP</strong></td><td></td><td></td><td></td></tr><tr><td>Строка запроса</td><td>Переменная</td><td>&mldr;-&mldr;</td><td>Включает метод запроса, URI и версию HTTP</td></tr><tr><td><code>Поля заголовков</code></td><td>Переменная</td><td>&mldr;-&mldr;</td><td>Содержит различные поля заголовков, такие как Host, User-Agent и т.д.</td></tr><tr><td>Пустая строка</td><td>2</td><td>&mldr;-&mldr;</td><td>Для разделения заголовков и тела</td></tr><tr><td>Тело</td><td>Переменная</td><td>&mldr;-&mldr;</td><td>Необязательное тело запроса или ответа</td></tr></tbody></table><p>Просматривая структуру HTTP-запроса выше, видно, что <strong>опции TCP</strong>, <strong>строка запроса</strong>, <strong>поля заголовков</strong>, <strong>тело</strong> переменны. Пространство <strong>опций TCP</strong> ограничено и обычно не используется для передачи исходного IP. <strong>Строка запроса</strong> несет фиксированную информацию и не расширяется. <strong>Тело HTTP</strong> после шифрования нельзя изменять. Только <code>поля заголовков HTTP</code> подходят для расширения и передачи исходного IP.</p><p>В заголовке HTTP можно добавить поле <code>X-REAL-IP</code> для передачи исходного IP. Это обычно делается на прокси-сервере, после чего <strong>прокси-сервер</strong> отправляет запрос backend-сервису, и backend может получить исходный IP через это поле.</p><p>Обратите внимание: нужно гарантировать, что <strong>прокси-сервер</strong> находится <strong>до устройства NAT</strong>, чтобы получить реальный исходный IP запроса whoami. В продуктах Alibaba Cloud есть отдельная категория товара <a href=https://slb.console.aliyun.com/overview><strong>Load Balancer</strong></a>, позиция которого в сети отличается от обычных серверов приложений.</p><h2 id=руководство-по-операциям-в-k8s>Руководство по операциям в K8S</h2><p>В качестве примера развертывание проекта <a href=https://github.com/traefik/whoami>whoami</a>.</p><h3 id=создание-deployment>Создание Deployment</h3><p>Сначала создайте сервис:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/traefik/whoami:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></div><p>Это создаст <strong>Deployment</strong> с 3 <strong>Pod</strong>, каждый pod содержит один контейнер, запускающий сервис <strong>whoami</strong>.</p><h3 id=создание-service>Создание Service</h3><p>Можно создать сервис типа <strong>NodePort</strong> или <strong>LoadBalancer</strong> для внешнего доступа или <strong>ClusterIP</strong> для внутреннего доступа кластера, плюс <strong>Ingress</strong> для экспонирования внешнего доступа.</p><p><strong>NodePort</strong> доступен через <strong>NodeIP:NodePort</strong> или через сервис <strong>Ingress</strong>, удобно для тестирования. В этом разделе используется сервис <strong>NodePort</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>После создания сервиса доступ <code>curl whoami.example.com:30002</code> покажет IP как <strong>NodeIP</strong>, а не исходный IP запроса whoami.</p><blockquote><p>Обратите внимание, это не правильный IP клиента, это внутренние IP кластера. Вот что происходит:</p><ul><li>Клиент отправляет пакет на node2:nodePort</li><li>node2 заменяет исходный IP пакета на свой IP (SNAT)</li><li>node2 заменяет целевой IP пакета на Pod IP</li><li>Пакет маршрутизируется на node1, затем на endpoint</li><li>Ответ Pod маршрутизируется обратно на node2</li><li>Ответ Pod отправляется клиенту</li></ul></blockquote><p>Схематично:</p><p><img src=https://s2.loli.net/2024/05/27/fDg2tBx5FIcGMZN.png alt></p><h4 id=настройка-externaltrafficpolicy-local>Настройка externalTrafficPolicy: Local</h4><blockquote><p>Чтобы избежать этого, в Kubernetes есть функция сохранения исходного IP клиента. Если установить service.spec.externalTrafficPolicy в Local, kube-proxy будет проксировать запросы только на локальные endpoints, не пересылая трафик на другие узлы.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>Тестирование <code>curl whoami.example.com:30002</code>: когда <strong>whoami.example.com</strong> разрешается в IP нескольких узлов кластера, есть вероятность, что доступ не сработает. Нужно убедиться, что DNS-записи содержат только IP узлов с endpoints (pod).</p><p>Эта настройка <strong>имеет цену</strong>: теряется способность балансировки нагрузки в кластере. Клиент получит ответ только при доступе к узлу с endpoint.</p><p><img src=https://s2.loli.net/2024/05/27/PCgiTLF28XE4RKx.png alt="Ограничения пути доступа"></p><p>При доступе клиента к Node 2 ответа не будет.</p><h3 id=создание-ingress>Создание Ingress</h3><p>Большинство сервисов предоставляются пользователям через <strong>http/https</strong>, форма <strong>https://ip:port</strong> может показаться пользователям незнакомой. Обычно используется <strong>Ingress</strong> для балансировки сервиса <strong>NodePort</strong> из предыдущего раздела на порт <strong>80/443</strong> домена.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>external-lb-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>whoami.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>После применения тестирование <code>curl whoami.example.com</code> покажет ClientIP всегда как IP Pod <code>Ingress Controller</code> на узле с endpoint.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@client:~# curl whoami.example.com
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>RemoteAddr: 10.42.1.10:56482
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@worker:~# kubectl get -n ingress-nginx pod -o wide
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE          NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>ingress-nginx-controller-c8f499cfc-xdrg7   1/1     Running   <span class=m>0</span>          3d2h   10.42.1.10   k3s-agent-1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Использование <strong>Ingress</strong> как обратного прокси для сервиса <strong>NodePort</strong> означает две вложенные service перед endpoint. На рисунке ниже показаны различия.</p><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:80| B(Ingress)
    B --&gt;|10.43.38.129:32123| C[Service]
    C --&gt;|10.42.1.1:8080| D[Endpoint]</pre><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:30001| B(Service)
    B --&gt;|10.42.1.1:8080| C[Endpoint]</pre><p>В пути 1 внешний доступ к Ingress сначала достигает endpoint <code>Ingress Controller</code>, затем endpoint <strong>whoami</strong>.<br><strong>Ingress Controller</strong> по сути — сервис <strong>LoadBalancer</strong>,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl -n ingress-nginx get svc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAMESPACE   NAME             CLASS   HOSTS                       ADDRESS                                              PORTS   AGE
</span></span><span class=line><span class=cl>default     echoip-ingress   nginx   ip.example.com       172.16.0.57,2408:4005:3de:8500:4da1:169e:dc47:1707   <span class=m>80</span>      18h
</span></span><span class=line><span class=cl>default     whoami-ingress   nginx   whoami.example.com   172.16.0.57,2408:4005:3de:8500:4da1:169e:dc47:1707   <span class=m>80</span>      16h
</span></span></code></pre></div><p>Поэтому можно установить <code>externalTrafficPolicy</code>, упомянутый ранее, в Ingress Controller для сохранения исходного IP.</p><p>Также нужно установить в <code>configmap</code> <code>ingress-nginx-controller</code> параметр <code>use-forwarded-headers</code> в <code>true</code>, чтобы <strong>Ingress Controller</strong> распознавал поля <code>X-Forwarded-For</code> или <code>X-REAL-IP</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allow-snippet-annotations</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compute-full-forwarded-for</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>use-forwarded-headers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-real-ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forwarded-for-header</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;X-Real-IP&#34;</span><span class=w> </span><span class=c># X-Real-IP or X-Forwarded-For</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx-controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span></code></pre></div><p>Разница между сервисом <strong>NodePort</strong> и сервисом <strong>ingress-nginx-controller</strong> в основном в том, что backend <strong>NodePort</strong> обычно не развертывается на каждом узле, а backend <strong>ingress-nginx-controller</strong> обычно развертывается на каждом узле с внешним экспонированием.</p><p>В отличие от сервиса <strong>NodePort</strong>, где <code>externalTrafficPolicy</code> приводит к отсутствию ответа на запросы между узлами, <strong>Ingress</strong> сначала устанавливает HEADER, а затем проксирует, реализуя <strong>сохранение исходного IP</strong> и <strong>балансировку нагрузки</strong>.</p><h2 id=заключение>Заключение</h2><ul><li><strong>Преобразование адресов (NAT)</strong>, <strong>прокси (Proxy)</strong>, <strong>обратный прокси (Reverse Proxy)</strong>, <strong>балансировка нагрузки (Load Balance)</strong> приводят к потере исходного IP.</li><li>Чтобы предотвратить потерю исходного IP, при пересылке прокси-сервер может установить реальный IP в поле заголовка HTTP <code>X-REAL-IP</code>. При многоуровневом прокси используется поле <code>X-Forwarded-For</code>, которое в форме <strong>стека</strong> записывает <strong>список IP</strong> исходного IP и пути прокси.</li><li>Для сервиса <strong>NodePort</strong> кластера установка <code>externalTrafficPolicy: Local</code> сохраняет исходный IP, но теряет балансировку нагрузки.</li><li><strong>ingress-nginx-controller</strong>, развернутый в форме <strong>daemonset</strong> на всех узлах роли <strong>loadbalancer</strong>, с установкой <code>externalTrafficPolicy: Local</code> сохраняет исходный IP и балансировку нагрузки.</li></ul><h2 id=ссылки>Ссылки</h2><ul><li><a href=https://kubernetes.io/zh-cn/docs/tutorials/services/source-ip/>Kubernetes использование исходного IP</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/>Ingress-Nginx Controller:ConfigMap</a></li><li><a href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/>Ingress Controller</a></li></ul><br><script src=https://giscus.app/client.js data-repo=jqknono/blog data-repo-id=R_kgDONOhENQ data-category=Announcements data-category-id=DIC_kwDONOhENc4CkQDB data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script><br><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/ru-ru/blog/2024/05/21/%D0%BF%D0%BE%D0%BB%D0%BD%D0%BE%D0%B5-%D1%80%D0%B5%D1%88%D0%B5%D0%BD%D0%B8%D0%B5-wireguard-%D0%BF%D1%80%D0%BE%D1%82%D0%B8%D0%B2-udp-qos-%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BE%D0%B2/ aria-label="Предыдущий - Полное решение WireGuard против UDP QoS операторов" class="btn btn-primary"><span class=me-1>←</span>Предыдущий</a></li><li><a href=/ru-ru/blog/2024/05/27/%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B8-%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%B0%D1%86%D0%B8%D1%8F-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B-windows/ aria-label="Следующий - Установка и активация системы Windows" class="btn btn-primary">Следующий<span class=ms-1>→</span></a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/jqknono aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2015&ndash;2025
<span class=td-footer__authors>jqknono</span></span><span class=td-footer__all_rights_reserved>Все права защищены</span></div></div></div></footer></div><script type=module async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@latest\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {"theme":"default","version":"latest"};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>