<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=es-es class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Cómo conservar la IP de origen de las solicitudes después de la equilibración de carga en un clúster de K8s | jqknono Blogs</title><meta name=description content="Introducción El despliegue de aplicaciones no siempre es simplemente instalar y ejecutar, a veces también es necesario considerar problemas de red. Este artículo explicará cómo hacer que los servicios en un clúster de k8s puedan obtener la IP de origen de la solicitud.
Las aplicaciones que proporcionan servicios generalmente dependen de la información de entrada. Si la información de entrada no depende de la quíntuple (IP de origen, puerto de origen, IP de destino, puerto de destino, protocolo), entonces el servicio tiene una baja acoplamiento con la red y no necesita preocuparse por los detalles de la red."><meta property="og:url" content="https://blog.jqknono.com/es-es/blog/2024/05/27/c%C3%B3mo-conservar-la-ip-de-origen-de-las-solicitudes-despu%C3%A9s-de-la-equilibraci%C3%B3n-de-carga-en-un-cl%C3%BAster-de-k8s/"><meta property="og:site_name" content="jqknono Blogs"><meta property="og:title" content="Cómo conservar la IP de origen de las solicitudes después de la equilibración de carga en un clúster de K8s"><meta property="og:description" content="Introducción El despliegue de aplicaciones no siempre es simplemente instalar y ejecutar, a veces también es necesario considerar problemas de red. Este artículo explicará cómo hacer que los servicios en un clúster de k8s puedan obtener la IP de origen de la solicitud.
Las aplicaciones que proporcionan servicios generalmente dependen de la información de entrada. Si la información de entrada no depende de la quíntuple (IP de origen, puerto de origen, IP de destino, puerto de destino, protocolo), entonces el servicio tiene una baja acoplamiento con la red y no necesita preocuparse por los detalles de la red."><meta property="og:locale" content="es_es"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-05-27T11:52:22+08:00"><meta property="article:modified_time" content="2024-05-27T11:52:22+08:00"><meta property="article:tag" content="Red"><meta property="article:tag" content="Blog"><meta itemprop=name content="Cómo conservar la IP de origen de las solicitudes después de la equilibración de carga en un clúster de K8s"><meta itemprop=description content="Introducción El despliegue de aplicaciones no siempre es simplemente instalar y ejecutar, a veces también es necesario considerar problemas de red. Este artículo explicará cómo hacer que los servicios en un clúster de k8s puedan obtener la IP de origen de la solicitud.
Las aplicaciones que proporcionan servicios generalmente dependen de la información de entrada. Si la información de entrada no depende de la quíntuple (IP de origen, puerto de origen, IP de destino, puerto de destino, protocolo), entonces el servicio tiene una baja acoplamiento con la red y no necesita preocuparse por los detalles de la red."><meta itemprop=datePublished content="2024-05-27T11:52:22+08:00"><meta itemprop=dateModified content="2024-05-27T11:52:22+08:00"><meta itemprop=wordCount content="1931"><meta itemprop=keywords content="Red,Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cómo conservar la IP de origen de las solicitudes después de la equilibración de carga en un clúster de K8s"><meta name=twitter:description content="Introducción El despliegue de aplicaciones no siempre es simplemente instalar y ejecutar, a veces también es necesario considerar problemas de red. Este artículo explicará cómo hacer que los servicios en un clúster de k8s puedan obtener la IP de origen de la solicitud.
Las aplicaciones que proporcionan servicios generalmente dependen de la información de entrada. Si la información de entrada no depende de la quíntuple (IP de origen, puerto de origen, IP de destino, puerto de destino, protocolo), entonces el servicio tiene una baja acoplamiento con la red y no necesita preocuparse por los detalles de la red."><link rel=preload href=/scss/main.min.60df7671ee6b2972895a8681f1472cd10b162590a6365c232c909547e1d5e027.css as=style integrity="sha256-YN92ce5rKXKJWoaB8Ucs0QsWJZCmNlwjLJCVR+HV4Cc=" crossorigin=anonymous><link href=/scss/main.min.60df7671ee6b2972895a8681f1472cd10b162590a6365c232c909547e1d5e027.css rel=stylesheet integrity="sha256-YN92ce5rKXKJWoaB8Ucs0QsWJZCmNlwjLJCVR+HV4Cc=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3FFTG72NE"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3FFTG72NE")}</script></head><body class="td-page td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/es-es/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>jqknono Blogs</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://jqknono.com target=_blank rel=noopener><span>About</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class=nav-item><a class=nav-link href=https://github.com/jqknono target=_blank rel=noopener><i class="fab fa-github" aria-hidden=true></i><span>GitHub</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class="nav-item td-navbar__lang-menu"><div class="td-lang-menu dropdown"><a class="nav-link dropdown-toggle td-lang-menu__title" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class=td-lang-menu__title-text>Español</span>
<span class=td-lang-menu__title-code>ES-ES</span></a><ul class=dropdown-menu><li><a class=dropdown-item href=/blog/2024/05/27/how-to-preserve-the-source-ip-of-requests-after-load-balancing-in-a-k8s-cluster/>English</a></li><li><a class=dropdown-item href=/zh-tw/blog/2024/05/27/k8s%E5%8F%A2%E9%9B%86%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BF%9D%E7%95%99%E8%B2%A0%E8%BC%89%E5%9D%87%E8%A1%A1%E5%BE%8C%E7%9A%84%E8%AB%8B%E6%B1%82%E6%BA%90ip/>繁體中文</a></li><li><a class=dropdown-item href=/ja-jp/blog/1/01/01/>日本語</a></li><li><a class=dropdown-item href=/ko-kr/blog/2024/05/27/k8s-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%EC%97%90%EC%84%9C-%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%8B%B1-%ED%9B%84-%EC%9A%94%EC%B2%AD-%EC%9B%90%EB%B3%B8-ip%EB%A5%BC-%EB%B3%B4%EC%A1%B4%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95/>한국어</a></li><li><a class=dropdown-item href=/ar-sa/blog/1/01/01/>العربية</a></li><li><a class=dropdown-item href=/de-de/blog/2024/05/27/wie-beh%C3%A4lt-man-in-einem-k8s-cluster-die-quell-ip-der-anfragen-nach-der-lastverteilung-bei/>Deutsch</a></li><li><a class=dropdown-item href=/fr-fr/blog/2024/05/27/comment-conserver-lip-source-des-requ%C3%AAtes-apr%C3%A8s-%C3%A9quilibrage-de-charge-dans-un-cluster-k8s/>Français</a></li><li><a class=dropdown-item href=/hi-in/blog/2024/05/27/k8s-%E0%A4%95%E0%A5%8D%E0%A4%B2%E0%A4%B8%E0%A5%8D%E0%A4%9F%E0%A4%B0-%E0%A4%AE%E0%A5%87%E0%A4%82-%E0%A4%B2%E0%A5%8B%E0%A4%A1-%E0%A4%AC%E0%A5%88%E0%A4%B2%E0%A5%87%E0%A4%82%E0%A4%B8%E0%A4%B0-%E0%A4%95%E0%A5%87-%E0%A4%AC%E0%A4%BE%E0%A4%A6-%E0%A4%95%E0%A5%87-%E0%A4%85%E0%A4%A8%E0%A5%81%E0%A4%B0%E0%A5%8B%E0%A4%A7-%E0%A4%B8%E0%A5%8D%E0%A4%B0%E0%A5%8B%E0%A4%A4-ip-%E0%A4%95%E0%A5%8B-%E0%A4%95%E0%A5%88%E0%A4%B8%E0%A5%87-%E0%A4%AC%E0%A4%A8%E0%A4%BE%E0%A4%8F-%E0%A4%B0%E0%A4%96%E0%A5%87%E0%A4%82/>हिंदी</a></li><li><span class="dropdown-item active">Español</span></li><li><a class=dropdown-item href=/pt-br/blog/2024/05/27/como-preservar-o-ip-de-origem-da-solicita%C3%A7%C3%A3o-ap%C3%B3s-o-balanceamento-de-carga-em-um-cluster-k8s/>Português</a></li><li><a class=dropdown-item href=/ru-ru/blog/2024/05/27/%D0%BA%D0%B0%D0%BA-%D1%81%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B8%D1%82%D1%8C-%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D1%8B%D0%B9-ip-%D0%B0%D0%B4%D1%80%D0%B5%D1%81-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0-%D0%BF%D0%BE%D1%81%D0%BB%D0%B5-%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8-%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8-%D0%B2-%D0%BA%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B5-k8s/>Русский</a></li><li><a class=dropdown-item href=/it-it/blog/2024/05/27/come-preservare-lip-sorgente-delle-richieste-dopo-il-bilanciamento-del-carico-in-un-cluster-k8s/>Italiano</a></li><li><span class="dropdown-item disabled">Bahasa Indonesia</span></li><li><a class=dropdown-item href=/tr-tr/blog/2024/05/27/k8s-k%C3%BCmesinde-y%C3%BCk-dengeleme-sonras%C4%B1-istek-kaynak-ipsini-nas%C4%B1l-koruyabiliriz/>Türkçe</a></li><li><a class=dropdown-item href=/nl-nl/blog/2024/05/27/hoe-behoud-je-het-bron-ip-van-verzoeken-na-load-balancing-in-een-k8s-cluster/>Nederlands</a></li><li><a class=dropdown-item href=/pl-pl/blog/2024/05/27/jak-zachowa%C4%87-oryginalny-ip-%C5%BAr%C3%B3d%C5%82a-%C5%BC%C4%85dania-po-r%C3%B3wnowa%C5%BCeniu-obci%C4%85%C5%BCenia-w-klastrze-k8s/>Polski</a></li><li><a class=dropdown-item href=/ar-ae/blog/1/01/01/>العربية</a></li><li><a class=dropdown-item href=/zh-cn/blog/2024/05/27/k8s%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BF%9D%E7%95%99%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%90%8E%E7%9A%84%E8%AF%B7%E6%B1%82%E6%BA%90ip/>简体中文</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Buscar en este sitio…" aria-label="Buscar en este sitio…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.600675b7c98def8c056bf61c0c50f4f5.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main data-bs-spy=scroll data-bs-target=.td-toc data-bs-root-margin="0px 0px -10%"><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Buscar en este sitio…" aria-label="Buscar en este sitio…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.600675b7c98def8c056bf61c0c50f4f5.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="td-sidebar-nav collapse td-sidebar-nav--search-disabled foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-es-esblog-li><a href=/es-es/blog/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-es-esblog><span>Blogs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-es-esblog20230506problema-de-ipv6-al-hacer-bridge-en-windows-li><input type=checkbox id=m-es-esblog20230506problema-de-ipv6-al-hacer-bridge-en-windows-check>
<label for=m-es-esblog20230506problema-de-ipv6-al-hacer-bridge-en-windows-check><a href=/es-es/blog/2023/05/06/problema-de-ipv6-al-hacer-bridge-en-windows/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-es-esblog20230506problema-de-ipv6-al-hacer-bridge-en-windows><span>Problema de IPv6 al hacer bridge en Windows</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-es-esblog20240527instalacic3b3n-y-activacic3b3n-del-sistema-windows-li><input type=checkbox id=m-es-esblog20240527instalacic3b3n-y-activacic3b3n-del-sistema-windows-check>
<label for=m-es-esblog20240527instalacic3b3n-y-activacic3b3n-del-sistema-windows-check><a href=/es-es/blog/2024/05/27/instalaci%C3%B3n-y-activaci%C3%B3n-del-sistema-windows/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-es-esblog20240527instalacic3b3n-y-activacic3b3n-del-sistema-windows><span>Instalación y activación del sistema Windows</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-es-esblog20240527cc3b3mo-conservar-la-ip-de-origen-de-las-solicitudes-despuc3a9s-de-la-equilibracic3b3n-de-carga-en-un-clc3baster-de-k8s-li><input type=checkbox id=m-es-esblog20240527cc3b3mo-conservar-la-ip-de-origen-de-las-solicitudes-despuc3a9s-de-la-equilibracic3b3n-de-carga-en-un-clc3baster-de-k8s-check checked>
<label for=m-es-esblog20240527cc3b3mo-conservar-la-ip-de-origen-de-las-solicitudes-despuc3a9s-de-la-equilibracic3b3n-de-carga-en-un-clc3baster-de-k8s-check><a href=/es-es/blog/2024/05/27/c%C3%B3mo-conservar-la-ip-de-origen-de-las-solicitudes-despu%C3%A9s-de-la-equilibraci%C3%B3n-de-carga-en-un-cl%C3%BAster-de-k8s/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-es-esblog20240527cc3b3mo-conservar-la-ip-de-origen-de-las-solicitudes-despuc3a9s-de-la-equilibracic3b3n-de-carga-en-un-clc3baster-de-k8s><span class=td-sidebar-nav-active-item>Cómo conservar la IP de origen de las solicitudes después de la equilibración de carga en un clúster de K8s</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-es-esblog20240520nuevo-usuario-se-presenta-en-minorc3ada-li><input type=checkbox id=m-es-esblog20240520nuevo-usuario-se-presenta-en-minorc3ada-check>
<label for=m-es-esblog20240520nuevo-usuario-se-presenta-en-minorc3ada-check><a href=/es-es/blog/2024/05/20/nuevo-usuario-se-presenta-en-minor%C3%ADa/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-es-esblog20240520nuevo-usuario-se-presenta-en-minorc3ada><span>Nuevo usuario se presenta en Minoría</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-es-esblog20240509recomendacic3b3n-personalizada-herramienta-de-conveniencia-o-trampa-cognitiva-li><input type=checkbox id=m-es-esblog20240509recomendacic3b3n-personalizada-herramienta-de-conveniencia-o-trampa-cognitiva-check>
<label for=m-es-esblog20240509recomendacic3b3n-personalizada-herramienta-de-conveniencia-o-trampa-cognitiva-check><a href=/es-es/blog/2024/05/09/recomendaci%C3%B3n-personalizada-herramienta-de-conveniencia-o-trampa-cognitiva/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-es-esblog20240509recomendacic3b3n-personalizada-herramienta-de-conveniencia-o-trampa-cognitiva><span>¿Recomendación personalizada: herramienta de conveniencia o trampa cognitiva?</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-es-esblog20240509experiencia-de-creacic3b3n-en-la-comunidad-de-desarrolladores-de-tencent-cloud-li><input type=checkbox id=m-es-esblog20240509experiencia-de-creacic3b3n-en-la-comunidad-de-desarrolladores-de-tencent-cloud-check>
<label for=m-es-esblog20240509experiencia-de-creacic3b3n-en-la-comunidad-de-desarrolladores-de-tencent-cloud-check><a href=/es-es/blog/2024/05/09/experiencia-de-creaci%C3%B3n-en-la-comunidad-de-desarrolladores-de-tencent-cloud/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-es-esblog20240509experiencia-de-creacic3b3n-en-la-comunidad-de-desarrolladores-de-tencent-cloud><span>Experiencia de creación en la comunidad de desarrolladores de Tencent Cloud</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"></div><div class=td-toc data-proofer-ignore><div class=td-toc-title><span class=td-toc-title__text></span>
<a class=td-toc-title__link title href=#></a></div><nav id=TableOfContents><ul><li><a href=#introducción>Introducción</a></li><li><a href=#por-qué-se-pierde-la-información-de-la-ip-de-origen>¿Por qué se pierde la información de la IP de origen?</a></li><li><a href=#cómo-conservar-la-ip-de-origen>¿Cómo conservar la IP de origen?</a></li><li><a href=#guía-de-operaciones-de-k8s>Guía de operaciones de K8S</a><ul><li><a href=#crear-deployment>Crear Deployment</a></li><li><a href=#crear-service>Crear Service</a></li><li><a href=#crear-ingress>Crear Ingress</a></li></ul></li><li><a href=#resumen>Resumen</a></li><li><a href=#referencias>Referencias</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Taxonomy Cloud</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>Blog</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/plataforma-de-creadores/ data-taxonomy-term=plataforma-de-creadores><span class=taxonomy-label>Plataforma De Creadores</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/problemas-varios/ data-taxonomy-term=problemas-varios><span class=taxonomy-label>Problemas Varios</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/red/ data-taxonomy-term=red><span class=taxonomy-label>Red</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/rese%C3%B1as/ data-taxonomy-term=rese%C3%B1as><span class=taxonomy-label>Reseñas</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/sin-clasificar/ data-taxonomy-term=sin-clasificar><span class=taxonomy-label>Sin Clasificar</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/teor%C3%ADa-de-juegos/ data-taxonomy-term=teor%C3%ADa-de-juegos><span class=taxonomy-label>Teoría De Juegos</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/tutoriales/ data-taxonomy-term=tutoriales><span class=taxonomy-label>Tutoriales</span><span class=taxonomy-count>1</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/categories/red/ data-taxonomy-term=red><span class=taxonomy-label>Red</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/categories/rese%C3%B1as/ data-taxonomy-term=rese%C3%B1as><span class=taxonomy-label>Reseñas</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/categories/sin-clasificar/ data-taxonomy-term=sin-clasificar><span class=taxonomy-label>Sin Clasificar</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/categories/teor%C3%ADa-de-juegos/ data-taxonomy-term=teor%C3%ADa-de-juegos><span class=taxonomy-label>Teoría De Juegos</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/categories/tutoriales/ data-taxonomy-term=tutoriales><span class=taxonomy-label>Tutoriales</span><span class=taxonomy-count>1</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><a class=td-rss-button title=RSS href=/es-es/blog/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/es-es/blog/>Blogs</a></li><li class="breadcrumb-item active" aria-current=page>Cómo conservar la IP de origen de las solicitudes después de la equilibración de carga en un clúster de K8s</li></ol></nav><div class=td-content><h1>Cómo conservar la IP de origen de las solicitudes después de la equilibración de carga en un clúster de K8s</h1><div class="td-byline mb-4"><time datetime=2024-05-27 class=text-body-secondary>Monday, May 27, 2024</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/red/ data-taxonomy-term=red><span class=taxonomy-label>Red</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>Blog</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/es-es/categories/red/ data-taxonomy-term=red><span class=taxonomy-label>Red</span></a></li></ul></div></header><h2 id=introducción>Introducción</h2><p>El <strong>despliegue de aplicaciones</strong> no siempre es simplemente <strong>instalar</strong> y <strong>ejecutar</strong>, a veces también es necesario considerar problemas de <strong>red</strong>. Este artículo explicará cómo hacer que los servicios en un <strong>clúster de k8s</strong> puedan obtener la <strong>IP de origen</strong> de la solicitud.</p><p>Las aplicaciones que proporcionan servicios generalmente dependen de la información de entrada. Si la información de entrada no depende de la <strong>quíntuple</strong> (IP de origen, puerto de origen, IP de destino, puerto de destino, protocolo), entonces el servicio tiene una <strong>baja acoplamiento con la red</strong> y no necesita preocuparse por los detalles de la red.</p><p>Por lo tanto, la mayoría de las personas no necesitan leer este artículo. Si estás interesado en la red o deseas ampliar tu visión, puedes continuar leyendo para conocer más escenarios de servicios.</p><p>Este artículo se basa en k8s <code>v1.29.4</code>. Algunas descripciones en el artículo mezclan pod y endpoint, pero en el escenario de este artículo se pueden considerar equivalentes.</p><p><strong>Si hay errores, bienvenidas las correcciones, las actualizaré oportunamente.</strong></p><h2 id=por-qué-se-pierde-la-información-de-la-ip-de-origen>¿Por qué se pierde la información de la IP de origen?</h2><p>Primero aclaramos qué es la IP de origen. Cuando A envía una solicitud a B, y B la reenvía a C, aunque C ve la IP de origen del protocolo IP como la IP de B, en este artículo consideramos la <strong>IP de A</strong> como la IP de origen.</p><p>Hay principalmente dos tipos de comportamientos que causan la pérdida de la información de origen:</p><ol><li><strong>Traducción de direcciones de red (NAT)</strong>, cuyo propósito es ahorrar IPv4 públicas, equilibración de carga, etc. Esto hace que el servidor vea la IP del dispositivo <strong>NAT</strong> como la IP de origen, en lugar de la IP de origen real.</li><li><strong>Proxy</strong>, <strong>proxy inverso</strong> (RP, Reverse Proxy) y <strong>equilibrador de carga</strong> (LB, Load Balancer) pertenecen a esta categoría, denominados colectivamente <strong>servidores proxy</strong> a continuación. Estos servicios proxy reenvían las solicitudes al servicio backend, pero reemplazan la IP de origen con su propia IP.</li></ol><ul><li>NAT, en términos simples, es <strong>intercambiar espacio de puertos por espacio de IP</strong>. Las direcciones IPv4 son limitadas; una dirección IP puede mapear 65535 puertos. En la mayoría de los casos, estos puertos no se agotan, por lo que varias subredes IP pueden compartir una IP pública, distinguiendo servicios por puertos. Su forma de uso es: <code>IP pública:puerto público -> IP privada_1:puerto privado</code>. Para más información, consulta <a href="https://www.google.com/search?q=%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2">Traducción de direcciones de red</a>.</li><li>Los servicios proxy son para <strong>ocultar o exponer</strong>. Los servicios proxy reenvían las solicitudes al servicio backend y reemplazan la IP de origen con su propia IP, ocultando así la IP real del servicio backend y protegiendo su seguridad. La forma de uso del servicio proxy es: <code>IP del cliente -> IP del proxy -> IP del servidor</code>. Para más información, consulta <a href="https://www.google.com/search?q=%E4%BB%A3%E7%90%86">Proxy</a>.</li></ul><p><strong>NAT</strong> y <strong>servidores proxy</strong> son muy comunes, y la mayoría de los servicios no pueden obtener la IP de origen de la solicitud.</p><p><em>Estas son las dos vías comunes para modificar la IP de origen. Si hay otras, bienvenidas las sugerencias.</em></p><h2 id=cómo-conservar-la-ip-de-origen>¿Cómo conservar la IP de origen?</h2><p>A continuación, un ejemplo de una solicitud <code>HTTP</code>:</p><table><thead><tr><th>Campo</th><th>Longitud (bytes)</th><th>Desplazamiento de bits</th><th>Descripción</th></tr></thead><tbody><tr><td><strong>Cabecera IP</strong></td><td></td><td></td><td></td></tr><tr><td><code>IP de origen</code></td><td>4</td><td>0-31</td><td>Dirección IP del remitente</td></tr><tr><td>IP de destino</td><td>4</td><td>32-63</td><td>Dirección IP del receptor</td></tr><tr><td><strong>Cabecera TCP</strong></td><td></td><td></td><td></td></tr><tr><td>Puerto de origen</td><td>2</td><td>0-15</td><td>Número de puerto del remitente</td></tr><tr><td>Puerto de destino</td><td>2</td><td>16-31</td><td>Número de puerto del receptor</td></tr><tr><td>Número de secuencia</td><td>4</td><td>32-63</td><td>Para identificar el flujo de bytes enviado por el remitente</td></tr><tr><td>Número de confirmación</td><td>4</td><td>64-95</td><td>Si se establece la bandera ACK, es el siguiente número de secuencia esperado</td></tr><tr><td>Desplazamiento de datos</td><td>4</td><td>96-103</td><td>Número de bytes desde la posición inicial de los datos hasta la cabecera TCP</td></tr><tr><td>Reservado</td><td>4</td><td>104-111</td><td>Campo reservado, no utilizado, establecido en 0</td></tr><tr><td>Bits de bandera</td><td>2</td><td>112-127</td><td>Varios bits de control, como SYN, ACK, FIN, etc.</td></tr><tr><td>Tamaño de ventana</td><td>2</td><td>128-143</td><td>Cantidad de datos que el receptor puede recibir</td></tr><tr><td>Suma de verificación</td><td>2</td><td>144-159</td><td>Para detectar si los datos han cambiado durante la transmisión</td></tr><tr><td>Puntero urgente</td><td>2</td><td>160-175</td><td>Posición de los datos urgentes que el remitente espera que el receptor procese lo antes posible</td></tr><tr><td>Opciones</td><td>Variable</td><td>176-&mldr;</td><td>Puede incluir marca de tiempo, longitud máxima del segmento de mensaje, etc.</td></tr><tr><td><strong>Cabecera HTTP</strong></td><td></td><td></td><td></td></tr><tr><td>Línea de solicitud</td><td>Variable</td><td>&mldr;-&mldr;</td><td>Incluye método de solicitud, URI y versión HTTP</td></tr><tr><td><code>Campos de cabecera</code></td><td>Variable</td><td>&mldr;-&mldr;</td><td>Contiene varios campos de cabecera, como Host, User-Agent, etc.</td></tr><tr><td>Línea en blanco</td><td>2</td><td>&mldr;-&mldr;</td><td>Para separar la cabecera y el cuerpo</td></tr><tr><td>Cuerpo</td><td>Variable</td><td>&mldr;-&mldr;</td><td>Cuerpo opcional de la solicitud o respuesta</td></tr></tbody></table><p>Al examinar la estructura de la solicitud HTTP anterior, se puede ver que las <strong>opciones TCP</strong>, <strong>línea de solicitud</strong>, <strong>campos de cabecera</strong> y <strong>cuerpo</strong> son variables. El espacio de <strong>opciones TCP</strong> es limitado y generalmente no se usa para pasar la IP de origen. La <strong>línea de solicitud</strong> tiene información fija que no se puede expandir. El <strong>cuerpo HTTP</strong> no se puede modificar después del cifrado. Solo los <code>campos de cabecera HTTP</code> son adecuados para expandir y pasar la IP de origen.</p><p>Se puede agregar el campo <code>X-REAL-IP</code> en la cabecera HTTP para pasar la IP de origen. Esta operación generalmente se realiza en el servidor proxy, y luego el <strong>servidor proxy</strong> envía la solicitud al servicio backend, que puede obtener la información de la IP de origen a través de este campo.</p><p>Nota: Es necesario garantizar que el <strong>servidor proxy</strong> esté antes del dispositivo <strong>NAT</strong>, para poder obtener la IP de origen real de la solicitud whoami. En los productos de Alibaba Cloud, podemos ver el producto independiente de <a href=https://slb.console.aliyun.com/overview><strong>equilibrador de carga</strong></a>, cuya posición en la red es diferente a la de un servidor de aplicación común.</p><h2 id=guía-de-operaciones-de-k8s>Guía de operaciones de K8S</h2><p>Usando el proyecto <a href=https://github.com/traefik/whoami>whoami</a> como ejemplo para el despliegue.</p><h3 id=crear-deployment>Crear Deployment</h3><p>Primero crea el servicio:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/traefik/whoami:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></div><p>Este paso creará un <strong>Deployment</strong> que contiene 3 <strong>Pods</strong>, cada pod contiene un contenedor que ejecuta el servicio <strong>whoami</strong>.</p><h3 id=crear-service>Crear Service</h3><p>Puedes crear un servicio de tipo <strong>NodePort</strong> o <strong>LoadBalancer</strong> para acceso externo, o crear un servicio de tipo <strong>ClusterIP</strong> solo para acceso interno del clúster, y luego agregar un servicio <strong>Ingress</strong> para exponer el acceso externo.</p><p><strong>NodePort</strong> se puede acceder tanto a través de <strong>NodeIP:NodePort</strong> como a través del servicio <strong>Ingress</strong>, lo que facilita las pruebas. Esta sección usa el servicio <strong>NodePort</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>Después de crear el servicio, accede con <code>curl whoami.example.com:30002</code> y verás que la IP devuelta es la <strong>NodeIP</strong>, no la IP de origen de la solicitud whoami.</p><blockquote><p>Por favor, ten en cuenta que esta no es la IP del cliente correcta; son IPs internas del clúster. Esto es lo que sucede:</p><ul><li>El cliente envía el paquete de datos a node2:nodePort</li><li>node2 reemplaza la IP de origen del paquete con su propia dirección IP (SNAT)</li><li>node2 reemplaza la IP de destino del paquete con la IP del Pod</li><li>El paquete se enruta a node1 y luego al endpoint</li><li>La respuesta del Pod se enruta de vuelta a node2</li><li>La respuesta del Pod se envía de vuelta al cliente</li></ul></blockquote><p>Representado en diagrama:</p><p><img src=https://s2.loli.net/2024/05/27/fDg2tBx5FIcGMZN.png alt></p><h4 id=configurar-externaltrafficpolicy-local>Configurar externalTrafficPolicy: Local</h4><blockquote><p>Para evitar esta situación, Kubernetes tiene una característica que conserva la IP de origen del cliente. Si configuras service.spec.externalTrafficPolicy como Local, kube-proxy solo proxyará las solicitudes a endpoints locales, sin reenviar el tráfico a otros nodos.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>Prueba con <code>curl whoami.example.com:30002</code>. Cuando <strong>whoami.example.com</strong> se resuelve a las IPs de múltiples nodos del clúster, hay una cierta probabilidad de que no sea accesible. Necesitas confirmar que el registro DNS solo contenga la IP del nodo donde se encuentra el endpoint (pod).</p><p>Esta configuración <strong>tiene su costo</strong>: pierde la capacidad de equilibración de carga dentro del clúster. El cliente solo obtendrá respuesta si accede al nodo donde se despliegan los endpoints.</p><p><img src=https://s2.loli.net/2024/05/27/PCgiTLF28XE4RKx.png alt="Restricción de ruta de acceso"></p><p>Cuando el cliente accede al Nodo 2, no habrá respuesta.</p><h3 id=crear-ingress>Crear Ingress</h3><p>La mayoría de los servicios se proporcionan a los usuarios mediante <strong>http/https</strong>. La forma <strong>https://ip:port</strong> puede resultar extraña para los usuarios. Generalmente, se usa <strong>Ingress</strong> para equilibrar la carga del servicio <strong>NodePort</strong> creado anteriormente a los puertos <strong>80/443</strong> de un dominio.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>external-lb-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>whoami.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>Después de aplicarlo, prueba accediendo con <code>curl whoami.example.com</code>. Verás que ClientIP siempre es la IP del Pod del <code>Ingress Controller</code> en el nodo donde se encuentra el endpoint.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@client:~# curl whoami.example.com
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>RemoteAddr: 10.42.1.10:56482
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@worker:~# kubectl get -n ingress-nginx pod -o wide
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE          NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>ingress-nginx-controller-c8f499cfc-xdrg7   1/1     Running   <span class=m>0</span>          3d2h   10.42.1.10   k3s-agent-1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>Usar <strong>Ingress</strong> como proxy inverso para el servicio <strong>NodePort</strong> significa agregar dos capas de servicio antes del endpoint. El diagrama siguiente muestra la diferencia entre ambos.</p><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:80| B(Ingress)
    B --&gt;|10.43.38.129:32123| C[Service]
    C --&gt;|10.42.1.1:8080| D[Endpoint]</pre><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:30001| B(Service)
    B --&gt;|10.42.1.1:8080| C[Endpoint]</pre><p>En la ruta 1, cuando se accede externamente a Ingress, el primer endpoint que llega el tráfico es el <code>Ingress Controller</code>, y luego llega al endpoint <strong>whoami</strong>.<br>El <strong>Ingress Controller</strong> es en esencia un servicio <strong>LoadBalancer</strong>,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl -n ingress-nginx get svc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAMESPACE   NAME             CLASS   HOSTS                       ADDRESS                                              PORTS   AGE
</span></span><span class=line><span class=cl>default     echoip-ingress   nginx   ip.example.com       172.16.0.57,2408:4005:3de:8500:4da1:169e:dc47:1707   <span class=m>80</span>      18h
</span></span><span class=line><span class=cl>default     whoami-ingress   nginx   whoami.example.com   172.16.0.57,2408:4005:3de:8500:4da1:169e:dc47:1707   <span class=m>80</span>      16h
</span></span></code></pre></div><p>Por lo tanto, se puede conservar la IP de origen configurando <code>externalTrafficPolicy</code> en el Ingress Controller como se mencionó anteriormente.</p><p>Además, es necesario configurar <code>use-forwarded-headers</code> como <code>true</code> en el <code>configmap</code> de <code>ingress-nginx-controller</code>, para que el <strong>Ingress Controller</strong> pueda reconocer los campos <code>X-Forwarded-For</code> o <code>X-REAL-IP</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allow-snippet-annotations</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compute-full-forwarded-for</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>use-forwarded-headers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-real-ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forwarded-for-header</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;X-Real-IP&#34;</span><span class=w> </span><span class=c># X-Real-IP or X-Forwarded-For</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx-controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span></code></pre></div><p>La diferencia principal entre el servicio <strong>NodePort</strong> y el servicio <strong>ingress-nginx-controller</strong> radica en que el backend de <strong>NodePort</strong> generalmente no se despliega en cada nodo, mientras que el backend de <strong>ingress-nginx-controller</strong> generalmente se despliega en cada nodo expuesto externamente.</p><p>A diferencia de configurar <code>externalTrafficPolicy</code> en el servicio <strong>NodePort</strong>, lo que causa que las solicitudes entre nodos no respondan, <strong>Ingress</strong> puede configurar primero el HEADER y luego proxyar y reenviar la solicitud, logrando así las capacidades de <strong>conservar la IP de origen</strong> y <strong>equilibración de carga</strong>.</p><h2 id=resumen>Resumen</h2><ul><li>La <strong>traducción de direcciones (NAT)</strong>, <strong>proxy</strong>, <strong>proxy inverso (Reverse Proxy)</strong> y <strong>equilibración de carga (Load Balance)</strong> causan la pérdida de la IP de origen.</li><li>Para evitar la pérdida de la IP de origen, el servidor proxy puede establecer la IP real en el campo de cabecera HTTP <code>X-REAL-IP</code> durante el reenvío, transmitiéndola a través del servicio proxy. Si se usan múltiples capas de proxy, se puede usar el campo <code>X-Forwarded-For</code>, que registra la <strong>lista de IPs</strong> de la IP de origen y la ruta del proxy en forma de <strong>pila</strong>.</li><li>Configurar <code>externalTrafficPolicy: Local</code> en el servicio <strong>NodePort</strong> del clúster puede conservar la IP de origen, pero pierde la capacidad de equilibración de carga.</li><li>Bajo la premisa de que <strong>ingress-nginx-controller</strong> se despliega en forma de <strong>daemonset</strong> en todos los nodos con rol <strong>loadbalancer</strong>, configurar <code>externalTrafficPolicy: Local</code> puede conservar la IP de origen y mantener la capacidad de equilibración de carga.</li></ul><h2 id=referencias>Referencias</h2><ul><li><a href=https://kubernetes.io/zh-cn/docs/tutorials/services/source-ip/>Kubernetes uso de IP de origen</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/>Ingress-Nginx Controller:ConfigMap</a></li><li><a href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/>Ingress Controller</a></li></ul><br><script src=https://giscus.app/client.js data-repo=jqknono/blog data-repo-id=R_kgDONOhENQ data-category=Announcements data-category-id=DIC_kwDONOhENc4CkQDB data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script><br><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/es-es/blog/2024/05/20/nuevo-usuario-se-presenta-en-minor%C3%ADa/ aria-label="Anterior - Nuevo usuario se presenta en Minoría" class="btn btn-primary"><span class=me-1>←</span>Anterior</a></li><li><a href=/es-es/blog/2024/05/27/instalaci%C3%B3n-y-activaci%C3%B3n-del-sistema-windows/ aria-label="Siguiente - Instalación y activación del sistema Windows" class="btn btn-primary">Siguiente<span class=ms-1>→</span></a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/jqknono aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2015&ndash;2025
<span class=td-footer__authors>jqknono</span></span><span class=td-footer__all_rights_reserved>Todos los derechos reservados</span></div></div></div></footer></div><script type=module async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@latest\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {"theme":"default","version":"latest"};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>