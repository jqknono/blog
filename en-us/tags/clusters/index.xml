<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Clusters on Nono Blogs</title><link>https://blog.jqknono.com/en-us/tags/clusters/</link><description>Recent content in Clusters on Nono Blogs</description><generator>Hugo</generator><language>en-us</language><lastBuildDate>Fri, 14 Jun 2024 12:53:46 +0800</lastBuildDate><atom:link href="https://blog.jqknono.com/en-us/tags/clusters/index.xml" rel="self" type="application/rss+xml"/><item><title>Using Alibaba Cloud Distributed Storage with Self-Built K8s Clusters</title><link>https://blog.jqknono.com/en-us/blog/2024/06/14/using-alibaba-cloud-distributed-storage-with-self-built-k8s-clusters/</link><pubDate>Fri, 14 Jun 2024 12:53:46 +0800</pubDate><guid>https://blog.jqknono.com/en-us/blog/2024/06/14/using-alibaba-cloud-distributed-storage-with-self-built-k8s-clusters/</guid><description>&lt;h2 id="introduction"&gt;Introduction&lt;/h2&gt;
&lt;p&gt;This article, written on 2024-06-14, explains how to use Alibaba Cloud distributed storage in a self-built cluster on Alibaba Cloud. At the end you will find document links; the official Alibaba Cloud documentation is in Chinese, while the Alibaba Cloud storage plugin repository on GitHub currently contains only English docs—readers who can do so are encouraged to consult the original texts.&lt;/p&gt;
&lt;h2 id="storage-plugin-installation"&gt;Storage Plugin Installation&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;Create a custom permission policy: &lt;a href="https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/ram-policies/disk.json"&gt;https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/ram-policies/disk.json&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Create a RAM role, attach the custom policy, and save the &lt;code&gt;accesskey&lt;/code&gt; and &lt;code&gt;secret&lt;/code&gt;:
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;kubectl create secret -n kube-system generic csi-access-key --from-literal=id='{id}' --from-literal=secret='{secret}'&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;Install the CSI driver—no Helm chart exists, so installation must be done locally (as of 2024-06-13).
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;git clone https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver.git&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;cd alibaba-cloud-csi-driver/deploy&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;If you are deploying to a self-built cluster on Alibaba Cloud ECS, simply run the next command; &lt;strong&gt;otherwise, read the notes carefully&lt;/strong&gt;: &lt;a href="https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/install.md"&gt;https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/install.md&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;helm upgrade --install alibaba-cloud-csi-driver ./chart --values chart/values-ecs.yaml --namespace kube-system&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;Confirm with &lt;code&gt;watch kubectl get pods -n kube-system -l app=csi-plugin&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="storage-type-selection-guide"&gt;Storage Type Selection Guide&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;The minimum size for an ECS cloud disk is 20 GB with 3,000 IOPS; this is quite large and not particularly cost-effective.
&lt;ul&gt;
&lt;li&gt;Dynamic cloud-disk volumes
&lt;ul&gt;
&lt;li&gt;Official docs:
&lt;ul&gt;
&lt;li&gt;Cloud disks cannot span availability zones; they are non-shared and can be mounted by only one Pod at a time (tests show multiple Pods in the same deployment can mount the same disk).&lt;/li&gt;
&lt;li&gt;Disk type must match the ECS type or mounting will fail. Refer to &lt;a href="https://help.aliyun.com/zh/ecs/user-guide/overview-of-instance-families#concept-sx4-lxv-tdb"&gt;Instance Families&lt;/a&gt; for detailed compatibility.&lt;/li&gt;
&lt;li&gt;During deployment, a StorageClass auto-provisions the PV to purchase the cloud disk. If you have already purchased the disk, use a static volume instead.&lt;/li&gt;
&lt;li&gt;The requested disk size must lie within the range allowed for single disks.&lt;/li&gt;
&lt;li&gt;When the Pod is recreated, it will re-attach the original cloud disk. If scheduling constraints prevent relocation to the original AZ, the Pod will stay in the Pending state.&lt;/li&gt;
&lt;li&gt;Dynamically created disks are pay-as-you-go.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Extra test notes:
&lt;ul&gt;
&lt;li&gt;Although multiple Pods can mount a disk, only one can read and write; the rest are read-only. Therefore the PVC must set &lt;code&gt;accessModes&lt;/code&gt; to &lt;code&gt;ReadWriteOnce&lt;/code&gt;, and changing this has no effect.&lt;/li&gt;
&lt;li&gt;If the StorageClass &lt;code&gt;reclaimPolicy&lt;/code&gt; is &lt;code&gt;Delete&lt;/code&gt;, deleting the PVC also automatically deletes the cloud disk.&lt;/li&gt;
&lt;li&gt;If the StorageClass &lt;code&gt;reclaimPolicy&lt;/code&gt; is &lt;code&gt;Retain&lt;/code&gt;, the cloud disk is not deleted automatically; you must manually remove it both from the cluster and from the Alibaba Cloud console.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;A suitable scenario is hard to find.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Static cloud-disk volumes
&lt;ul&gt;
&lt;li&gt;Official docs:
&lt;ul&gt;
&lt;li&gt;Manually create the PV and PVC.&lt;/li&gt;
&lt;li&gt;Cloud disks cannot span availability zones; they are non-shared and can be mounted by only one Pod at a time.&lt;/li&gt;
&lt;li&gt;Disk type must match the ECS type or mounting fails.&lt;/li&gt;
&lt;li&gt;You may select disks in the same region and AZ as the cluster that are in the “Available” state.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;NAS exhibits comparatively high latency; the best-case latency is ~2 ms, deep storage ~10 ms, pay-as-you-go, and offers better read/write performance than OSS object storage.&lt;/li&gt;
&lt;li&gt;OSS volume: &lt;a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/oss-volume-overview-1?spm=a2c4g.11186623.0.0.43166a351NbtvU"&gt;https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/oss-volume-overview-1?spm=a2c4g.11186623.0.0.43166a351NbtvU&lt;/a&gt;
&lt;ul&gt;
&lt;li&gt;OSS is shared storage that can serve multiple Pods simultaneously.&lt;/li&gt;
&lt;li&gt;As of 2024-06-13 supports CentOS, Alibaba Cloud Linux, ContainerOS and Anolis OS.&lt;/li&gt;
&lt;li&gt;Each application uses an independent PV name when using the volume.&lt;/li&gt;
&lt;li&gt;OSS volumes rely on ossfs as a FUSE file system.
&lt;ul&gt;
&lt;li&gt;Good for read-only workloads—e.g., reading config, videos, images, etc.&lt;/li&gt;
&lt;li&gt;Not suitable for writing; consider the OSS SDK for writes or switch to NAS.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ossfs can be tuned (cache, permissions, etc.) via configuration parameters.&lt;/li&gt;
&lt;li&gt;ossfs limitations:
&lt;ul&gt;
&lt;li&gt;Random or append writes cause the entire file to be rewritten.&lt;/li&gt;
&lt;li&gt;Listing directories and other metadata operations are slow due to remote calls.&lt;/li&gt;
&lt;li&gt;File/folder rename is not atomic.&lt;/li&gt;
&lt;li&gt;When multiple clients mount the same bucket, users must coordinate behavior (e.g., avoid concurrent writes to the same file).&lt;/li&gt;
&lt;li&gt;No hard links.&lt;/li&gt;
&lt;li&gt;For CSI plugin versions below v1.20.7, only local changes are detected; external modifications by other clients or tools are ignored.&lt;/li&gt;
&lt;li&gt;Do not use in high-concurrent read/write scenarios to avoid system overload.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;In a hybrid cluster (with some nodes outside Alibaba Cloud) only NAS and OSS static volumes can be used.&lt;/li&gt;
&lt;li&gt;Cloud disks, NAS, and OSS have region restrictions.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In summary: Cloud disks are provisioned and mounted as whole disks, making sharing inconvenient. OSS operates at file granularity; high-concurrent read/write suffers performance issues and supported OSes are limited.&lt;/p&gt;</description></item></channel></rss>