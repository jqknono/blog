<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en-us class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://blog.jqknono.com/en-us/blog/cloud-service/><link rel=alternate type=application/rss+xml href=https://blog.jqknono.com/en-us/blog/cloud-service/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Nono Blogs</title><meta name=description content="--- layout: blog title: Cloud Services linkTitle: Cloud Services categories: Uncategorized tags: [Uncategorized, Cloud Services] date: 2024-06-28 15:32:02 +0800 draft: true toc: true toc_hide: false math: false comments: false giscus_comments: true hide_summary: false hide_feedback: false description: weight: 100 ---"><meta property="og:url" content="https://blog.jqknono.com/en-us/blog/cloud-service/"><meta property="og:site_name" content="Nono Blogs"><meta property="og:title" content="Nono Blogs"><meta property="og:description" content="--- layout: blog title: Cloud Services linkTitle: Cloud Services categories: Uncategorized tags: [Uncategorized, Cloud Services] date: 2024-06-28 15:32:02 +0800 draft: true toc: true toc_hide: false math: false comments: false giscus_comments: true hide_summary: false hide_feedback: false description: weight: 100 ---"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Nono Blogs"><meta itemprop=description content="--- layout: blog title: Cloud Services linkTitle: Cloud Services categories: Uncategorized tags: [Uncategorized, Cloud Services] date: 2024-06-28 15:32:02 +0800 draft: true toc: true toc_hide: false math: false comments: false giscus_comments: true hide_summary: false hide_feedback: false description: weight: 100 ---"><meta itemprop=datePublished content="2025-04-25T19:25:01+08:00"><meta itemprop=dateModified content="2025-04-25T19:25:01+08:00"><meta itemprop=wordCount content="39"><meta name=twitter:card content="summary"><meta name=twitter:title content="Nono Blogs"><meta name=twitter:description content="--- layout: blog title: Cloud Services linkTitle: Cloud Services categories: Uncategorized tags: [Uncategorized, Cloud Services] date: 2024-06-28 15:32:02 +0800 draft: true toc: true toc_hide: false math: false comments: false giscus_comments: true hide_summary: false hide_feedback: false description: weight: 100 ---"><link rel=preload href=/scss/main.min.82eab66f7dbf8584ac0249d2368c4a868f71d3dc29e923e1cf723cdc1816c00b.css as=style integrity="sha256-guq2b32/hYSsAknSNoxKho9x09wp6SPhz3I83BgWwAs=" crossorigin=anonymous><link href=/scss/main.min.82eab66f7dbf8584ac0249d2368c4a868f71d3dc29e923e1cf723cdc1816c00b.css rel=stylesheet integrity="sha256-guq2b32/hYSsAknSNoxKho9x09wp6SPhz3I83BgWwAs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9457787069079604" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3FFTG72NE"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3FFTG72NE")}</script></head><body class="td-section td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/en-us/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Nono Blogs</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/>简体中文</a></li><li><a class=dropdown-item href=/zh-tw/>繁體中文</a></li><li><a class=dropdown-item href=/ja-jp/>日本語</a></li><li><a class=dropdown-item href=/ko-kr/>한국어</a></li><li><a class=dropdown-item href=/ar-sa/>العربية</a></li><li><a class=dropdown-item href=/ar-ae/>العربية</a></li><li><a class=dropdown-item href=/de-de/>Deutsch</a></li><li><a class=dropdown-item href=/es-es/>Español</a></li><li><a class=dropdown-item href=/fr-fr/>Français</a></li><li><a class=dropdown-item href=/hi-in/>हिंदी</a></li><li><a class=dropdown-item href=/id-id/>Bahasa Indonesia</a></li><li><a class=dropdown-item href=/it-it/>Italiano</a></li><li><a class=dropdown-item href=/nl-nl/>Nederlands</a></li><li><a class=dropdown-item href=/pl-pl/>Polski</a></li><li><a class=dropdown-item href=/pt-br/>Português</a></li><li><a class=dropdown-item href=/ru-ru/>Русский</a></li><li><a class=dropdown-item href=/tr-tr/>Türkçe</a></li></ul></div></li><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.1183737b8e91393ce597fed20538eb54.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/en-us/blog/cloud-service/>Return to the regular view of this page</a>.</p></div><h1 class=title></h1><ul><li><a href=#pg-c6c9df06e8b7664f6728e815f4782ad4>Certificate Application Issues Caused by CNAME–TXT Conflicts</a></li><li><a href=#pg-5357265cce32003954f82aca7c934c1a>Releasing Reserved Memory on a VPS</a></li><li><a href=#pg-d8b4abf7db655cbdf4ddf54241e693c8>Alibaba Cloud Series</a></li><ul><li><a href=#pg-2eaf6c623e0356a8602090fc8e5a7831>How to obtain a wildcard certificate in CNAME mode with ESA</a></li></ul><li><a href=#pg-74d793a04812e1868f3a2f201332702f>ingress-nginx is not the same as nginx ingress</a></li><li><a href=#pg-923a96fa8028a1c15b6aa8c392b3c044>Using Alibaba Cloud Distributed Storage with Self-Built K8s Clusters</a></li><li><a href=#pg-69ea3478a4de4c7e33ea6ada7be5178e>Volume Classification and Methodology</a></li><li><a href=#pg-08945265c6bc1d546ba91022d39421be></a></li><li><a href=#pg-b0678e7e4fe066bd91c03c1731d9cef8></a></li><li><a href=#pg-857631a5064344e9263a6a91ebeb1959></a></li></ul><div class=content><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>layout: blog
</span></span><span class=line><span class=cl>title: Cloud Services
</span></span><span class=line><span class=cl>linkTitle: Cloud Services
</span></span><span class=line><span class=cl>categories: Uncategorized
</span></span><span class=line><span class=cl>tags: [Uncategorized, Cloud Services]
</span></span><span class=line><span class=cl>date: 2024-06-28 15:32:02 +0800
</span></span><span class=line><span class=cl>draft: true
</span></span><span class=line><span class=cl>toc: true
</span></span><span class=line><span class=cl>toc_hide: false
</span></span><span class=line><span class=cl>math: false
</span></span><span class=line><span class=cl>comments: false
</span></span><span class=line><span class=cl>giscus_comments: true
</span></span><span class=line><span class=cl>hide_summary: false
</span></span><span class=line><span class=cl>hide_feedback: false
</span></span><span class=line><span class=cl>description:
</span></span><span class=line><span class=cl>weight: 100
</span></span><span class=line><span class=cl>---
</span></span></code></pre></div></div></div><div class=td-content><h1 id=pg-c6c9df06e8b7664f6728e815f4782ad4>Certificate Application Issues Caused by CNAME–TXT Conflicts</h1><div class="td-byline mb-4"><time datetime=2025-04-25 class=text-body-secondary>Friday, April 25, 2025</time></div><h2 id=cname-and-txt-records-with-the-same-prefix-cannot-coexist>CNAME and TXT Records With the Same Prefix Cannot Coexist</h2><p>Anyone who has ever configured a domain knows that (A, AAAA) records cannot coexist with a CNAME, but most people have never run into a TXT vs. CNAME conflict.</p><p>When would TXT and CNAME need the same prefix?</p><p>One scenario occurs while applying for a Let’s Encrypt certificate and using the <strong><em>DNS-01</em> challenge</strong> to prove domain ownership.</p><ol><li>Certbot creates a <strong>TXT record</strong> for <code>_acme-challenge.example.com</code>, using an akid/aksecret pair or a token.</li><li>Let’s Encrypt queries the <strong>TXT record</strong> to confirm that the applicant can modify DNS and therefore controls the domain.</li><li>Let’s Encrypt issues the certificate.</li><li>Certbot cleans up the <strong>TXT record</strong> for <code>_acme-challenge.example.com</code>.</li></ol><p>If a <strong>CNAME record</strong> for <code>_acme-challenge.example.com</code> already exists when the <strong>TXT record</strong> is created, the <strong>TXT record</strong> insertion usually fails, causing the challenge to fail and the certificate to be denied.</p><p>Why does a <strong>CNAME record</strong> like <code>_acme-challenge.example.com</code> ever exist?</p><p>Alibaba Cloud recently launched <strong>ESA</strong> (Edge Security Acceleration), a service similar to Cloudflare and the successor/extension of the original <strong>DCDN - Full Site Acceleration</strong>.<br>At first it did not support self-service wildcard certificates, so I ran a periodic script that pushed my own wildcard cert via the ESA API, which was a bit of a hassle.<br>Later, <strong>Managed DCV</strong> was introduced, allowing wildcard certs to be requested and renewed automatically.<br>Following the official docs worked great—suddenly wildcard certs “just worked.”<br>But the hidden trap only surfaced months later: the persistent <strong>CNAME record</strong> blocks creation of any TXT record with the same prefix, so I can no longer validate domain ownership elsewhere.</p><p><img src=https://img1.techfetch.dev/blog/202504251923471.png alt></p><h2 id=solutions>Solutions</h2><h3 id=option-1-stop-using-managed-dcv>Option 1: Stop Using Managed DCV</h3><p>Managed DCV requires you to point <code>_acme-challenge.example.com</code> to a specific value, which essentially delegates that label (and therefore validates your domain) to a third party—you no longer control it.</p><p>If you still need a wildcard certificate, you can task a script to call ESA’s API and upload a new wildcard cert at regular intervals.</p><h3 id=option-2-switch-to-a-different-challenge-type>Option 2: Switch to a Different Challenge Type</h3><p>Certbot offers several ways to prove domain ownership:</p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td>DNS-01</td><td>Create a TXT record; no prior web server required.</td></tr><tr><td>HTTP-01</td><td>Place a file on the active web server.</td></tr><tr><td>TLS-ALPN-01</td><td>Present a special TLS certificate from the server.</td></tr></tbody></table><p>HTTP-01 and TLS-ALPN-01 require a running service before you can get a certificate, whereas DNS-01 works before any services are online.</p><h3 id=option-3-break-down-the-silo-between-esa-and-alibaba-cloud-dns>Option 3: Break Down the Silo Between ESA and Alibaba Cloud DNS</h3><p>Both products belong to Alibaba Cloud, but they implement separate DNS APIs.<br>If ESA could create a <strong>TXT or CNAME record</strong> in <strong>Alibaba Cloud DNS</strong>, obtain a certificate, and then immediately delete the temporary record, DNS-01 challenges elsewhere would remain unaffected.</p><h3 id=option-4-leave-alibaba-cloud-esa>Option 4: Leave Alibaba Cloud ESA</h3><p>Cloudflare doesn’t have this problem—certificates are issued freely without hostname delegation.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5357265cce32003954f82aca7c934c1a>Releasing Reserved Memory on a VPS</h1><div class="td-byline mb-4"><time datetime=2024-12-31 class=text-body-secondary>Tuesday, December 31, 2024</time></div><p>By default, the Linux kernel reserves a block of memory for <code>kdump</code>, and its size is controlled by the <code>crashkernel</code> parameter. Most application developers rarely trigger kernel panics, so you can recover this memory by editing <code>/etc/default/grub</code>.</p><p>If you do <strong>not</strong> need <code>kdump</code>, set the <code>crashkernel</code> parameter to<br><code>0M-1G:0M,1G-4G:0M,4G-128G:0M,128G-:512M</code>; this releases the reserved memory.</p><p><strong>Check current value</strong>: <code>cat /etc/default/grub</code></p><p>Typical default:</p><blockquote><p>GRUB_CMDLINE_LINUX=" vga=792 console=tty0 console=ttyS0,115200n8 net.ifnames=0 noibrs nvme_core.io_timeout=4294967295 nvme_core.admin_timeout=4294967295 iommu=pt crashkernel=0M-1G:0M,1G-4G:192M,4G-128G:384M,128G-:512M crash_kexec_post_notifiers=1"</p></blockquote><p><code>crashkernel</code> above means<br>• 0–1 GB hosts: <strong>0 MB</strong> reserved<br>• 1–4 GB hosts: <strong>192 MB</strong> reserved<br>• 4–128 GB hosts: <strong>384 MB</strong> reserved<br>• ≥128 GB hosts: <strong>512 MB</strong> reserved</p><p>For example, a 1 GB host falls into the 1–4 GB bracket, so <strong>192 MB</strong> is reserved; a 4 GB host falls into the 4–128 GB bracket, reserving <strong>384 MB</strong>.</p><p><strong>Apply change</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo sed -i <span class=s1>&#39;s/crashkernel=0M-1G:0M,1G-4G:192M,4G-128G:384M,128G-:512M/crashkernel=0M-1G:0M,1G-4G:0M,4G-128G:0M,128G-:512M/&#39;</span> /etc/default/grub
</span></span><span class=line><span class=cl>sudo update-grub <span class=o>&amp;&amp;</span> sudo reboot
</span></span></code></pre></div><p>For a typical beginner VPS (2 vCPU + 1 GB RAM):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Before</span>
</span></span><span class=line><span class=cl>root@iZj6c0otki9ho421eewyczZ:~# free
</span></span><span class=line><span class=cl>               total        used        free      shared  buff/cache   available
</span></span><span class=line><span class=cl>Mem:          <span class=m>707180</span>      <span class=m>340772</span>      <span class=m>123400</span>        <span class=m>2624</span>      <span class=m>358872</span>      <span class=m>366408</span>
</span></span><span class=line><span class=cl>Swap:              <span class=m>0</span>           <span class=m>0</span>           <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># After</span>
</span></span><span class=line><span class=cl>root@iZj6c0otki9ho421eewyczZ:~# free
</span></span><span class=line><span class=cl>               total        used        free      shared  buff/cache   available
</span></span><span class=line><span class=cl>Mem:          <span class=m>903788</span>      <span class=m>341656</span>      <span class=m>451380</span>        <span class=m>2616</span>      <span class=m>251032</span>      <span class=m>562132</span>
</span></span><span class=line><span class=cl>Swap:              <span class=m>0</span>           <span class=m>0</span>           <span class=m>0</span>
</span></span></code></pre></div><p>For a 2 vCPU + 4 GB VPS:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Before</span>
</span></span><span class=line><span class=cl>root@iZj6c1prxn78ilvd2inku1Z:~# free
</span></span><span class=line><span class=cl>               total        used        free      shared  buff/cache   available
</span></span><span class=line><span class=cl>Mem:         <span class=m>3512696</span>      <span class=m>377672</span>     <span class=m>2870944</span>        <span class=m>1260</span>      <span class=m>415116</span>     <span class=m>3135024</span>
</span></span><span class=line><span class=cl>Swap:              <span class=m>0</span>           <span class=m>0</span>           <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># After</span>
</span></span><span class=line><span class=cl>root@iZj6c1prxn78ilvd2inku1Z:~# free
</span></span><span class=line><span class=cl>               total        used        free      shared  buff/cache   available
</span></span><span class=line><span class=cl>Mem:         <span class=m>3905912</span>      <span class=m>374468</span>     <span class=m>3408304</span>        <span class=m>1252</span>      <span class=m>270508</span>     <span class=m>3531444</span>
</span></span><span class=line><span class=cl>Swap:              <span class=m>0</span>           <span class=m>0</span>           <span class=m>0</span>
</span></span></code></pre></div><h2 id=more-about-kdump>More about kdump</h2><p>Kdump is a Linux kernel crash-dumping mechanism. It relies on the <code>kexec</code> facility, which allows one kernel to load another kernel without BIOS initialization. When a fatal error triggers a panic, the running “production” kernel uses kexec to boot a small “capture” kernel that has exclusive use of the reserved memory. The capture kernel then writes the entire memory image (vmcore or kdump file) to disk, a network server, or another storage target. Later, the vmcore can be analyzed to determine the crash cause.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d8b4abf7db655cbdf4ddf54241e693c8>Alibaba Cloud Series</h1><div class="td-byline mb-4"><time datetime=2024-06-28 class=text-body-secondary>Friday, June 28, 2024</time></div><ul><li><input disabled type=checkbox> _index</li></ul></div><div class=td-content><h1 id=pg-2eaf6c623e0356a8602090fc8e5a7831>How to obtain a wildcard certificate in CNAME mode with ESA</h1><div class="td-byline mb-4"><time datetime=2025-03-17 class=text-body-secondary>Monday, March 17, 2025</time></div><p>Your domain is hosted on Alibaba Cloud DNS or a third-party provider, and you cannot move the domain’s NS, yet you need a wildcard certificate. Alibaba Cloud ESA provides a quota of 10 certificates, which is clearly insufficient.</p><p>Here is a method to obtain a wildcard certificate, followed by an explanation of the principle.</p><p>You’ll need to work in two separate consoles:</p><ol><li>ESA</li><li>DNS (Cloud Resolution or third-party DNS)</li></ol><h3 id=steps>Steps</h3><ol><li>ESA: DNS → Settings: <strong>Switch to NS mode</strong>, confirm directly—no additional action needed.</li><li>ESA: apply for a free edge certificate, request only <code>*.example.com</code>, using your own domain.</li><li>ESA: expand the dropdown next to the pending certificate to obtain the TXT record: host record <code>_acme-challenge.example.com</code>, value <code>-PewtWrH93avbM_bScUILtcNwCHifNvjZIa2VgT9seQ</code>.</li><li>DNS: add a TXT record with the host record and value from the previous step.</li><li>Wait for the wildcard certificate to be issued; if it hasn’t been obtained within ten minutes, something went wrong—check manually.</li><li>ESA: DNS → Settings: <strong>Switch back to CNAME mode</strong>, confirm directly—no additional action needed.</li></ol><h2 id=principle>Principle</h2><p>Free certificates come from Let’s Encrypt, which offers two validation methods:</p><ol><li>HTTP-01 Challenge: Let’s Encrypt’s validation server makes an HTTP request to a specific file on your server (at the path <code>.well-known/acme-challenge/</code>) to confirm domain control.</li><li>DNS-01 Challenge: you must add a TXT record to your domain’s DNS. By adding the required TXT record you prove control of the domain.</li></ol><p>Wildcard certificates can only be obtained via <code>DNS-01 Challenge</code>; hence they require DNS records. Consequently, ESA insists that domains must be hosted on the ESA platform in order to apply for wildcard certificates. The step “ESA: DNS → Settings: <strong>Switch to NS mode</strong>” is derived from analysing the return of ESA’s <code>ApplyCertificate</code> interface; this step has no practical effect other than bypassing Alibaba Cloud’s validation.</p><p>The core procedure is to place a pre-defined TXT record on the domain’s authoritative nameservers when requesting a certificate from Let’s Encrypt. Whether those nameservers belong to DNS (Cloud Resolution) or ESA is irrelevant—the TXT record suffices to prove domain ownership.</p><h2 id=summary>Summary</h2><p>ESA and Cloud Resolution are both under the Alibaba Cloud umbrella, yet they cannot share data. ESA already has the ability to verify domain ownership for your account; obtaining a wildcard certificate could be as simple as adding a DNS record via Cloud Resolution and granting permission, but this is not implemented. There is still room for better UX.</p><p>Be aware that certificates acquired this way may fail to auto-renew. You can use the API to synchronise a certificate into ESA externally: <a href=https://api.aliyun.com/api/ESA/2024-09-10/SetCertificate>https://api.aliyun.com/api/ESA/2024-09-10/SetCertificate</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-74d793a04812e1868f3a2f201332702f>ingress-nginx is not the same as nginx ingress</h1><div class="td-byline mb-4"><time datetime=2024-06-18 class=text-body-secondary>Tuesday, June 18, 2024</time></div><p>After two weeks of reading documents, I finally realized that <code>Ingress-Nginx</code> and <code>Nginx Ingress</code> are not the same thing; they differ in functionality as well as implementation. There are even documents guiding the migration.</p><ul><li><a href=https://docs.nginx.com/nginx-ingress-controller/installation/ingress-nginx/>Migrating from the Ingress-NGINX Controller to the NGINX Ingress Controller</a></li><li><a href=https://docs.nginx.com/nginx-ingress-controller/>NGINX Ingress Controller</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/>Ingress-NGINX</a></li></ul><p><code>Ingress-NGINX</code> is the community edition with more participants and a greater number of search results. <code>NGINX Ingress</code> is the commercial edition, richer in features but with lower community participation.</p><p>According to <a href=https://docs.nginx.com/mesh/tutorials/kic/deploy-with-kic/>Deploy with NGINX Ingress Controller - Overview</a></p><blockquote><p>NGINX Ingress Controller can be used for free with NGINX Open Source. Paying customers have access to NGINX Ingress Controller with NGINX Plus. To deploy NGINX Ingress Controller with NGINX Service Mesh, you must use either:</p><p>Open Source NGINX Ingress Controller version 3.0+
NGINX Plus version of NGINX Ingress Controller
Visit the NGINX Ingress Controller product page for more information.</p></blockquote><p>You can use NGINX Ingress Controller for free via NGINX Open Source, while paying customers can access it through NGINX Plus.</p><p>Additionally, the Nginx commercial edition’s official website has moved to <a href=https://www.f5.com/go/product/welcome-to-nginx>www.f5.com</a></p><p>The Nginx Ingress Controller product page is <a href=https://www.f5.com/products/nginx/nginx-ingress-controller>https://www.f5.com/products/nginx/nginx-ingress-controller</a></p><p><img src=https://s2.loli.net/2024/06/18/njRBo8r6gUeTF74.png alt></p><p>This May 2021 blog post compared their differences: <a href=https://grigorkh.medium.com/there-are-two-nginx-ingress-controllers-for-k8s-what-44c7b548e678>There are two Nginx Ingress Controllers for k8s. What?</a></p><table><thead><tr><th>Aspect or Feature</th><th>kubernetes/ingress-nginx</th><th>nginxinc/kubernetes-ingress with NGINX</th><th>nginxinc/kubernetes-ingress with NGINX Plus</th></tr></thead><tbody><tr><td><strong>Fundamental</strong></td><td></td><td></td><td></td></tr><tr><td>Authors</td><td>Kubernetes community</td><td>NGINX Inc and community</td><td>NGINX Inc and community</td></tr><tr><td>NGINX version</td><td><a href=https://github.com/kubernetes/ingress-nginx/tree/master/images/nginx>Custom</a> NGINX build that includes several third-party modules</td><td>NGINX official mainline <a href=https://github.com/nginxinc/docker-nginx>build</a></td><td>NGINX Plus</td></tr><tr><td>Commercial support</td><td>N/A</td><td>N/A</td><td>Included</td></tr><tr><td>Implemented in</td><td>Go/Lua (while Nginx is written in C)</td><td>Go/Python</td><td>Go/Python</td></tr><tr><td><strong>Load balancing configuration via the Ingress resource</strong></td><td></td><td></td><td></td></tr><tr><td>Merging Ingress rules with the same host</td><td>Supported</td><td>Supported via <a href=../examples/mergeable-ingress-types>Mergeable Ingresses</a></td><td>Supported via <a href=../examples/mergeable-ingress-types>Mergeable Ingresses</a></td></tr><tr><td>HTTP load balancing extensions - Annotations</td><td>See the <a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/>supported annotations</a></td><td>See the <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/ingress-resources/advanced-configuration-with-annotations/>supported annotations</a></td><td>See the <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/ingress-resources/advanced-configuration-with-annotations/>supported annotations</a></td></tr><tr><td>HTTP load balancing extensions &ndash; ConfigMap</td><td>See the <a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/>supported ConfigMap keys</a></td><td>See the <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/global-configuration/configmap-resource/>supported ConfigMap keys</a></td><td>See the <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/global-configuration/configmap-resource/>supported ConfigMap keys</a></td></tr><tr><td>TCP/UDP</td><td>Supported via a ConfigMap</td><td>Supported via custom resources</td><td>Supported via custom resources</td></tr><tr><td>Websocket</td><td>Supported</td><td>Supported via an <a href=../examples/websocket>annotation</a></td><td>Supported via an <a href=../examples/websocket>annotation</a></td></tr><tr><td>TCP SSL Passthrough</td><td>Supported via a ConfigMap</td><td>Supported via custom resources</td><td>Supported via custom resources</td></tr><tr><td>JWT validation</td><td>Not supported</td><td>Not supported</td><td>Supported</td></tr><tr><td>Session persistence</td><td>Supported via a third-party module</td><td>Not supported</td><td>Supported</td></tr><tr><td>Canary testing (by header, cookie, weight)</td><td>Supported via annotations</td><td>Supported via custom resources</td><td>Supported via custom resources</td></tr><tr><td>Configuration templates</td><td>See the <a href=https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/template/nginx.tmpl>template</a></td><td>See the <a href=../internal/configs/version1>templates</a></td><td>See the <a href=../internal/configs/version1>templates</a></td></tr><tr><td><strong>Load balancing configuration via Custom Resources</strong></td><td></td><td></td><td></td></tr><tr><td>HTTP load balancing</td><td>Not supported</td><td>See <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/virtualserver-and-virtualserverroute-resources/>VirtualServer and VirtualServerRoute</a> resources</td><td>See <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/virtualserver-and-virtualserverroute-resources/>VirtualServer and VirtualServerRoute</a> resources</td></tr><tr><td>TCP/UDP load balancing</td><td>Not supported</td><td>See <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/transportserver-resource/>TransportServer</a> resource</td><td>See <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/transportserver-resource/>TransportServer</a> resource</td></tr><tr><td>TCP SSL Passthrough load balancing</td><td>Not supported</td><td>See <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/transportserver-resource/>TransportServer</a> resource</td><td>See <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/transportserver-resource/>TransportServer</a> resource</td></tr><tr><td><strong>Deployment</strong></td><td></td><td></td><td></td></tr><tr><td>Command-line arguments</td><td>See the <a href=https://kubernetes.github.io/ingress-nginx/user-guide/cli-arguments/>arguments</a></td><td>See the <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/global-configuration/command-line-arguments/>arguments</a></td><td>See the <a href=https://docs.nginx.com/nginx-ingress-controller/configuration/global-configuration/command-line-arguments/>arguments</a></td></tr><tr><td>TLS certificate and key for the default server</td><td>Required as a command-line argument/ auto-generated</td><td>Required as a command-line argument</td><td>Required as a command-line argument</td></tr><tr><td>Helm chart</td><td>Supported</td><td>Supported</td><td>Supported</td></tr><tr><td>Operator</td><td>Not supported</td><td>Supported</td><td>Supported</td></tr><tr><td><strong>Operational</strong></td><td></td><td></td><td></td></tr><tr><td>Reporting the IP address(es) of the Ingress controller into Ingress resources</td><td>Supported</td><td>Supported</td><td>Supported</td></tr><tr><td>Extended Status</td><td>Supported via a third-party module</td><td>Not supported</td><td>Supported</td></tr><tr><td>Prometheus Integration</td><td>Supported</td><td>Supported</td><td>Supported</td></tr><tr><td>Dynamic reconfiguration of endpoints (no configuration reloading)</td><td>Supported with a third-party Lua module</td><td>Not supported</td><td>Supported</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-923a96fa8028a1c15b6aa8c392b3c044>Using Alibaba Cloud Distributed Storage with Self-Built K8s Clusters</h1><div class="td-byline mb-4"><time datetime=2024-06-14 class=text-body-secondary>Friday, June 14, 2024</time></div><h2 id=introduction>Introduction</h2><p>This article, written on 2024-06-14, explains how to use Alibaba Cloud distributed storage in a self-built cluster on Alibaba Cloud. At the end you will find document links; the official Alibaba Cloud documentation is in Chinese, while the Alibaba Cloud storage plugin repository on GitHub currently contains only English docs—readers who can do so are encouraged to consult the original texts.</p><h2 id=storage-plugin-installation>Storage Plugin Installation</h2><ol><li>Create a custom permission policy: <a href=https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/ram-policies/disk.json>https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/ram-policies/disk.json</a></li><li>Create a RAM role, attach the custom policy, and save the <code>accesskey</code> and <code>secret</code>:<ol><li><code>kubectl create secret -n kube-system generic csi-access-key --from-literal=id='{id}' --from-literal=secret='{secret}'</code></li></ol></li><li>Install the CSI driver—no Helm chart exists, so installation must be done locally (as of 2024-06-13).<ol><li><code>git clone https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver.git</code></li><li><code>cd alibaba-cloud-csi-driver/deploy</code></li><li>If you are deploying to a self-built cluster on Alibaba Cloud ECS, simply run the next command; <strong>otherwise, read the notes carefully</strong>: <a href=https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/install.md>https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/install.md</a></li><li><code>helm upgrade --install alibaba-cloud-csi-driver ./chart --values chart/values-ecs.yaml --namespace kube-system</code></li></ol></li><li>Confirm with <code>watch kubectl get pods -n kube-system -l app=csi-plugin</code></li></ol><h2 id=storage-type-selection-guide>Storage Type Selection Guide</h2><ul><li>The minimum size for an ECS cloud disk is 20 GB with 3,000 IOPS; this is quite large and not particularly cost-effective.<ul><li>Dynamic cloud-disk volumes<ul><li>Official docs:<ul><li>Cloud disks cannot span availability zones; they are non-shared and can be mounted by only one Pod at a time (tests show multiple Pods in the same deployment can mount the same disk).</li><li>Disk type must match the ECS type or mounting will fail. Refer to <a href=https://help.aliyun.com/zh/ecs/user-guide/overview-of-instance-families#concept-sx4-lxv-tdb>Instance Families</a> for detailed compatibility.</li><li>During deployment, a StorageClass auto-provisions the PV to purchase the cloud disk. If you have already purchased the disk, use a static volume instead.</li><li>The requested disk size must lie within the range allowed for single disks.</li><li>When the Pod is recreated, it will re-attach the original cloud disk. If scheduling constraints prevent relocation to the original AZ, the Pod will stay in the Pending state.</li><li>Dynamically created disks are pay-as-you-go.</li></ul></li><li>Extra test notes:<ul><li>Although multiple Pods can mount a disk, only one can read and write; the rest are read-only. Therefore the PVC must set <code>accessModes</code> to <code>ReadWriteOnce</code>, and changing this has no effect.</li><li>If the StorageClass <code>reclaimPolicy</code> is <code>Delete</code>, deleting the PVC also automatically deletes the cloud disk.</li><li>If the StorageClass <code>reclaimPolicy</code> is <code>Retain</code>, the cloud disk is not deleted automatically; you must manually remove it both from the cluster and from the Alibaba Cloud console.</li></ul></li><li>A suitable scenario is hard to find.</li></ul></li><li>Static cloud-disk volumes<ul><li>Official docs:<ul><li>Manually create the PV and PVC.</li><li>Cloud disks cannot span availability zones; they are non-shared and can be mounted by only one Pod at a time.</li><li>Disk type must match the ECS type or mounting fails.</li><li>You may select disks in the same region and AZ as the cluster that are in the “Available” state.</li></ul></li></ul></li></ul></li><li>NAS exhibits comparatively high latency; the best-case latency is ~2 ms, deep storage ~10 ms, pay-as-you-go, and offers better read/write performance than OSS object storage.</li><li>OSS volume: <a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/oss-volume-overview-1?spm=a2c4g.11186623.0.0.43166a351NbtvU">https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/oss-volume-overview-1?spm=a2c4g.11186623.0.0.43166a351NbtvU</a><ul><li>OSS is shared storage that can serve multiple Pods simultaneously.</li><li>As of 2024-06-13 supports CentOS, Alibaba Cloud Linux, ContainerOS and Anolis OS.</li><li>Each application uses an independent PV name when using the volume.</li><li>OSS volumes rely on ossfs as a FUSE file system.<ul><li>Good for read-only workloads—e.g., reading config, videos, images, etc.</li><li>Not suitable for writing; consider the OSS SDK for writes or switch to NAS.</li></ul></li><li>ossfs can be tuned (cache, permissions, etc.) via configuration parameters.</li><li>ossfs limitations:<ul><li>Random or append writes cause the entire file to be rewritten.</li><li>Listing directories and other metadata operations are slow due to remote calls.</li><li>File/folder rename is not atomic.</li><li>When multiple clients mount the same bucket, users must coordinate behavior (e.g., avoid concurrent writes to the same file).</li><li>No hard links.</li><li>For CSI plugin versions below v1.20.7, only local changes are detected; external modifications by other clients or tools are ignored.</li><li>Do not use in high-concurrent read/write scenarios to avoid system overload.</li></ul></li></ul></li><li>In a hybrid cluster (with some nodes outside Alibaba Cloud) only NAS and OSS static volumes can be used.</li><li>Cloud disks, NAS, and OSS have region restrictions.</li></ul><p>In summary: Cloud disks are provisioned and mounted as whole disks, making sharing inconvenient. OSS operates at file granularity; high-concurrent read/write suffers performance issues and supported OSes are limited.</p><ul><li>Cloud disks suit databases or other scenarios demanding large space and high performance.</li><li>For scenarios with lower performance needs, NAS is a good choice.</li><li>OSS is unsuitable for high-concurrent writes on Alibaba Cloud clusters, though it may suit concurrent-read workloads.</li></ul><p>The official documentation contains inconsistencies and contradictions; readers should check the date and run their own tests to verify whether a formerly unsupported feature may have since become supported.</p><h2 id=operation-steps>Operation Steps</h2><p>Follow the official Alibaba Cloud guide. After installing the storage plugin as described above, you can proceed with deployment using <a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/mount-statically-provisioned-nas-volumes?spm=a2c4g.11186623.0.0.125672b9VnrKw6">Use NAS static volumes</a>.</p><p><strong>Note</strong>: k3s users may hit issues with local-path-storage, seeing errors like:</p><blockquote><ul><li>failed to provision volume with StorageClass &ldquo;local-path&rdquo;: claim.Spec.Selector is not supported</li><li>Waiting for a volume to be created either by the external provisioner &rsquo;localplugin.csi.alibabacloud.com&rsquo; or manually by the system administrator. If volume creation is delayed, please verify that the provisioner is running and correctly registered.</li></ul></blockquote><p>To avoid k3s’s default local-path-storage, set <strong>storageClassName</strong> in the <strong>persistentVolumeClaim</strong> to empty:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc-nas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteMany</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>alicloud-pvname</span><span class=p>:</span><span class=w> </span><span class=l>pv-nas</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span></code></pre></div><h2 id=references>References</h2><ul><li><a href=https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver>https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver</a></li><li><a href=https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/disk.md>https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/disk.md</a></li><li><a href=https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/install.md>https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/install.md</a></li><li><a href=https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/ram-policies/disk.json>https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/docs/ram-policies/disk.json</a></li><li><a href=https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/deploy/chart/values.yaml>https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/deploy/chart/values.yaml</a></li><li><a href=https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/use-dynamically-provisioned-disk-volumes?#6d16e8a415nie>https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/use-dynamically-provisioned-disk-volumes?#6d16e8a415nie</a></li><li><a href="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/mount-statically-provisioned-nas-volumes?spm=a2c4g.11186623.0.0.125672b9VnrKw6">https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/mount-statically-provisioned-nas-volumes?spm=a2c4g.11186623.0.0.125672b9VnrKw6</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-69ea3478a4de4c7e33ea6ada7be5178e>Volume Classification and Methodology</h1><div class="td-byline mb-4"><time datetime=2024-06-05 class=text-body-secondary>Wednesday, June 05, 2024</time></div><ul><li><a href=https://kubernetes.io/docs/concepts/storage/volumes/>Volumes</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/>Persistent Volumes</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/projected-volumes/>Projected Volumes</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/ephemeral-volumes/>Ephemeral Volumes</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/storage-classes/>Storage Classes</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/>Dynamic Provisioning</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/volume-snapshots/>Volume Snapshots</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/volume-snapshot-classes/>Volume Snapshot Classes</a></li><li><a href=https://kubernetes.io/docs/concepts/storage/volume-pvc-datasource/>Volume Cloning</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-08945265c6bc1d546ba91022d39421be></h1><div class="td-byline mb-4"></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>layout</span><span class=p>:</span><span class=w> </span><span class=l>blog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>title</span><span class=p>:</span><span class=w> </span><span class=l>Image Hosting Design and Selection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>linkTitle</span><span class=p>:</span><span class=w> </span><span class=l>Image Hosting Design and Selection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>categories</span><span class=p>:</span><span class=w> </span><span class=l>uncategorized</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>uncategorized, cloud-services]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>date</span><span class=p>:</span><span class=w> </span><span class=ld>2024-06-28 15:46:17 +0800</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>draft</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>toc</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>toc_hide</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>math</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>comments</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>giscus_comments</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>hide_summary</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>hide_feedback</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>description</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span></code></pre></div><ul><li><input disabled type=checkbox> Image Hosting Design and Selection</li></ul><h2 id=what-is-image-hosting>What Is Image Hosting?</h2><p>In short, image hosting is a remote server used to store and manage the image assets required by a blog or website.</p><h2 id=why-use-image-hosting>Why Use Image Hosting?</h2><p>Image hosting can significantly improve website load speeds, decouple content from images, and reduce server pressure. From an article-organization and blog-architecture perspective, image hosting provides better image management and enhances the overall user experience.</p><p><strong>What is the essential difference between using and not using image hosting—​is it merely speed?</strong></p><p><strong>If a rented server has sufficient bandwidth, can one skip image hosting?</strong></p><p>Actually, the bigger impact lies in the differing coupling strength between Markdown files and images. In other words, the way content is organized and the overall blog architecture differ.</p><p>Without image hosting, images and Markdown files are tightly coupled; image management and usage rely on <strong>relative paths</strong>.<br>With image hosting, image management occurs on a remote server, while local files only reference remote URLs—​an <strong>absolute-path</strong> approach.</p><p>Absolute paths are usually preferable, since they ensure consistent image availability. With relative paths, references break if either the Markdown file or the image path changes.</p><p>Blogs that use relative paths are harder to refactor, maintain, and share across platforms. The many articles online with broken images often suffer from poorly managed file–resource relationships.</p><h2 id=how-image-hosting-speeds-up-your-site>How Image Hosting Speeds Up Your Site</h2><p>Typical personal servers have tight bandwidth limits. My long-standing VPS, for example, tops out at <strong>5 Mbps</strong>, allowing only <strong>600 KB/s</strong>.<br>With two <strong>3 MB</strong> images in a post, page load time exceeds <strong>10 seconds</strong>.</p><p><strong>We must recognize that few people will wait 10 seconds for a page.</strong></p><p><strong>How to solve slow loads?</strong></p><p>One can use <code>lazy-load</code>, showing text first and images later, so visitors aren’t stuck with a blank page.<br>This is only a stop-gap; many users leave even short pages within <strong>10 seconds</strong>, and bandwidth spent on loading unseen images isn’t delivering useful content.</p><p>The straightforward fix is increasing bandwidth, but dedicated bandwidth is expensive. Alibaba Cloud’s <strong>1000 Mbps</strong> daily rental exceeds <strong>6,000 CNY</strong>, making monthly costs surpass <strong>180,000 CNY</strong>—​unaffordable for individuals.</p><p>Providers offer traffic-based billing in addition to fixed bandwidth. Mainsland cloud vendors price this at <strong>0.5 CNY/GB to 1 CNY/GB</strong>, with 10 Mbps and 1 Tbps behaving identically cost-wise; you can burst to full bandwidth.</p><p>Note that traffic billing is post-paid. If the site is attacked, mass resource fetching can bankrupt you. Attack methods are so trivial that prevention is nearly impossible.</p><p>My home broadband offers <strong>1 TB/month</strong> for under <strong>200 CNY</strong>—​easily used to exhaust a server’s traffic quota at near-zero attacker cost.</p><p>One can build a self-hosted image server—configure nginx, restrict per-IP rate limits, limit multimedia access contexts, pre-compress and resize images—​but these steps consume valuable time.</p><p>Third-party image-hosting services specialize in image storage and usually bundle CDN (Content Delivery Network), accelerating transfers, cutting load times, and reducing server load.</p><p>Therefore, I strongly recommend third-party image hosting. They often add extras: compression, cropping, watermarks, etc., easing management and presentation.</p><h2 id=how-to-choose-an-image-host>How to Choose an Image Host</h2><p>Hosts break into <strong>third-party</strong> and <strong>self-hosted</strong>. Third-party types:</p><ul><li>Simple <strong>dedicated</strong> hosts—​upload, get URL (<a href=https://sm.ms/>sm.ms</a>, <a href=https://imgur.com/>imgur</a>).</li><li>Complex <strong>general storage</strong> (e.g., Alibaba Cloud OSS, Tencent Cloud COS) store any file type and provide extras: compression, crops, watermarks, image audits, recognition, etc.</li></ul><p>Evaluate these dimensions: <em>visit experience</em>, <em>authoring experience</em>, <em>adaptability</em>, <em>attack resilience</em>. Based on them, choose your host.</p><h3 id=authoring-experience>Authoring Experience</h3><p>Some hosts require uploading via browser, the worst experience. Lacking an API means breaking flow with: open page → upload → copy URL.<br>Hence prefer an API-enabled host. You can then bind a shortcut (e.g., in PicGo) and upload without interrupting your writing.</p><p>I recommend the open-source client <a href=https://picgo.github.io/PicGo-Doc/en/guide/>PicGo</a>—multi-host support, custom APIs. In self-hosted scenarios, FTP/WebDAV upload is also convenient.</p><h3 id=visit-experience>Visit Experience</h3><p>For best performance, add CDN. Building your own CDN is hard and costly, and—​due to policy—​some providers’ CDNs may underperform inside China; test personally.</p><h3 id=cost>Cost</h3><p>The three cost areas:</p><ul><li>Storage</li><li>Server traffic / bandwidth</li><li><strong>CDN traffic</strong></li></ul><p>Once live with noticeable traffic, CDN traffic dominates expenses, so focus on its unit price.</p><p>Alibaba Cloud starts at <code>0.24 CNY/GB</code>; large-scale discounts exist, but most individuals/businesses never hit them.</p><h3 id=avoid-bankruptcy>Avoid Bankruptcy</h3><p>This section is security-critical enough to warrant this title.</p><p>Primary attack form: amplify traffic via DDoS. Instead of crashing servers, CDNs absorb attacks, burning fees. Forum posters lost <strong>60 TB</strong> in a week. A public service <strong>will be attacked</strong>.</p><p>Most providers bill post-paid: use more, pay more. Monitor this risk closely.</p><p>Mitigation options:</p><ul><li><p><strong>Cloudflare</strong> handles attacks automatically.</p></li><li><p>Others supply security knobs (disabled by default):</p></li><li><p>Restrict <strong>referrer</strong>, allowing requests only from specified sites (or block no-referrer).</p></li><li><p>Restrict <strong>user-agent</strong>, e.g., reject curl.</p></li></ul><p>See Alibaba OSS settings below:</p><p><img src=https://s2.loli.net/2024/05/16/48JxCrzVY3diPes.png alt></p><p>These merely <strong>prevent hot-linking</strong>; attackers still craft valid requests.</p><p>OSS Advanced Mitigation promises real protection, but Alibaba’s price is outrageous—​it should be built-in, not sold as an extra.</p><p><img src=https://s2.loli.net/2024/05/16/snC2fYNGIFepHVT.png alt></p><p>Anti-DDoS pricing is so extreme that either Alibaba lacks ability or the product team lacks sense.</p><p>I do <strong>not recommend</strong> Alibaba OSS for image hosting—it offers no real protection (“only stops the honest”).</p><h2 id=conclusion>Conclusion</h2><p>As blogs evolve, you will eventually face the concept of image hosting. Start early to decouple content and images—the benefits are clear.</p><p>When selecting an image host, consider:</p><ul><li>Upload API</li><li>CDN with appropriate performance</li><li>DDoS protection</li></ul><p>On these grounds I mainly recommend <a href=https://smms.app/>sm.ms</a>. The free tier suffices for most users, albeit at modest speed.</p><h2 id=references>References</h2><ul><li><a href=https://github.com/Molunerfinn/PicGo/releases>Recommended tool: PicGo</a></li><li><a href=https://zhuanlan.zhihu.com/p/58863378>Collection of image hosts</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b0678e7e4fe066bd91c03c1731d9cef8></h1><div class="td-byline mb-4"></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>layout</span><span class=p>:</span><span class=w> </span><span class=l>blog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>title</span><span class=p>:</span><span class=w> </span><span class=l>How to preserve the original client IP after load-balancing in a K8s cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>categories</span><span class=p>:</span><span class=w> </span><span class=l>Networking</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>tags</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>networking, blog]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>date</span><span class=p>:</span><span class=w> </span><span class=ld>2024-05-27 11:52:22 +0800</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>draft</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>toc</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>comments</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Introduction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>**Application</span><span class=w> </span><span class=l>deployment** is not always as simple as **installation** and **run**—sometimes you also have to consider **networking** issues. This post introduces how to let a service running in a **Kubernetes cluster** retrieve a request’s **source (client) IP**.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>A service generally relies on some input information. If that input does not depend on the **5-tuple** (source IP, source port, destination IP, destination port, protocol), then the service has **low coupling with the network** and does not need to care about networking details.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Therefore, most people don’t need to read this article. If you are interested in networking or want to broaden your horizons, please keep reading and learn about more service scenarios.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>This article is based on Kubernetes `v1.29.4`. Some statements mix “Pod” and “Endpoint”; in the scenario described here they can be treated as equivalent.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>**If</span><span class=w> </span><span class=l>you spot any mistakes, let me know and I will promptly correct them.**</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## Why is source-IP information lost?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Let’s first clarify what source IP means. When A sends a request to B and B forwards that request to C, even though C’s IP layer says the source IP is B, **this article considers A’s IP** to be the source IP.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>There are two main reasons the original source information is lost</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>1</span><span class=l>. **Network Address Translation (NAT)**, whose goals are to conserve public IPv4 addresses and implement load balancing, etc. It will cause the server to see the **NAT device’s IP** instead of the true source IP.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>1</span><span class=l>. **Proxy**, including **Reverse Proxy (RP)** and **Load Balancer (LB)**; the article below refers to them collectively as **proxy servers**. Such proxies forward requests to back-end services but replace the source IP with their own.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>NAT in short **trades port space for IP address space**; IPv4 addresses are limited. One IP address can map to 65,535 ports, and most of the time those ports are not exhausted, so multiple private subnet IPs can share a single public IP, distinguished on ports. The mapping form is</span><span class=p>:</span><span class=w> </span><span class=l>`public IP:public port → private IP_1:private port`—consult [Network Address Translation](https://www.google.com/search?q=network+address+translation) for more.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>A proxy is intended to **hide or expose**. It forwards a request to a back-end service and simultaneously replaces the source IP with its own, thereby concealing the back-end service’s real IP and protecting the back-end service’s security. The proxy usage pattern is</span><span class=p>:</span><span class=w> </span><span class=l>`client IP → proxy IP → server IP`—consult [proxy](https://www.google.com/search?q=proxy) for more.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>**NAT**</span><span class=w> </span><span class=l>and **proxy servers** are both very common, so most services never obtain the request’s source IP.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>_These are the two most common ways the source IP is altered; feel free to add others._</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## How to preserve the source IP?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Below is an example `HTTP request`</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Field             | Length (bytes) | Bit offset | Description                                                |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| ----------------- | -------------- | ---------- | ---------------------------------------------------------- |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| **IP Header**     |                |            |                                                            |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| `Source IP`       | 4              | 0–31       | Sender’s IP address                                        |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Destination IP    | 4              | 32–63      | Receiver’s IP address                                      |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| **TCP Header**    |                |            |                                                            |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Source Port       | 2              | 0–15       | Sender’s port                                              |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Destination Port  | 2              | 16–31      | Receiver’s port                                            |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Sequence Number   | 4              | 32–63      | Identifies the data the sender is sending in the stream    |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| ACK Number        | 4              | 64–95      | If ACK flag set, next expected sequence number             |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Data Offset       | 4              | 96–103     | Bytes from start of TCP header to start of data            |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Reserved          | 4              | 104–111    | Unused, always 0                                           |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Flags             | 2              | 112–127    | Control flags like SYN, ACK, FIN, etc.                     |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Window Size       | 2              | 128–143    | Amount of data receiver can accept                         |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Checksum          | 2              | 144–159    | Error-detection code                                       |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Urgent Pointer    | 2              | 160–175    | Offset of urgent data (if URG flag set)                    |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Options           | variable       | 176–...    | May contain timestamps, MSS, etc.                          |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| **HTTP Header**   |                |            |                                                            |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Request Line      | variable       | ...        | Request method, URI, HTTP version                        |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| `Header Fields`   | variable       | ...        | Headers such as Host, User-Agent, etc.                     |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Blank Line        | 2              | ...        | Separates headers from body                                |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>| Body              | variable       | ...        | Optional request/response body                             |</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Looking at the HTTP request structure above, we see that **TCP Options**, **Request Line**, **Header Fields**, and **Body** are variable.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=cp>**TCP</span><span class=w> </span><span class=l>Options** have limited space and normally are **not** used to carry the source IP.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=cp>**Request</span><span class=w> </span><span class=l>Line** has a fixed semantic and cannot be extended.  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=cp>**HTTP</span><span class=w> </span><span class=l>Body** will be encrypted and therefore cannot be modified mid-path.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Thus **HTTP header fields** are the only extensible place to carry the source IP.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>We can add an `X-REAL-IP` header at a proxy to convey the source IP. The **proxy server** is then supposed to forward the request to a back-end service so that the back-end can read the source IP from this header.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Note that the proxy must sit **before** any NAT device so it can obtain the real client IP. We see Alibaba Cloud treats its [Load Balancer](https://slb.console.aliyun.com/overview) as a separate product that sits differently in the network from ordinary application servers.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>## K8s hands-on instructions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>We deploy the [whoami](https://github.com/traefik/whoami) project to show how.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>### Create a Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>First create the service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>```yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/traefik/whoami:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></div><p>This step creates a <strong>Deployment</strong> containing 3 <strong>Pods</strong>; each Pod has one container running the <strong>whoami</strong> service.</p><h3 id=create-a-service>Create a Service</h3><p>We can create a <strong>NodePort</strong> or <strong>LoadBalancer</strong> Service to enable external access, or a <strong>ClusterIP</strong> Service for intra-cluster access plus an <strong>Ingress</strong> resource to expose it externally.</p><p><strong>NodePort</strong> can be reached as <strong>NodeIP:NodePort</strong> or via an <strong>Ingress</strong>. We use a <strong>NodePort</strong> for simplicity here.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>After creation, a <code>curl whoami.example.com:30002</code> shows the returned IP is the <strong>NodeIP</strong>, not the client’s source IP.</p><blockquote><p>Note that this is not the true client IP; those are cluster-internal IPs. The flow:</p><ul><li>Client sends packet to <code>node2:nodePort</code></li><li>node2 performs SNAT, replacing the source IP with its own</li><li>node2 swaps the destination IP to the Pod IP</li><li>packet is routed to node1, then to the endpoint</li><li>Pod reply is routed back to node2</li><li>Pod reply is sent back to the client</li></ul></blockquote><p>Diagram:</p><p><img src=https://s2.loli.net/2024/05/27/fDg2tBx5FIcGMZN.png alt></p><h4 id=configure-externaltrafficpolicy-local>Configure <code>externalTrafficPolicy: Local</code></h4><blockquote><p>To avoid the above, Kubernetes has a feature that preserves the client’s source IP.<br>If you set service.spec.externalTrafficPolicy to Local, kube-proxy only proxies traffic to locally running endpoints and will not forward it to other nodes.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>Now <code>curl whoami.example.com:30002</code> will show the real client IP <strong>as long as</strong> the DNS record for <code>whoami.example.com</code> <strong>contains only the IPs of nodes that actually host the Pods/Endpoints</strong>.<br>Requests hitting any other node will time out.</p><p>This setup <strong>has a cost</strong>: you lose in-cluster load-balancing capability; requests reach Pods <strong>only if the client hits the exact node</strong> that runs the Endpoint.</p><p><img src=https://s2.loli.net/2024/05/27/PCgiTLF28XE4RKx.png alt="Access Limit Path"></p><p>If the client hits Node 2, no response is returned.</p><h3 id=create-an-ingress>Create an Ingress</h3><p>Most published services use <strong>http/https</strong>, and <code>https://IP:Port</code> feels odd to users.<br>We normally put an <strong>Ingress</strong> in front to front-end the previous NodePort Service onto the <strong>standard ports 80/443</strong> of a domain.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>external-lb-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>whoami.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>Apply it and test:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@client:~# curl whoami.example.com
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>RemoteAddr: 10.42.1.10:56482
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@worker:~# kubectl get -n ingress-nginx pod -o wide
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE          NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>ingress-nginx-controller-c8f499cfc-xdrg7   1/1     Running   <span class=m>0</span>          3d2h   10.42.1.10   k3s-agent-1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>When we <strong>Ingress</strong> proxy the <strong>NodePort</strong> service, we have <strong>two layers of Service</strong> in front of the Endpoint.<br>Diagram difference:</p><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:80| B(Ingress)
    B --&gt;|10.43.38.129:32123| C[Service]
    C --&gt;|10.42.1.1:8080| D[Endpoint]</pre><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:30001| B(Service)
    B --&gt;|10.42.1.1:8080| C[Endpoint]</pre><p>In path 1, when outside traffic hits Ingress, the first endpoint that receives it is the <code>Ingress Controller</code>, and only then the eventual <strong>whoami</strong> endpoint.<br>The <strong>Ingress Controller</strong> itself is essentially a <strong>LoadBalancer</strong> service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl -n ingress-nginx get svc
</span></span><span class=line><span class=cl>NAMESPACE           NAME              TYPE           CLUSTER-IP      EXTERNAL-IP                          PORT<span class=o>(</span>S<span class=o>)</span>                      AGE
</span></span><span class=line><span class=cl>ingress-nginx       ingress-nginx     LoadBalancer   10.43.38.129    172.16.0.57,...                     80:32123/TCP,443:31626/TCP   10d
</span></span></code></pre></div><p>Thus we can apply the same idea, setting <code>externalTrafficPolicy</code> on the <strong>Ingress Controller’s</strong> Service to <strong>preserve the original source IP</strong>.</p><p>Additionally, we set <code>use-forwarded-headers: true</code> in the <code>ingress-nginx-controller</code> ConfigMap so that the Ingress controller understands the <code>X-Forwarded-For</code>/<code>X-Real-IP</code> headers.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allow-snippet-annotations</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compute-full-forwarded-for</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>use-forwarded-headers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-real-ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forwarded-for-header</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;X-Real-IP&#34;</span><span class=w>  </span><span class=c># X-Real-IP or X-Forwarded-For</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx-controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span></code></pre></div><p>The difference between <strong>NodePort</strong> and <strong>ingress-nginx-controller</strong> Services mainly lies in that NodePort back-ends <strong>are not</strong> scheduled on every node, whereas ingress-nginx-controller back-ends <strong>are</strong> scheduled on every node that exposes external traffic.</p><p>Therefore, unlike NodePort where <code>externalTrafficPolicy: Local</code> causes cross-node requests to fail, Ingress can add headers before proxying, achieving both <strong>source IP preservation</strong> and <strong>load balancing</strong>.</p><h2 id=summary>Summary</h2><ul><li><strong>NAT</strong>, <strong>Proxy</strong>, <strong>Reverse Proxy</strong>, and <strong>Load Balancing</strong> can all cause loss of the original client IP.</li><li>To prevent loss, a proxy can place the real IP into the HTTP header field <code>X-REAL-IP</code> before forwarding. In a multi-layer proxy setup you can use <code>X-Forwarded-For</code>; it records the source IP and <em>list</em> of proxy IPs in a <strong>stack</strong> fashion.</li><li>Setting <code>externalTrafficPolicy: Local</code> on a <strong>NodePort</strong> Service retains the original client IP, but removes the load-balancing capability across cluster nodes.</li><li>Under the premise that <strong>ingress-nginx-controller</strong> is deployed on every load-balancer-role node via a <strong>DaemonSet</strong>, setting <code>externalTrafficPolicy: Local</code> on its Service <strong>preserves the original source IP while retaining load balancing</strong>.</li></ul><h2 id=references>References</h2><ul><li><a href=https://kubernetes.io/docs/tutorials/services/source-ip/>Kubernetes Source IP</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/>Ingress-Nginx Controller: ConfigMap</a></li><li><a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/>Ingress Controllers</a></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-857631a5064344e9263a6a91ebeb1959></h1><div class="td-byline mb-4"></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>layout: blog
</span></span><span class=line><span class=cl>title: Detailed Explanation of Qiniu&#39;s Free Services
</span></span><span class=line><span class=cl>linkTitle: Detailed Explanation of Qiniu&#39;s Free Services
</span></span><span class=line><span class=cl>categories: Tutorial
</span></span><span class=line><span class=cl>tags: [Tutorial, Cloud Services]
</span></span><span class=line><span class=cl>date: 2024-06-28 15:33:53 +0800
</span></span><span class=line><span class=cl>draft: true
</span></span><span class=line><span class=cl>toc: true
</span></span><span class=line><span class=cl>toc_hide: false
</span></span><span class=line><span class=cl>math: false
</span></span><span class=line><span class=cl>comments: false
</span></span><span class=line><span class=cl>giscus_comments: true
</span></span><span class=line><span class=cl>hide_summary: false
</span></span><span class=line><span class=cl>hide_feedback: false
</span></span><span class=line><span class=cl>description: 
</span></span><span class=line><span class=cl>weight: 100
</span></span><span class=line><span class=cl>---
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> Detailed Explanation of Qiniu&#39;s Free Services
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Qiniu provides free object storage services, which are very suitable for image hosting for unknown small blogs. They offer the following free services:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>-</span> Storage: 0 - 10 GB free
</span></span><span class=line><span class=cl><span class=k>-</span> Traffic
</span></span><span class=line><span class=cl>  <span class=k>-</span> CDN back-to-origin traffic: 0 - 10 GB free
</span></span><span class=line><span class=cl><span class=k>-</span> Data retrieval: Free
</span></span><span class=line><span class=cl><span class=k>-</span> Requests
</span></span><span class=line><span class=cl>  <span class=k>-</span> PUT/DELETE: 0 - 100,000 times free
</span></span><span class=line><span class=cl>  <span class=k>-</span> GET: 0 - 1,000,000 times free
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>After the first use, I was charged. Upon checking the detailed bill, I found that the charges were for <span class=gs>**outbound internet traffic**</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>![<span class=nt>picture 4</span>](<span class=na>https://s2.loli.net/2023/05/06/eIQwtqmz2osb3KX.png</span>)  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This is the [<span class=nt>detailed billing method</span>](<span class=na>https://www.qiniu.com/prices/kodo</span>) for Qiniu Object Storage.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>And detailed explanation: [<span class=nt>Metering and Billing Items</span>](<span class=na>https://developer.qiniu.com/kodo/6379/metering-and-billing</span>)
</span></span><span class=line><span class=cl><span class=k>
</span></span></span><span class=line><span class=cl><span class=k>&gt; </span><span class=ge>- Outbound internet traffic: Downstream traffic generated when browsing data over the internet or downloading object storage data to local
</span></span></span><span class=line><span class=cl><span class=ge></span><span class=k>&gt; </span><span class=ge>- CDN back-to-origin traffic: Back-to-origin traffic generated when browsing or downloading object storage data through Qiniu Cloud&#39;s CDN service
</span></span></span><span class=line><span class=cl><span class=ge></span><span class=k>&gt; </span><span class=ge>- Cross-region synchronization traffic: Outbound traffic generated when synchronizing data from the source Bucket to the target Bucket through cross-region synchronization function
</span></span></span><span class=line><span class=cl><span class=ge></span>
</span></span><span class=line><span class=cl>To avoid being charged for this part, you should prioritize using the CDN service.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>After using CDN, you face a very important question: whether the website uses HTTPS. Currently, HTTPS has become a mandatory requirement for browsers - any website not using HTTPS will be marked as insecure, which greatly affects visitor experience. HTTPS has become the de facto standard, and every website planning for long-term operation should use HTTPS.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Qiniu has a <span class=gs>**very malicious**</span> trap here: <span class=gs>**Usage generated by HTTPS domains is not included in the free quota**</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>![<span class=nt>picture 5</span>](<span class=na>https://s2.loli.net/2023/05/06/e8jEXmquzYhgnFL.png</span>)  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>This means that CDN&#39;s free traffic is limited to HTTP only, and no free HTTPS traffic is provided.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>More detailed documentation is here: [<span class=nt>CDN Product Pricing Description</span>](<span class=na>https://developer.qiniu.com/fusion/6843/cdn-product-pricing</span>)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gs>**The documentation is very clear - only HTTP traffic is free for 10GB, HTTPS traffic is not free.**</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>And <span class=sb>`after enabling HTTPS configuration for a domain, all traffic under that domain (including both HTTPS and HTTP requests) will be charged according to HTTPS protocol pricing`</span>, which means if your website supports both HTTP and HTTPS, all traffic will be charged.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>So can we embed non-HTTPS links in HTTPS web pages? It&#39;s very clear that this is not allowed.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Reference blog post: [<span class=nt>Protecting users from insecure downloads in Google Chrome</span>](<span class=na>https://blog.chromium.org/2020/02/protecting-users-from-insecure.html</span>)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>When a website uses both HTTPS and HTTP resources, such as introducing HTTP images, CSS, JavaScript files in an HTTPS website, the browser will show a &#34;Mixed Content&#34; error because HTTP resources can be easily exploited by malicious attackers. The solution is to load all resources using HTTPS.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>-</span> HTTPS protocol websites do not allow HTTP protocol requests
</span></span><span class=line><span class=cl><span class=k>-</span> HTTP protocol websites allow access to HTTPS protocol resources
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The traffic service in Qiniu&#39;s free services only includes HTTP CDN back-to-origin traffic. This type of traffic can almost only be used in development and testing environments, or only serves personal HTTP websites.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>I have to admire Qiniu&#39;s engineers and product managers for their understanding of the business - they were ultimately waiting here. Indeed, there&#39;s no such thing as a free lunch.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Through this glimpse of the corporate culture, I recommend abandoning Qiniu&#39;s so-called free services and instead using OSS services from other providers.
</span></span></code></pre></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/jqknono aria-label=Telegram><i class="fab fa-telegram"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/jqknono aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2015&ndash;2025
<span class=td-footer__authors>jqknono</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><script src=/js/main.min.bf0cab613e991fc11bc28a4a07b0aedef47c7c7c2595703ac3adf962fd6a8099.js integrity="sha256-vwyrYT6ZH8EbwopKB7Cu3vR8fHwllXA6w635Yv1qgJk=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>