<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en-us class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://blog.jqknono.com/en-us/blog/programmer/network/><link rel=alternate type=application/rss+xml href=https://blog.jqknono.com/en-us/blog/programmer/network/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Network | Nono Blogs</title><meta name=description content="Network Network Bypass firewall [wireguard对抗运营商] Network troubleshooting [linux网络问题定位] [windows网络问题定位]"><meta property="og:url" content="https://blog.jqknono.com/en-us/blog/programmer/network/"><meta property="og:site_name" content="Nono Blogs"><meta property="og:title" content="Network"><meta property="og:description" content="Network Network Bypass firewall [wireguard对抗运营商] Network troubleshooting [linux网络问题定位] [windows网络问题定位]"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Network"><meta itemprop=description content="Network Network Bypass firewall [wireguard对抗运营商] Network troubleshooting [linux网络问题定位] [windows网络问题定位]"><meta itemprop=datePublished content="2024-11-13T13:05:00+08:00"><meta itemprop=dateModified content="2024-11-13T13:05:00+08:00"><meta itemprop=wordCount content="9"><meta itemprop=keywords content="Network"><meta name=twitter:card content="summary"><meta name=twitter:title content="Network"><meta name=twitter:description content="Network Network Bypass firewall [wireguard对抗运营商] Network troubleshooting [linux网络问题定位] [windows网络问题定位]"><link rel=preload href=/scss/main.min.0f2fa9571091c9ef7d3c35d7a3f7d09da4f49c5c7013a6ea9a0a80d216151751.css as=style integrity="sha256-Dy+pVxCRye99PDXXo/fQnaT0nFxwE6bqmgqA0hYVF1E=" crossorigin=anonymous><link href=/scss/main.min.0f2fa9571091c9ef7d3c35d7a3f7d09da4f49c5c7013a6ea9a0a80d216151751.css rel=stylesheet integrity="sha256-Dy+pVxCRye99PDXXo/fQnaT0nFxwE6bqmgqA0hYVF1E=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3FFTG72NE"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3FFTG72NE")}</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9457787069079604" crossorigin=anonymous></script></head><body class="td-section td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/en-us/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Nono Blogs</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/en-us/docs/><i class='fas fa-book'></i><span>Docs</span></a></li><li class=nav-item><div class="td-lang-menu dropdown"><a class="nav-link dropdown-toggle td-lang-menu__title" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class=td-lang-menu__title-text>English</span>
<span class=td-lang-menu__title-code>EN-US</span></a><ul class=dropdown-menu><li><span class="dropdown-item active">English</span></li><li><a class=dropdown-item href=/blog/programmer/network/>简体中文</a></li><li><span class="dropdown-item disabled">繁體中文</span></li><li><span class="dropdown-item disabled">日本語</span></li><li><span class="dropdown-item disabled">한국어</span></li><li><span class="dropdown-item disabled">العربية</span></li><li><span class="dropdown-item disabled">العربية</span></li><li><span class="dropdown-item disabled">Deutsch</span></li><li><span class="dropdown-item disabled">Español</span></li><li><span class="dropdown-item disabled">Français</span></li><li><span class="dropdown-item disabled">हिंदी</span></li><li><span class="dropdown-item disabled">Bahasa Indonesia</span></li><li><span class="dropdown-item disabled">Italiano</span></li><li><span class="dropdown-item disabled">Nederlands</span></li><li><span class="dropdown-item disabled">Polski</span></li><li><span class="dropdown-item disabled">Português</span></li><li><span class="dropdown-item disabled">Русский</span></li><li><span class="dropdown-item disabled">Türkçe</span></li></ul></div></li><li class=nav-item><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.5f8ffa01e3c71cde1a5cd3dba1f560f6.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/en-us/blog/programmer/network/>Return to the regular view of this page</a>.</p></div><h1 class=title>Network</h1><ul><li><a href=#pg-20c5c67efd6f1c5330fc1fdaaa2d3511>A Few Ways to Safely Use Public IPv6</a></li><li><a href=#pg-d0c8bf9a84e7bd53f54d296a8bba5216>Using Common DDNS Subdomains May Cause China Telecom Broadband Service Degradation</a></li><li><a href=#pg-7b073c189bd96532e8ec1745b2035366>Compliance Discussion of Reverse Proxy in Home Networks</a></li><li><a href=#pg-9f33db10d188dabb121b57e8f553b6ce>Some Characteristics of China Telecom IPv6</a></li><li><a href=#pg-dc89a1e4586849dfad4414cb230f7db4>Why we should not think of UDP in terms of TCP</a></li><li><a href=#pg-ff3ca18908624a0efa9c7071237da99a>Troubleshooting Linux Network Issues</a></li><li><a href=#pg-6147d5368d4d001498e0b3ce634999ea>How to Improve Network Experience with a Self-Hosted DNS Service</a></li><li><a href=#pg-875f5a75893e4ebbdef3ca88aa5b5475>Bypassing ChatGPT VPN Detection</a></li></ul><div class=content><ul><li><input disabled type=checkbox> Network</li></ul><h1 id=network>Network</h1><ul><li>Bypass firewall<ul><li>[<a href=wireguard%E5%AF%B9%E6%8A%97%E8%BF%90%E8%90%A5%E5%95%86 title=wireguard对抗运营商>wireguard对抗运营商</a>]</li></ul></li><li>Network troubleshooting<ul><li>[<a href=linux%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D title=linux网络问题定位>linux网络问题定位</a>]</li><li>[<a href=windows%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D title=windows网络问题定位>windows网络问题定位</a>]</li></ul></li></ul></div></div><div class=td-content><h1 id=pg-20c5c67efd6f1c5330fc1fdaaa2d3511>A Few Ways to Safely Use Public IPv6</h1><div class="td-byline mb-4"><time datetime=2025-02-28 class=text-body-secondary>Friday, February 28, 2025</time></div><p>Some people need to “go home” via public IPv6. Unlike Tailscale/Zerotier et al., which rely on NAT traversal to create direct tunnels, native IPv6 offers a straight-through connection. Cellular networks almost always hand out global IPv6 addresses, so “going home” is extremely convenient.</p><p>I previously posted <a href=https://www.v2ex.com/t/1112630>Using Common DDNS Sub-domains on Home Broadband May Downgrade Telecom Service</a> describing a pitfall with IPv6: domains get crawled. Exposing your domain is basically the same as exposing your IPv6 address. Once scanners find open services and inbound sessions pile up, the ISP may silently throttle or downgrade your line.</p><p>That thread mentioned domain scanning but not <em>cyberspace scanning</em>—which ignores whatever breadcrumbs you leave and just brute-forces entire address blocks. This is much harder to defend against.</p><p><em>Cyberspace scanning</em> usually includes the following steps:</p><ul><li><strong>Host-alive detection</strong> using ARP, ICMP, or TCP to list responsive IPs.</li><li><strong>Port / service discovery</strong> to enumerate open ports and identify service names, versions, and OS signatures.</li><li><strong>Operating-system fingerprinting</strong> by analyzing packet replies.</li><li><strong>Traffic collection</strong> to spot anomalies or attack patterns.</li><li><strong>Alias resolution</strong> mapping multiple IPs to the same router.</li><li><strong>DNS recon</strong> reverse-resolving IPs to domain names.</li></ul><p>Below are a few methods to stay off those scanners:</p><ol><li>Have your internal DNS server never return AAAA records.</li><li>Allow internal services to be reached only via domain names, never by raw IP.</li><li>Use a private DNS service such as <a href=https://www.adguardprivate.com>AdGuardPrivate</a>.</li></ol><h2 id=prevent-aaaa-records-on-the-internal-dns>Prevent AAAA Records on the Internal DNS</h2><p>When you browse the web, every outbound connection can leak your source IPv6. If a firewall isn’t in place, that address enters the scanners’ high-priority IP pools.</p><p>Even scanning only the last 16 bits of a <code>/56</code> prefix becomes a smaller task once the prefix is leaked.</p><p>After years of IPv6 use, I have seen no practical difference between IPv6 and IPv4 for day-to-day browsing. So we can sacrifice IPv6 for outbound traffic and reserve it solely for “go home” access.</p><h3 id=how-to-block-aaaa-records>How to block AAAA records</h3><p>Configure your internal DNS resolver to drop all AAAA answers.</p><p>Most home setups run AdGuard Home—see the screenshot:</p><p><img src=https://img1.techfetch.dev/blog/202502281307671.png alt="Disable IPv6"></p><p>Once applied, local devices reach the outside world over IPv4 only.</p><h2 id=never-expose-services-by-ip>Never Expose Services by IP</h2><p>Exposing a service on a naked port makes discovery trivial. When you start a service, avoid binding to <code>0.0.0.0</code> and <code>::</code>; almost every tutorial defaults to <code>127.0.0.1</code> plus <code>::1</code> for good reason—listening on public addresses is risky.</p><h3 id=reverse-proxy-only-by-domain-name>Reverse-proxy only by domain name</h3><h4 id=nginx-example>nginx example</h4><p>Set <code>server_name</code> to an actual hostname instead of <code>_</code> or an IP.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>server_name</span> <span class=s>yourdomain.com</span><span class=p>;</span> <span class=c1># replace with your real domain
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1># 403 for anything not the correct hostname
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>if</span> <span class=s>(</span><span class=nv>$host</span> <span class=s>!=</span> <span class=s>&#39;yourdomain.com&#39;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>return</span> <span class=mi>403</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>root</span> <span class=s>/path/to/your/web/root</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>index</span> <span class=s>index.html</span> <span class=s>index.htm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># additional config...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><h4 id=iis-example>IIS example</h4><p>Remember to specify the exact hostname—never leave the host field blank.</p><p><img src=https://img1.techfetch.dev/blog/202502281323570.png alt="IIS demo"></p><h3 id=use-a-private-dns-service>Use a private DNS service</h3><p>Create spoofed hostnames that resolve only inside your own DNS.</p><p><img src=https://img1.techfetch.dev/blog/202502281330658.png alt="DNS rewrites"></p><p>Benefits:</p><ul><li>Hostnames can be <em>anything</em>—no need to buy a public domain.</li><li>If a fake hostname leaks, the attacker still has to point their DNS resolver at your private server.</li><li>Scanning the IP alone is useless: one must also (a) know the fake name, (b) set their resolver to <em>your</em> DNS, (c) include that name in each request’s Host header. All steps have to succeed.</li></ul><pre class=mermaid>sequenceDiagram
  participant Scanner as Scanner
  participant DNS as Private DNS
  participant Service as Internal Service

  Scanner-&gt;&gt;DNS: 1. Find private DNS address
  Scanner-&gt;&gt;DNS: 2. Query fake hostname
  DNS--&gt;&gt;Scanner: 3. Return internal IP
  Scanner-&gt;&gt;Service: 4. Construct Host header
  Note right of Service: Denied if Host ≠ fake hostname
  alt Correct Host
    Service--&gt;&gt;Scanner: 5a. Response
  else Wrong Host
    Service--&gt;&gt;Scanner: 5b. 403
  end</pre><p>This significantly increases the scanning cost.</p><p>You can deploy AdGuardPrivate (almost a labeled AdGuard Home) or Tencent’s dnspod purely for custom records. Functionality differs, so evaluate accordingly.</p><h2 id=summary>Summary</h2><ol><li><p>Prevent the internal DNS from returning AAAA records</p><ul><li>Pre-reqs<ul><li>Public IPv6 prefix</li><li>Internal DNS resolver</li></ul></li><li>Steps<ul><li>Drop AAAA answers</li></ul></li></ul></li><li><p>Reach internal services only via domain names</p><ul><li>Pre-reqs<ul><li>You own a domain</li><li>Registrar supports DDNS</li><li>Local reverse proxy already running</li></ul></li><li>Steps<ul><li>Enable DDNS task</li><li>Host-based access only</li></ul></li></ul></li><li><p>Spin up a private DNS</p><ul><li>Pre-reqs<ul><li>Private DNS service with custom records and DDNS</li></ul></li><li>Steps<ul><li>Enable DDNS task</li><li>Map fake hostnames to internal services</li></ul></li></ul></li></ol><p>Finally:</p><ul><li>Tailscale/Zerotier that successfully punch through are still the simplest and safest way to go home.</li><li>Don’t hop on random Wi-Fi—you’ll give everything away in one shot. Grab a big-data SIM and keep your faith with the carrier for now. (Cheap high-traffic SIM? DM me. Not really.)</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d0c8bf9a84e7bd53f54d296a8bba5216>Using Common DDNS Subdomains May Cause China Telecom Broadband Service Degradation</h1><div class="td-byline mb-4"><time datetime=2025-02-19 class=text-body-secondary>Wednesday, February 19, 2025</time></div><p>I have been troubleshooting IPv6 disconnections and hole-punching failures for over three months. I’ve finally identified the root cause; here’s the story.</p><h2 id=my-first-post-asking-for-helpipv6-disconnections>My First Post Asking for Help—IPv6 Disconnections</h2><p>IPv6 had been working perfectly. Without touching any settings, and even though every device had its own IPv6, it suddenly lost IPv6 connectivity entirely.</p><p><code>curl 6.ipw.cn</code> returned nothing, and both <code>ping6</code> and <code>traceroute6 2400:3200::1</code> failed.</p><p>My ONT was bridged to the router, and I could still obtain the router’s own IPv6—one that could still reach the IPv6 Internet.</p><p>I received a <code>/56</code> prefix, and all downstream devices received addresses within <code>240e:36f:15c3:3200::/56</code>, yet none could reach any IPv6 site.</p><p>I suspected the ISP had no route for <code>240e:36f:15c3:3200::</code>, but I couldn’t prove it.</p><p>Someone suggested excessive PCDN upload traffic was the culprit, but upload volume was minimal and PCDN wasn’t enabled.</p><p>Another possibility was that using Cloudflare and Aliyun ESA reverse proxies had caused it.</p><h2 id=my-second-postfinding-a-direct-cause>My Second Post—Finding a Direct Cause</h2><p>I confirmed that at least some regions of China Telecom will downswitch service when they see many inbound IPv6 HTTP/HTTPS connections, manifesting as:</p><ul><li><em>Fake IPv6</em>: You still get a <code>/56</code>, every device keeps its IPv6, but traceroute lacks a route, so IPv6 is de-facto unusable.</li><li><em>Fake hole- punch</em>: Tailscale reports its connection is direct, yet latency is extreme and speed is terrible.</li></ul><p>Every time I disabled Cloudflare/Aliyun ESA proxying and rebooted the router a few times, both real IPv6 connectivity and true direct Tailscale worked again.</p><h2 id=still-disconnects-after-disabling-reverse-proxy>Still Disconnects After Disabling Reverse Proxy</h2><p>Even with proxy/CDN disabled—complete direct origin access—I still had occasional outages lasting hours.</p><p>Perhaps my domain had leaked, or bots were scanning popular subdomains with a steady HTTP attack.</p><p>When I disabled DNS resolution for the DDNS hostname outright, IPv6 came back after a while, and Tailscale hole-punching was again direct and stable.</p><p>Since then those disconnections never returned.</p><h2 id=my-final-recommendation>My Final Recommendation</h2><p>Avoid using commonplace DDNS subdomains, such as:</p><ul><li>home.example.com</li><li>nas.example.com</li><li>router.example.com</li><li>ddns.example.com</li><li>cloud.example.com</li><li>dev.example.com</li><li>test.example.com</li><li>webdav.example.com</li></ul><p>I had used several of these; it seems they are continuously scanned by bots. The resulting flood of requests triggered China Telecom’s degradation policy, making my IPv6 unusable and blocking hole-punching.</p><p>As you already know, hiding your IP matters in network security; the same goes for protecting the domain you use for DDNS—that domain exposes your IP as well.</p><p>If you still need public services, you have two practical choices:</p><ol><li><strong>Proxy/Front-end relay</strong>—traffic hits a VPS first, then your home server. Latency and bandwidth suffer because traffic takes a detour.</li><li><strong>DDNS direct</strong>—everything connects straight to you. Performance is much better; this is what I recommend. For personal use the number of connections rarely hits the limit, but once the domain becomes public the bots will ramp it up quickly.</li></ol><h3 id=proxy-relay-reverse-proxy>Proxy Relay (Reverse Proxy)</h3><h4 id=cloudflare-tunnel>Cloudflare Tunnel</h4><p>Use Cloudflare’s Tunnel so you won’t see the dozens or hundreds of IPs typical of ordinary reverse proxies.</p><h4 id=tailscale-or-zerotier>Tailscale or ZeroTier</h4><p>Build your own VPN, put a VPS in front, and reach your LAN services through the VPN. This avoids excessive simultaneous connections.</p><h3 id=ddns-direct-scheme>DDNS Direct Scheme</h3><h4 id=public-dns>Public DNS</h4><p>Generate a random string—like a GUID—and use it as your DDNS hostname. It’s impossible to remember, but for personal use that’s acceptable. Judge for yourself.</p><h4 id=private-dns>Private DNS</h4><p>Run your own DNS service, e.g.:</p><ul><li><a href=https://www.adguardprivate.com>AdguardPrivate</a></li><li><a href=https://dot.pub>dot.pub</a></li></ul><p>Configure it to serve your DDNS records; only people who can query your private DNS will resolve the custom IP.</p><p>In this model you <em>can</em> use common DDNS names, but take care never to expose the address of your private DNS server.</p><h2 id=afterthought>Afterthought</h2><p>Rumor has it that naming a subdomain <strong>speedtest</strong> might provide a mysterious boost.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7b073c189bd96532e8ec1745b2035366>Compliance Discussion of Reverse Proxy in Home Networks</h1><div class=lead>Exploring potential compliance issues and solutions when using reverse-proxy services on home broadband</div><div class="td-byline mb-4"><time datetime=2025-02-17 class=text-body-secondary>Monday, February 17, 2025</time></div><h1 id=background>Background</h1><p>About 90 days ago, I encountered an IPv6 connectivity issue with China Telecom Hubei. After long-term observation and analysis, here are the findings.</p><h1 id=problem-analysis>Problem Analysis</h1><p>Two initial suspected causes:</p><ol><li><p>PCDN usage detection</p><ul><li>No active use of PCDN</li><li>Only a small amount of BitTorrent downloads</li><li>Upload throttling has been applied, yet the problem persists</li></ul></li><li><p>Home server acting as blog origin</p><ul><li>Uses Cloudflare origin rules specifying a port</li><li>May be deemed “commercial behavior” by the ISP</li></ul></li></ol><p>After three months of validation, the issue is more likely triggered by exposing HTTP/HTTPS service ports to the public Internet.</p><h1 id=specific-symptoms>Specific Symptoms</h1><ol><li><p>IPv6 anomalies:</p><ul><li>/56 prefix is assigned</li><li>Devices receive global IPv6 addresses</li><li>Yet external network access fails</li><li>Only the router in bridge mode behind the optical modem retains normal IPv6</li></ul></li><li><p>Tailscale connection anomalies:</p><ul><li>The source server reports direct connectivity but with excessive latency (~400 ms)</li><li>Other devices go through relays and obtain lower latency (~80 ms)</li></ul></li></ol><h1 id=isp-policy-analysis>ISP Policy Analysis</h1><p>Telecom carriers in certain regions apply service degradation to inbound-heavy HTTP/HTTPS connections:</p><ol><li><p>IPv6 service downgrade</p><ul><li>Addresses are still assigned</li><li>Routing tables are missing</li><li>Effective Internet access is blocked</li></ul></li><li><p>P2P connection throttling</p><ul><li>Tailscale shows direct connections</li><li>Actual latency is abnormally high</li><li>Bandwidth is restricted</li></ul></li></ol><h1 id=solutions>Solutions</h1><ol><li><p>Disable reverse-proxy services:</p><ul><li>Deactivate Cloudflare/Alibaba Cloud ESA reverse proxies</li><li>After multiple router reboots, connectivity returns to normal</li></ul></li><li><p>Prevent domain scanning:
Avoid these common sub-domains:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>- home.example.com
</span></span><span class=line><span class=cl>- ddns.example.com
</span></span><span class=line><span class=cl>- dev.example.com
</span></span><span class=line><span class=cl>- test.example.com
</span></span></code></pre></div></li><li><p>Best practices:</p><ul><li>Use a GUID to generate random sub-domains</li><li>Refrain from predictable or common sub-domain naming</li><li>Rotate domains periodically to reduce scanning risk</li></ul></li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-9f33db10d188dabb121b57e8f553b6ce>Some Characteristics of China Telecom IPv6</h1><div class="td-byline mb-4"><time datetime=2024-06-28 class=text-body-secondary>Friday, June 28, 2024</time></div><ul><li><p><input disabled type=checkbox> Some Characteristics of China Telecom IPv6</p></li><li><p><input disabled type=checkbox> Some Characteristics of China Telecom IPv6</p></li></ul><p>IPv6 has been fully rolled out nationwide; the IPv6 address pool is large enough for each of every individual’s devices to obtain its own IPv6 address.<br>To actually use IPv6 at home, the entire stack of devices must all support IPv6. Because the rollout has been underway for many years, virtually every device bought after 2016 already supports IPv6.</p><p>The full stack includes: metro equipment → community router → home router (ONT/router) → end device (phones, PCs, smart TVs, etc.)</p><p>This article does not discuss the standard IPv6 protocol itself; it focuses only on certain characteristics of China Telecom’s IPv6.</p><h2 id=address-allocation>Address Allocation</h2><p>First, the methods of address assignment. IPv6 offers three ways to obtain an address: static assignment, SLAAC, and DHCPv6.<br>Hubei Telecom uses SLAAC, meaning the IPv6 address is automatically assigned by the device. Because the carrier’s IPv6 pool is enormous, address conflicts are impossible.</p><p>Telecom IPv6 addresses are assigned at random and recycled every 24 h. If you need inbound access, you must use a DDNS service.</p><h2 id=firewall>Firewall</h2><p>At present it can be observed that common ports such as <code>80</code>, <code>139</code>, <code>445</code> are blocked—mirroring the carrier’s IPv4 firewall. This is easy to understand: operator-level firewalls do protect ordinary users who lack security awareness. In 2020, China Telecom IPv6 was fully open, but now certain common ports have been blocked.</p><p>Port <code>443</code> is occasionally accessible within the China Telecom network but blocked for China Mobile and China Unicom. Developers must keep this in mind. A service that works fine in your dev environment—or that your phone on the China Telecom network can reach—may be unreachable from a phone on a different carrier.</p><p>Based on simple firewall testing, developers are strongly advised not to trust operator firewalls. Serve your application on a <strong>five-digit</strong> port.</p><p>Furthermore, China Telecom’s firewall does not block port <code>22</code>, and Windows Remote Desktop port <code>3389</code> is likewise open.<br>Consequently, remote login is possible—introducing obvious risks.</p><p>Once attackers obtain the IP or DDNS hostname, they can start targeted attacks; brute-force password cracking can grant control of the device. The domain name can also reveal personal information—name, address, etc.—and attackers may use social-engineering tactics to gather even more clues to speed up their intrusion.</p><p>It is recommended to disable password authentication for <code>ssh</code> and rely only on key-based login, or to use a VPN, or to employ a jump host for remote access.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-dc89a1e4586849dfad4414cb230f7db4>Why we should not think of UDP in terms of TCP</h1><div class="td-byline mb-4"><time datetime=2024-06-28 class=text-body-secondary>Friday, June 28, 2024</time></div><ul><li><input disabled type=checkbox> Why we should not think of UDP in terms of TCP</li></ul><h1 id=why-we-should-not-think-of-udp-in-terms-of-tcp>Why we should not think of UDP in terms of TCP?</h1><h2 id=structural-differences>Structural Differences</h2><p><img src=https://s2.loli.net/2023/06/30/ndPGpzMRX1L4Q6D.png alt="TCP header"><br><img src=https://s2.loli.net/2023/06/30/ofdBYKb6iqaICA9.png alt="UDP header"></p><p>TCP has many concepts: connection establishment, resource usage, data transfer, reliable delivery, retransmission based on cumulative ACK-SACK, timeout retransmission, checksum, flow control, congestion control, MSS, selective acknowledgements, TCP window scale, TCP timestamps, PSH flag, connection termination.</p><p>UDP has virtually none of these facilities; it is only slightly more capable than the link layer in distinguishing applications. Because UDP is extremely simple, it is extremely flexible.</p><h2 id=if-it-can-happen-it-will>If it can happen, it will</h2><p>Murphy’s law:</p><blockquote><p>If anything can go wrong, it will.</p></blockquote><p>Conventional wisdom suggests that UDP suits games, voice, and video because a few corrupt packets rarely matter. The reason UDP is chosen for these use-cases is not that it is the perfect match, but that there are unsolved problems for TCP that force services to pick the less-featured UDP. Saying “a few corrupt packets do not disturb the service” actually means that TCP worries about packet correctness while UDP does not; UDP cares more about timeliness and continuity. UDP’s defining trait is its indifference to everything TCP considers important—factors that harm real-time performance.</p><p>In code, UDP only needs one socket bound to a port to begin sending and receiving. Usually the socket lifetime matches the port lifetime.</p><p>Therefore, I can use UDP like this:</p><ol><li>Send random datagrams to any IP’s any port and see who replies.</li><li>Alice sends a request from port A to port B of Bob, Bob responds from port C to Alice’s port D.</li><li>Alice same as above, but Bob asks Charlie to answer from port C to Alice’s port D.</li><li>Alice sends a request from port A to port B, but spoofs the source address to Charlie’s address; Bob will reply to Charlie.</li><li>Both sides agree to open ten UDP ports and send as well as receive on each one concurrently.</li></ol><p>Of course none of these patterns can exist in TCP, but in UDP, because they are possible, sooner or later someone will adopt them. Expecting UDP to behave like TCP is therefore idealistic; reality cannot be fully enumerated.</p><p>UDP datagrams are extremely lightweight and highly flexible; the idea of a “connection” does not exist at the protocol level, so you must invent your own notion of a UDP connection. Different definitions were tried, yet none could always unambiguously describe direction from a single datagram; we must accept ambiguity. After all, no official “UDP connection” standard exists—when parties hold different definitions, mismatched behaviours are inevitable.</p><h2 id=udp-from-the-clients-viewpoint>UDP from the client’s viewpoint</h2><p>Voice or video can suffer packet loss, but the loss pattern has very different effects on user experience. For example, losing 30 % of packets evenly or losing 30 % all within half a second produces drastically different experiences; the former is obviously preferable. However, UDP has no built-in flow control to deliberately throttle traffic. Although UDP is often described as “best-effort”, the details of that effort still determine the outcome.</p><h2 id=udp-from-the-providers-viewpoint>UDP from the provider’s viewpoint</h2><p>For TCP attacks, the client must invest computational resources to create and maintain connections—attackers thus incur costs. With UDP, the attacker’s overhead is much lower; if the goal is just to burn server bandwidth, UDP is perfect. Suppose the service buys 100 GB of unmetered traffic but only processes 10 MB/s while accepting 1 GB/s—90 % of the arriving traffic is junk, yet it is still billable. Providers should avoid such situations.</p><h2 id=udp-from-the-isps-viewpoint>UDP from the ISP’s viewpoint</h2><p>End-to-end communication comprises multiple endpoints and transit paths. We usually focus only on client and server viewpoints, but the ISP’s perspective matters too. Under DDoS, we pay attention to server capacity, ignoring the ISP’s own finite resources. The server may ignore useless requests, yet the ISP has already paid to carry them. When we perform stress tests we often report “packet loss”, overlooking that the number reflects loss along the entire path—not just at the server. ISPs drop packets as well. From the ISP’s view, the service purchased 1 MB/s, but the client send rate is 1 GB/s; they both pay nothing for the wasted bandwidth—the ISP bears the cost. To avoid that, ISPs implement UDP QoS. Compared to TCP’s congestion control, ISPs can just drop UDP. In practice the blunt approach is to block traffic on long-lived UDP ports. Field tests of WeChat calls show that each call uses multiple ports with one UDP port talking to six different UDP ports on the same server—likely a countermeasure to ISP port blocks.</p><h2 id=summary>Summary</h2><p>UDP’s flexibility usually means there are several legitimate methods to reach a goal; as long as the program eventually communicates stably, however bizarre it may appear compared with TCP, it is “the way it is”. We therefore cannot force TCP concepts onto UDP. Even when we invent a new “UDP connection” for product design, we must expect and gracefully accept errors—the ability to tolerate errors is UDP’s core feature, an advantage deliberately chosen by the service, not a flaw we have to live with.</p><h2 id=further-reading>Further reading</h2><ul><li><a href=https://cloud.tencent.com/developer/article/1708535>Learning the principles of QoS in 20 000 words</a></li><li><a href=https://en.wikipedia.org/wiki/Transmission_Control_Protocol>Transmission Control Protocol</a></li><li><a href=https://en.wikipedia.org/wiki/User_Datagram_Protocol>User Datagram Protocol</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ff3ca18908624a0efa9c7071237da99a>Troubleshooting Linux Network Issues</h1><div class="td-byline mb-4"><time datetime=2024-05-28 class=text-body-secondary>Tuesday, May 28, 2024</time></div><h2 id=troubleshooting-tools>Troubleshooting Tools</h2><table><thead><tr><th>Tool</th><th>Description</th><th>Usage</th><th>Note</th></tr></thead><tbody><tr><td>ping</td><td>Test network connectivity</td><td>ping baidu.com</td><td></td></tr><tr><td>traceroute</td><td>Route tracing</td><td>traceroute ip</td><td></td></tr><tr><td>route</td><td>Routing table</td><td>route -n</td><td></td></tr><tr><td>netstat</td><td>Network connections</td><td>netstat -ano</td><td></td></tr><tr><td>nslookup</td><td>DNS resolution</td><td>nslookup baidu.com</td><td></td></tr><tr><td>ifconfig</td><td>Network configuration</td><td>ifconfig</td><td></td></tr><tr><td>arp</td><td>ARP cache</td><td>arp -a</td><td></td></tr><tr><td>nbtstat</td><td>NetBIOS</td><td>nbtstat -n</td><td></td></tr><tr><td>netsh</td><td>Network configuration</td><td>netsh</td><td></td></tr><tr><td>net</td><td>Network configuration</td><td>net</td><td></td></tr><tr><td>tcpdump</td><td>Packet capture</td><td>tcpdump</td><td></td></tr><tr><td>wireshark</td><td>Packet capture</td><td>wireshark</td><td></td></tr><tr><td>ip</td><td>Network configuration</td><td>ip addr show</td><td></td></tr><tr><td>ss</td><td>Network connections</td><td>ss -tunlp</td><td></td></tr><tr><td>netstat</td><td>View network connection state</td><td>netstat -anp</td><td></td></tr><tr><td>tcpdump</td><td>Packet-capture utility</td><td>tcpdump -i eth0 -nn -s 0 -c 1000 -w /tmp/tcpdump.pcap</td><td></td></tr><tr><td>iptables</td><td>Firewall</td><td>iptables -L -n -v -t nat -t mangle -t filter</td><td></td></tr><tr><td>ss</td><td>netstat replacement</td><td>ss -anp</td><td></td></tr><tr><td>ifconfig</td><td>View NIC information</td><td>ifconfig eth0</td><td></td></tr><tr><td>ip</td><td>View NIC information</td><td>ip addr show eth0</td><td></td></tr><tr><td>route</td><td>View routing table</td><td>route -n</td><td></td></tr><tr><td>traceroute</td><td>View routing hops</td><td>traceroute <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>ping</td><td>Test network connectivity</td><td>ping <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>telnet</td><td>Test port connectivity</td><td>telnet <a href=https://www.baidu.com>www.baidu.com</a> 80</td><td></td></tr><tr><td>nslookup</td><td>Domain resolution</td><td>nslookup <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>dig</td><td>Domain resolution</td><td>dig <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>arp</td><td>View ARP cache</td><td>arp -a</td><td></td></tr><tr><td>netcat</td><td>Network debugging tool</td><td>nc -l 1234</td><td></td></tr><tr><td>nmap</td><td>Port-scanning tool</td><td>nmap -sT -p 80 <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>mtr</td><td>Network connectivity tester</td><td>mtr <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>iperf</td><td>Network performance tester</td><td>iperf -s -p 1234</td><td></td></tr><tr><td>iptraf</td><td>Network traffic monitor</td><td>iptraf -i eth0</td><td></td></tr><tr><td>ipcalc</td><td>IP address calculator</td><td>ipcalc</td><td></td></tr><tr><td>iftop</td><td>Network traffic monitor</td><td>iftop -i eth0</td><td></td></tr><tr><td>iostat</td><td>Disk I/O monitor</td><td>iostat -x 1 10</td><td></td></tr><tr><td>vmstat</td><td>Virtual memory monitor</td><td>vmstat 1 10</td><td></td></tr><tr><td>sar</td><td>System performance monitor</td><td>sar -n DEV 1 10</td><td></td></tr><tr><td>lsof</td><td>Show open file usage</td><td>lsof -i:80</td><td></td></tr><tr><td>strace</td><td>Trace system calls</td><td>strace -p 1234</td><td></td></tr><tr><td>tcpflow</td><td>Packet-capture tool</td><td>tcpflow -i eth0 -c -C -p -o /tmp/tcpflow</td><td></td></tr><tr><td>tcpick</td><td>Packet-capture tool</td><td>tcpick -i eth0 -C -p -o /tmp/tcpick</td><td></td></tr><tr><td>tcptrace</td><td>Packet-capture tool</td><td>tcptrace -i eth0 -C -p -o /tmp/tcptrace</td><td></td></tr><tr><td>tcpslice</td><td>Packet-capture tool</td><td>tcpslice -i eth0 -C -p -o /tmp/tcpslice</td><td></td></tr><tr><td>tcpstat</td><td>Packet-capture tool</td><td>tcpstat -i eth0 -C -p -o /tmp/tcpstat</td><td></td></tr><tr><td>tcpdump</td><td>Packet-capture tool</td><td>tcpdump -i eth0 -C -p -o /tmp/tcpdump</td><td></td></tr><tr><td>tshark</td><td>Packet-capture tool</td><td>tshark -i eth0 -C -p -o /tmp/tshark</td><td></td></tr><tr><td>wireshark</td><td>Packet-capture tool</td><td>wireshark -i eth0 -C -p -o /tmp/wireshark</td><td></td></tr><tr><td>socat</td><td>Network debugging tool</td><td>socat -d -d TCP-LISTEN:1234,fork TCP:www.baidu.com:80</td><td></td></tr><tr><td>ncat</td><td>Network debugging tool</td><td>ncat -l 1234 -c &rsquo;ncat <a href=https://www.baidu.com>www.baidu.com</a> 80'</td><td></td></tr><tr><td>netperf</td><td>Network performance tester</td><td>netperf -H <a href=https://www.baidu.com>www.baidu.com</a> -l 60 -t TCP_STREAM</td><td></td></tr><tr><td>netcat</td><td>Network debugging tool</td><td>netcat -l 1234</td><td></td></tr><tr><td>nc</td><td>Network debugging tool</td><td>nc -l 1234</td><td></td></tr><tr><td>netpipe</td><td>Network performance tester</td><td>netpipe -l 1234</td><td></td></tr><tr><td>netkit</td><td>Network debugging tool</td><td>netkit -l 1234</td><td></td></tr><tr><td>bridge</td><td>Bridge tool</td><td>bridge -s</td><td></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-6147d5368d4d001498e0b3ce634999ea>How to Improve Network Experience with a Self-Hosted DNS Service</h1><div class="td-byline mb-4"><time datetime=2024-05-18 class=text-body-secondary>Saturday, May 18, 2024</time></div><h2 id=network-quality-vs-network-experience>Network Quality vs. Network Experience</h2><blockquote><p>Do nothing, and you’ll already enjoy the best network experience.</p></blockquote><p>First, note that “network quality” and “network experience” are two different concepts. Communication is a process involving many devices. The upload/download performance of a <strong>single device</strong> can be termed <strong>network quality</strong>, while the end-to-end behavior of the entire communication path is what we call <strong>network experience</strong>.</p><h2 id=measuring-network-quality>Measuring Network Quality</h2><p>Evaluating network quality usually involves several metrics and methods. Common ones include:</p><ol><li><strong>Bandwidth</strong> – the capacity to transfer data, conventionally expressed in bits-per-second. Higher bandwidth generally indicates better quality.</li><li><strong>Latency</strong> – the time a packet takes to travel from sender to receiver. Lower latency means faster response.</li><li><strong>Packet-loss rate</strong> – the proportion of packets lost en route. A lower rate suggests higher quality.</li><li><strong>Jitter</strong> – variability in packet arrival times. Smaller jitter means a more stable network.</li><li><strong>Throughput</strong> – the actual data volume successfully transported in a given period.</li><li><strong>Network topology</strong> – the physical or logical arrangement of network nodes; good design improves quality.</li><li><strong>Quality-of-Service (QoS)</strong> – techniques such as traffic shaping and priority queues that ensure acceptable service levels.</li><li><strong>Protocol analysis</strong> – examining traffic with tools like Wireshark to diagnose bottlenecks or errors.</li></ol><p>Combined, these indicators give a complete picture of network performance and improvement opportunities. Carriers need these details, but ordinary users often need only a decently priced modern router—today’s devices auto-tune most of these knobs.</p><h2 id=measuring-network-experience>Measuring Network Experience</h2><p>The first factor is <strong>reachability</strong>—being able to connect at all. A DNS service must therefore be:</p><ul><li>Comprehensive: its upstream resolvers should be authoritative and able to resolve the largest possible set of names.</li><li>Accurate: results must be correct and free from hijacking or pollution returning advertisement pages.</li><li>Timely: when an IP changes, the resolver must return the fresh address, not a stale record.</li></ul><p>Next comes the <strong>network quality</strong> of the resolved IP itself.</p><p>Because service quality <strong>varies strongly with region</strong>, servers geographically closer to the client often offer better performance.</p><p>Most paid DNS providers support Geo-aware records. For example, Alibaba Cloud allows:</p><blockquote><p>(1) Carrier lines: Unicom, Telecom, Mobile, CERNet, Great Wall Broadband, Cable WAN—down to province level.<br>(2) Overseas regions: down to continent and country.<br>(3) Alibaba cloud lines: down to individual regions.<br>(4) Custom lines: define any IP range for smart resolution.</p></blockquote><p>“(distribution-map-placeholder)”</p><p>By resolving IPs based on location, distant users reach nearby servers automatically—boosting experience without them lifting a finger.</p><p>In practice, service providers optimize UX based on the client’s real address. <strong>For most users, doing nothing gives the best network experience.</strong></p><h2 id=choosing-upstream-resolvers-for-self-hosted-dns>Choosing Upstream Resolvers for Self-Hosted DNS</h2><p>Nearly every Chinese-language guide tells you to pick large authoritative resolvers—Alibaba, Tencent, Cloudflare, Google—because they score high on reachability (comprehensive, accurate, timely). Yet they <strong>do not guarantee</strong> you the nearest server.</p><p>There’s historical context: Chinese ISPs once hijacked DNS plus plaintext HTTP to inject ads. Today, with HTTPS prevalent, this is far less common, though some last-mile ISPs may still try it. Simply switching resolvers to random IPs won’t save you from hijacks directed at UDP 53.</p><p>Another user niche cares about content filtering; some providers return bogus IPs for “special” sites. Authoritative resolvers rarely exhibit this behavior.</p><p>So three problems arise:</p><ol><li>IP contamination</li><li>DNS hijacking</li><li>Optimal service experience</li></ol><p>Authoritative resolvers fix (1); encrypted transports (DoT/DoH/QUIC) mitigate (2).</p><p><strong>For (3) you must go back to your carrier’s default DNS.</strong> As we said: <em>“Do nothing, and you’ll already enjoy the best network experience.”</em></p><p>But if you’re a perfectionist or a special user, the sections below show how to configure <strong>AdGuard Home</strong> and <strong>Clash</strong> to satisfy all three concerns at once.</p><h2 id=authoritative-yet-smart-dns>Authoritative yet “Smart” DNS</h2><h3 id=adguard-home-configuration>AdGuard Home Configuration</h3><p><a href=https://github.com/AdguardTeam/AdGuardHome>AdGuard Home</a> (ADG) is an ad-blocking, privacy-centric DNS server. It supports custom upstream resolvers and custom rules.</p><p>ADG’s default mode is <strong>load-balancing</strong>: you list several upstreams; ADG weights them by historical response speed and chooses the fastest. In simple terms, it will favor the quickest upstream more often.</p><p>Pick the third option instead: <strong>“Fastest IP address”</strong>.</p><p>“(ui-screenshot-placeholder)”</p><p>Result: ADG tests the IPs returned by each upstream and replies with whichever has the lowest latency. Below are ordinary results for <strong>bilibili.com</strong>:</p><p>“(ordinary-results-screenshot-placeholder)”</p><p>Without this option, ADG would hand every IP back to the client: some apps pick the first, others the last, others pick at random—possibly far from optimal.</p><p>With <strong>“Fastest IP address”</strong> enabled:</p><p>“(optimized-results-screenshot-placeholder)”</p><p>That alone improves network experience.</p><p><strong>Why isn’t “Fastest IP address” the default?</strong><br>Because waiting for <em>all</em> upstream answers means query time equals the <strong>slowest</strong> upstream. If you mix a 50 ms Ali server with a 500 ms Google one, your upstream delay becomes ~500 ms.</p><p>So users must balance quality vs. quantity. I suggest keeping <strong>two</strong> upstreams only: one authoritative (<code>https://dns.alidns.com/dns-query</code>) plus your local carrier’s DNS.</p><p>Carrier DNS IPs differ by city; look yours up <a href=https://ipw.cn/doc/else/dns.html>here</a> or read them from your router’s status page:</p><p>“(router-dns-screenshot-placeholder)”</p><h3 id=clash-configuration>Clash Configuration</h3><p>Users with special needs who still want optimal routing can delegate DNS handling to Clash’s <code>dns</code> section.</p><p><code>nameserver-policy</code> lets you assign different domains to different resolvers. Example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default-nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tls://223.5.5.5:853</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tls://1.12.12.12:853</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://one.one.one.one/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://dns.google/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;geosite:cn,private,apple&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>202.103.24.68</span><span class=w> </span><span class=c># your local carrier DNS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;geosite:geolocation-!cn&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://one.one.one.one/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://dns.google/dns-query</span><span class=w>
</span></span></span></code></pre></div><p>Meaning:</p><ul><li><code>default-nameserver</code> – used solely to resolve hostnames of DNS services in the <code>nameserver</code> list.</li><li><code>nameserver</code> – standard resolvers for ordinary queries.</li><li><code>nameserver-policy</code> – overrides above resolvers for specific groups of domains.</li></ul><h2 id=thanks-for-reading>Thanks for Reading</h2><p>If this post helped you, consider giving it a thumbs-up. Comments and discussion are always welcome!</p></div><div class=td-content style=page-break-before:always><h1 id=pg-875f5a75893e4ebbdef3ca88aa5b5475>Bypassing ChatGPT VPN Detection</h1><div class="td-byline mb-4"><time datetime=2024-05-09 class=text-body-secondary>Thursday, May 09, 2024</time></div><p>How to handle the ChatGPT error messages<br>“Unable to load site”<br>“Please try again later; if you are using a VPN, try turning it off.”<br>“Check the status page for information on outages.”</p><h2 id=foreword>Foreword</h2><p><img src=https://s2.loli.net/2024/05/09/dT4xi1mwFgYRKhq.png alt></p><p>ChatGPT is still the best chatbot in terms of user experience, but in mainland China its use is restricted by the network environment, so we need a proxy (literally a “ladder”) to reach it. ChatGPT is, however, quite strict in detecting proxies, and if it finds one it will simply refuse service. This article explains a way around that detection.</p><p>Some people suggest switching IPs to evade a block, yet the geolocations we can get from our providers already belong to supported regions, so this is not necessarily the real reason for denial of service.</p><p>Others argue that popular shared proxies are too easy to fingerprint and advise buying more expensive “uncrowded” ones, yet this is hardly a solid argument—IPv4 addresses are scarce, so even overseas ISPs often allocate ports via NAT. Blocking one address would hit a huge community, something that a service as widely used as ChatGPT surely would not design for.</p><p>For a public service, checking source-IP consistency makes more sense. Paid proxy plans typically impose data or speed limits, so most users adopt split-routing: they proxy only when the destination is firewalled, letting non-filtered traffic travel directly. This choice of paths can result in inconsistent source IPs. For example, Service A needs to talk to Domains X and Y, yet only X is firewalled; the proxy will be used for X but not Y, so A sees the same request coming from two different IPs.</p><p><strong>Solving this source-IP inconsistency will bypass ChatGPT’s “ladder” identification.</strong></p><p>Proxy rules usually include <code>domain rules</code>, <code>IP rules</code>, and so on.</p><p>Remember that the result of a <code>domain resolution</code> varies by region—if you are in place A you get a nearby server, and in place B you may get another. Therefore, DNS selection matters.</p><h2 id=dns-selection>DNS Selection</h2><p>Today there are many DNS protocols; <code>UDP:53</code> is so outdated and insecure that China lists DNS servers as a top-level requirement for companies. Such rules arose from decades of carriers employing <code>DNS hijacking</code> plus <code>HTTP</code> redirection to insert advertisements, deceiving many non-tech-savvy users and leading to countless complaints. Although today Chrome/Edge automatically upgrade to <code>HTTPS</code> and mark plain <code>HTTP</code> as insecure, many small neighbourhood ISPs and repackaged old Chromium versions persist, so DNS and HTTP hijacking still occur.</p><p>Hence we need a safe DNS protocol to avoid hijacking. In my experience Alibaba’s public <code>223.5.5.5</code> works well. Of course, when I mention <code>223.5.5.5</code> I do not mean plain UDP but <code>DoH</code> or <code>DoT</code>. Configure with <code>tls://223.5.5.5</code> or <code>https://dns.alidns.com/dns-query</code>.</p><p>Alidns rarely gets poisoned—only during certain sensitive periods. You can also use my long-term self-hosted resolver <code>tls://dns.jqknono.com</code>, upstreaming <code>8.8.8.8</code> and <code>1.1.1.1</code>, with cache acceleration.</p><h2 id=domain-rules>Domain Rules</h2><p>The detection page first visited runs probing logic, sending requests to several <em>domains</em> to check the source IP, so domain routing must remain consistent.</p><p>Besides its own, ChatGPT relies on third-party domains such as <code>auth0</code>, <code>cloudflare</code>, etc.</p><p>Add the following rules by hand:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># openai</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,chatgpt.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,openai.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,openai.org,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,auth0.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,cloudflare.com,PROXY</span><span class=w>
</span></span></span></code></pre></div><h3 id=how-to-test-domain-rules>How to test domain rules</h3><p>The domains above may evolve as ChatGPT’s services change; here is how to discover them yourself.</p><ol><li>Open a private/Incognito window to avoid caches/cookies.</li><li>Press <code>F12</code> to open DevTools, switch to the <code>Network</code> tab.</li><li>Visit <code>chat.openai.com</code> or <code>chatgpt.com</code>.</li><li>The following screenshot shows the domains used at the time of writing:</li></ol><p><img src=https://s2.loli.net/2024/05/09/SOtMedp8KrGyfzi.png alt=ChatGPT域名></p><p>Adding just those domains may still be insufficient. Inspect each aborted request: the <strong>challenge</strong> response’s <strong>Content-Security-Policy</strong> lists many domains. Add every one to the proxy policy.</p><p><img src=https://s2.loli.net/2024/05/09/aYseB9Df3xQqWRz.png alt=Content-Security-Policy中的域名></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># openai</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,chatgpt.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,openai.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,openai.org,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,auth0.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,cloudflare.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># additional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,oaistatic.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,oaiusercontent.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,intercomcdn.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,intercom.io,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,mixpanel.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,statsigapi.net,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,featuregates.org,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,stripe.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,browser-intake-datadoghq.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,sentry.io,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,live.net,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,live.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,windows.net,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,onedrive.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,microsoft.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,azure.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,sharepoint.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,gstatic.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,google.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,googleapis.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,googleusercontent.com,PROXY</span><span class=w>
</span></span></span></code></pre></div><h2 id=ip-rules>IP Rules</h2><p>If the site still refuses to load after the steps above, IP-based detection may also be in play. Below are some IPs I intercepted; they may not fit every region, so test on your own.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># openai</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>IP-CIDR6,2606:4700:4400::6812:231c/96,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>IP-CIDR,17.253.84.253/24,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>IP-CIDR,172.64.152.228/24,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>IP-CIDR,104.18.35.28/16,PROXY</span><span class=w>
</span></span></span></code></pre></div><h3 id=how-to-test-ip-rules>How to test IP rules</h3><p>Know your proxy tool. Open its connection log, watch the new connections as you reproduce the steps, then add the IPs you see.</p><p>A quick guide:</p><ol><li>Open a private/Incognito window.</li><li>Visit <code>chat.openai.com</code> or <code>chatgpt.com</code>.</li><li>Monitor the new connections in your proxy client and copy their IPs into rules.</li></ol><h2 id=protocol-rules>Protocol Rules</h2><p><code>QUIC</code> is an encrypted UDP protocol, and ChatGPT makes heavy use of <em>QUIC</em> traffic. Therefore both client and server must support UDP forwarding; many do not. Even with support, you must explicitly enable it—some clients default to not proxy UDP traffic. If unsure about UDP, either block QUIC in the proxy client or disable it in the browser; the browser will automatically fall back to HTTP/2 over TCP. QUIC provides smoother performance; feel free to experiment.</p><p><img src=https://s2.loli.net/2024/05/09/UAzbdgQT1y5J63w.png alt></p><h2 id=the-simplest-config--whitelist-mode>The simplest config – whitelist mode</h2><p>Set direct connections only for Chinese IPs and proxy everything else. This grants reliable ChatGPT access and also covers other foreign services.</p><p>The downside is higher data consumption and dependency on your proxy’s quality. If you trust your proxy’s network, give this a shot.</p><p>Of course, do remember to enable <code>UDP</code> forwarding.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/jqknono aria-label=Telegram><i class="fab fa-telegram"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/jqknono aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2015&ndash;2025
<span class=td-footer__authors>jqknono</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span></div></div></div></footer></div><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><script src=/js/deflate.js></script><script src=/js/main.min.ef02deeaa00500a3225379b19170d5b9d432263216df8955d03c6c7e12b892e4.js integrity="sha256-7wLe6qAFAKMiU3mxkXDVudQyJjIW34lV0DxsfhK4kuQ=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>