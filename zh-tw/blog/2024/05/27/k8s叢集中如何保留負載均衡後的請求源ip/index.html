<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-tw class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>K8s叢集中如何保留負載均衡後的請求源IP | jqknono Blogs</title><meta name=description content="引言 應用部署不一定總是簡單的安裝和運行，有時候還需要考慮網路的問題。本文將介紹如何在k8s叢集中使服務能獲取到請求的源IP。
應用提供服務一般依賴輸入資訊，輸入資訊如果不依賴五元組（源 IP、源端口、目的 IP、目的端口、協議），那麼該服務和網路耦合性低，不需要關心網路細節。
因此，對多數人來說都沒有閱讀本文的必要，如果你對網路感興趣，或者希望拓展一點視野，可以繼續閱讀下文，了解更多的服務場景。
本文基於 k8s v1.29.4，文中部分敘述混用了 pod 和 endpoint，本文場景下可以視為等價。
如果有錯誤，歡迎指正，我會及時更正。
為什麼源 IP 資訊會丟失？ 我們首先明確源 IP 是什麼，當 A 向 B 發送請求，B 將請求轉發給 C，雖然 C 看到的 IP 協議的源 IP 是 B 的 IP，但本文把A的IP看作源 IP。
主要有兩類行為會導致源資訊丟失：
網路地址轉換(NAT)，目的是節省公網 IPv4，負載均衡等。將導致服務端看到的源 IP 是 NAT 設備的 IP，而不是真實的源 IP。 代理(Proxy)，反向代理(RP, Reverse Proxy)和負載均衡(LB, Load Balancer)都屬於這一類，下文統稱代理伺服器。這類代理服務會將請求轉發給後端服務，但是會將源 IP 替換為自己的 IP。 NAT 簡單來說是以端口空間換IP空間，IPv4 地址有限，一個 IP 地址可以映射 65535 個端口，絕大多數時候這些端口沒有用完，因而可以多個子網 IP 共用一個公網 IP，在端口上區分不同的服務。其使用形式是：public IP:public port -> private IP_1:private port，更多內容請自行參閱網路地址轉換 代理服務是為了隱藏或暴露，代理服務會將請求轉發給後端服務，同時將源 IP 替換為自己的 IP，以此來隱藏後端服務的真實 IP，保護後端服務的安全。代理服務的使用形式是：client IP -> proxy IP -> server IP，更多內容請自行參閱代理 NAT和代理伺服器都非常常見，多數服務都無法獲得請求的源 IP。"><meta property="og:url" content="https://blog.jqknono.com/zh-tw/blog/2024/05/27/k8s%E5%8F%A2%E9%9B%86%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BF%9D%E7%95%99%E8%B2%A0%E8%BC%89%E5%9D%87%E8%A1%A1%E5%BE%8C%E7%9A%84%E8%AB%8B%E6%B1%82%E6%BA%90ip/"><meta property="og:site_name" content="jqknono Blogs"><meta property="og:title" content="K8s叢集中如何保留負載均衡後的請求源IP"><meta property="og:description" content="引言 應用部署不一定總是簡單的安裝和運行，有時候還需要考慮網路的問題。本文將介紹如何在k8s叢集中使服務能獲取到請求的源IP。
應用提供服務一般依賴輸入資訊，輸入資訊如果不依賴五元組（源 IP、源端口、目的 IP、目的端口、協議），那麼該服務和網路耦合性低，不需要關心網路細節。
因此，對多數人來說都沒有閱讀本文的必要，如果你對網路感興趣，或者希望拓展一點視野，可以繼續閱讀下文，了解更多的服務場景。
本文基於 k8s v1.29.4，文中部分敘述混用了 pod 和 endpoint，本文場景下可以視為等價。
如果有錯誤，歡迎指正，我會及時更正。
為什麼源 IP 資訊會丟失？ 我們首先明確源 IP 是什麼，當 A 向 B 發送請求，B 將請求轉發給 C，雖然 C 看到的 IP 協議的源 IP 是 B 的 IP，但本文把A的IP看作源 IP。
主要有兩類行為會導致源資訊丟失：
網路地址轉換(NAT)，目的是節省公網 IPv4，負載均衡等。將導致服務端看到的源 IP 是 NAT 設備的 IP，而不是真實的源 IP。 代理(Proxy)，反向代理(RP, Reverse Proxy)和負載均衡(LB, Load Balancer)都屬於這一類，下文統稱代理伺服器。這類代理服務會將請求轉發給後端服務，但是會將源 IP 替換為自己的 IP。 NAT 簡單來說是以端口空間換IP空間，IPv4 地址有限，一個 IP 地址可以映射 65535 個端口，絕大多數時候這些端口沒有用完，因而可以多個子網 IP 共用一個公網 IP，在端口上區分不同的服務。其使用形式是：public IP:public port -> private IP_1:private port，更多內容請自行參閱網路地址轉換 代理服務是為了隱藏或暴露，代理服務會將請求轉發給後端服務，同時將源 IP 替換為自己的 IP，以此來隱藏後端服務的真實 IP，保護後端服務的安全。代理服務的使用形式是：client IP -> proxy IP -> server IP，更多內容請自行參閱代理 NAT和代理伺服器都非常常見，多數服務都無法獲得請求的源 IP。"><meta property="og:locale" content="zh_tw"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-05-27T11:52:22+08:00"><meta property="article:modified_time" content="2024-05-27T11:52:22+08:00"><meta property="article:tag" content="網路"><meta property="article:tag" content="Blog"><meta itemprop=name content="K8s叢集中如何保留負載均衡後的請求源IP"><meta itemprop=description content="引言 應用部署不一定總是簡單的安裝和運行，有時候還需要考慮網路的問題。本文將介紹如何在k8s叢集中使服務能獲取到請求的源IP。
應用提供服務一般依賴輸入資訊，輸入資訊如果不依賴五元組（源 IP、源端口、目的 IP、目的端口、協議），那麼該服務和網路耦合性低，不需要關心網路細節。
因此，對多數人來說都沒有閱讀本文的必要，如果你對網路感興趣，或者希望拓展一點視野，可以繼續閱讀下文，了解更多的服務場景。
本文基於 k8s v1.29.4，文中部分敘述混用了 pod 和 endpoint，本文場景下可以視為等價。
如果有錯誤，歡迎指正，我會及時更正。
為什麼源 IP 資訊會丟失？ 我們首先明確源 IP 是什麼，當 A 向 B 發送請求，B 將請求轉發給 C，雖然 C 看到的 IP 協議的源 IP 是 B 的 IP，但本文把A的IP看作源 IP。
主要有兩類行為會導致源資訊丟失：
網路地址轉換(NAT)，目的是節省公網 IPv4，負載均衡等。將導致服務端看到的源 IP 是 NAT 設備的 IP，而不是真實的源 IP。 代理(Proxy)，反向代理(RP, Reverse Proxy)和負載均衡(LB, Load Balancer)都屬於這一類，下文統稱代理伺服器。這類代理服務會將請求轉發給後端服務，但是會將源 IP 替換為自己的 IP。 NAT 簡單來說是以端口空間換IP空間，IPv4 地址有限，一個 IP 地址可以映射 65535 個端口，絕大多數時候這些端口沒有用完，因而可以多個子網 IP 共用一個公網 IP，在端口上區分不同的服務。其使用形式是：public IP:public port -> private IP_1:private port，更多內容請自行參閱網路地址轉換 代理服務是為了隱藏或暴露，代理服務會將請求轉發給後端服務，同時將源 IP 替換為自己的 IP，以此來隱藏後端服務的真實 IP，保護後端服務的安全。代理服務的使用形式是：client IP -> proxy IP -> server IP，更多內容請自行參閱代理 NAT和代理伺服器都非常常見，多數服務都無法獲得請求的源 IP。"><meta itemprop=datePublished content="2024-05-27T11:52:22+08:00"><meta itemprop=dateModified content="2024-05-27T11:52:22+08:00"><meta itemprop=wordCount content="578"><meta itemprop=keywords content="網路,Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="K8s叢集中如何保留負載均衡後的請求源IP"><meta name=twitter:description content="引言 應用部署不一定總是簡單的安裝和運行，有時候還需要考慮網路的問題。本文將介紹如何在k8s叢集中使服務能獲取到請求的源IP。
應用提供服務一般依賴輸入資訊，輸入資訊如果不依賴五元組（源 IP、源端口、目的 IP、目的端口、協議），那麼該服務和網路耦合性低，不需要關心網路細節。
因此，對多數人來說都沒有閱讀本文的必要，如果你對網路感興趣，或者希望拓展一點視野，可以繼續閱讀下文，了解更多的服務場景。
本文基於 k8s v1.29.4，文中部分敘述混用了 pod 和 endpoint，本文場景下可以視為等價。
如果有錯誤，歡迎指正，我會及時更正。
為什麼源 IP 資訊會丟失？ 我們首先明確源 IP 是什麼，當 A 向 B 發送請求，B 將請求轉發給 C，雖然 C 看到的 IP 協議的源 IP 是 B 的 IP，但本文把A的IP看作源 IP。
主要有兩類行為會導致源資訊丟失：
網路地址轉換(NAT)，目的是節省公網 IPv4，負載均衡等。將導致服務端看到的源 IP 是 NAT 設備的 IP，而不是真實的源 IP。 代理(Proxy)，反向代理(RP, Reverse Proxy)和負載均衡(LB, Load Balancer)都屬於這一類，下文統稱代理伺服器。這類代理服務會將請求轉發給後端服務，但是會將源 IP 替換為自己的 IP。 NAT 簡單來說是以端口空間換IP空間，IPv4 地址有限，一個 IP 地址可以映射 65535 個端口，絕大多數時候這些端口沒有用完，因而可以多個子網 IP 共用一個公網 IP，在端口上區分不同的服務。其使用形式是：public IP:public port -> private IP_1:private port，更多內容請自行參閱網路地址轉換 代理服務是為了隱藏或暴露，代理服務會將請求轉發給後端服務，同時將源 IP 替換為自己的 IP，以此來隱藏後端服務的真實 IP，保護後端服務的安全。代理服務的使用形式是：client IP -> proxy IP -> server IP，更多內容請自行參閱代理 NAT和代理伺服器都非常常見，多數服務都無法獲得請求的源 IP。"><link rel=preload href=/scss/main.min.19deb9bb49a16bab1391617801cf2d75f58ded83cae46516f211ba8fc3e9f6f9.css as=style integrity="sha256-Gd65u0mha6sTkWF4Ac8tdfWN7YPK5GUW8hG6j8Pp9vk=" crossorigin=anonymous><link href=/scss/main.min.19deb9bb49a16bab1391617801cf2d75f58ded83cae46516f211ba8fc3e9f6f9.css rel=stylesheet integrity="sha256-Gd65u0mha6sTkWF4Ac8tdfWN7YPK5GUW8hG6j8Pp9vk=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3FFTG72NE"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3FFTG72NE")}</script></head><body class="td-page td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/zh-tw/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>jqknono Blogs</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://jqknono.com target=_blank rel=noopener><span>About</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class=nav-item><a class=nav-link href=https://github.com/jqknono target=_blank rel=noopener><i class="fab fa-github" aria-hidden=true></i><span>GitHub</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class="nav-item td-navbar__lang-menu"><div class="td-lang-menu dropdown"><a class="nav-link dropdown-toggle td-lang-menu__title" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false><span class=td-lang-menu__title-text>繁體中文</span>
<span class=td-lang-menu__title-code>ZH-TW</span></a><ul class=dropdown-menu><li><a class=dropdown-item href=/blog/2024/05/27/how-to-preserve-the-source-ip-of-requests-after-load-balancing-in-a-k8s-cluster/>English</a></li><li><span class="dropdown-item active">繁體中文</span></li><li><a class=dropdown-item href=/ja-jp/blog/1/01/01/>日本語</a></li><li><a class=dropdown-item href=/ko-kr/blog/2024/05/27/k8s-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0%EC%97%90%EC%84%9C-%EB%A1%9C%EB%93%9C-%EB%B0%B8%EB%9F%B0%EC%8B%B1-%ED%9B%84-%EC%9A%94%EC%B2%AD-%EC%9B%90%EB%B3%B8-ip%EB%A5%BC-%EB%B3%B4%EC%A1%B4%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95/>한국어</a></li><li><a class=dropdown-item href=/ar-sa/blog/1/01/01/>العربية</a></li><li><a class=dropdown-item href=/de-de/blog/2024/05/27/wie-beh%C3%A4lt-man-in-einem-k8s-cluster-die-quell-ip-der-anfragen-nach-der-lastverteilung-bei/>Deutsch</a></li><li><a class=dropdown-item href=/fr-fr/blog/2024/05/27/comment-conserver-lip-source-des-requ%C3%AAtes-apr%C3%A8s-%C3%A9quilibrage-de-charge-dans-un-cluster-k8s/>Français</a></li><li><a class=dropdown-item href=/hi-in/blog/2024/05/27/k8s-%E0%A4%95%E0%A5%8D%E0%A4%B2%E0%A4%B8%E0%A5%8D%E0%A4%9F%E0%A4%B0-%E0%A4%AE%E0%A5%87%E0%A4%82-%E0%A4%B2%E0%A5%8B%E0%A4%A1-%E0%A4%AC%E0%A5%88%E0%A4%B2%E0%A5%87%E0%A4%82%E0%A4%B8%E0%A4%B0-%E0%A4%95%E0%A5%87-%E0%A4%AC%E0%A4%BE%E0%A4%A6-%E0%A4%95%E0%A5%87-%E0%A4%85%E0%A4%A8%E0%A5%81%E0%A4%B0%E0%A5%8B%E0%A4%A7-%E0%A4%B8%E0%A5%8D%E0%A4%B0%E0%A5%8B%E0%A4%A4-ip-%E0%A4%95%E0%A5%8B-%E0%A4%95%E0%A5%88%E0%A4%B8%E0%A5%87-%E0%A4%AC%E0%A4%A8%E0%A4%BE%E0%A4%8F-%E0%A4%B0%E0%A4%96%E0%A5%87%E0%A4%82/>हिंदी</a></li><li><a class=dropdown-item href=/es-es/blog/2024/05/27/c%C3%B3mo-conservar-la-ip-de-origen-de-las-solicitudes-despu%C3%A9s-de-la-equilibraci%C3%B3n-de-carga-en-un-cl%C3%BAster-de-k8s/>Español</a></li><li><a class=dropdown-item href=/pt-br/blog/2024/05/27/como-preservar-o-ip-de-origem-da-solicita%C3%A7%C3%A3o-ap%C3%B3s-o-balanceamento-de-carga-em-um-cluster-k8s/>Português</a></li><li><a class=dropdown-item href=/ru-ru/blog/2024/05/27/%D0%BA%D0%B0%D0%BA-%D1%81%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B8%D1%82%D1%8C-%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D1%8B%D0%B9-ip-%D0%B0%D0%B4%D1%80%D0%B5%D1%81-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0-%D0%BF%D0%BE%D1%81%D0%BB%D0%B5-%D0%B1%D0%B0%D0%BB%D0%B0%D0%BD%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8-%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B8-%D0%B2-%D0%BA%D0%BB%D0%B0%D1%81%D1%82%D0%B5%D1%80%D0%B5-k8s/>Русский</a></li><li><a class=dropdown-item href=/it-it/blog/2024/05/27/come-preservare-lip-sorgente-delle-richieste-dopo-il-bilanciamento-del-carico-in-un-cluster-k8s/>Italiano</a></li><li><span class="dropdown-item disabled">Bahasa Indonesia</span></li><li><a class=dropdown-item href=/tr-tr/blog/2024/05/27/k8s-k%C3%BCmesinde-y%C3%BCk-dengeleme-sonras%C4%B1-istek-kaynak-ipsini-nas%C4%B1l-koruyabiliriz/>Türkçe</a></li><li><a class=dropdown-item href=/nl-nl/blog/2024/05/27/hoe-behoud-je-het-bron-ip-van-verzoeken-na-load-balancing-in-een-k8s-cluster/>Nederlands</a></li><li><a class=dropdown-item href=/pl-pl/blog/2024/05/27/jak-zachowa%C4%87-oryginalny-ip-%C5%BAr%C3%B3d%C5%82a-%C5%BC%C4%85dania-po-r%C3%B3wnowa%C5%BCeniu-obci%C4%85%C5%BCenia-w-klastrze-k8s/>Polski</a></li><li><a class=dropdown-item href=/ar-ae/blog/1/01/01/>العربية</a></li><li><a class=dropdown-item href=/zh-cn/blog/2024/05/27/k8s%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BF%9D%E7%95%99%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%90%8E%E7%9A%84%E8%AF%B7%E6%B1%82%E6%BA%90ip/>简体中文</a></li></ul></div></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=搜尋此網站… aria-label=搜尋此網站… autocomplete=off data-offline-search-index-json-src=/offline-search-index.cc8256ce9df3b0ba01ec0c0a9666d270.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main data-bs-spy=scroll data-bs-target=.td-toc data-bs-root-margin="0px 0px -10%"><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=搜尋此網站… aria-label=搜尋此網站… autocomplete=off data-offline-search-index-json-src=/offline-search-index.cc8256ce9df3b0ba01ec0c0a9666d270.json data-offline-search-base-href=/ data-offline-search-max-results=10></div><button class="btn btn-link td-sidebar__toggle" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="td-sidebar-nav collapse td-sidebar-nav--search-disabled foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zh-twblog-li><a href=/zh-tw/blog/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-zh-twblog><span>Blogs</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20251205e68aa2e58da0e69c8de58aa1e599a8e698afe4b8aae5a4a7e4bebfe5ae9c-li><input type=checkbox id=m-zh-twblog20251205e68aa2e58da0e69c8de58aa1e599a8e698afe4b8aae5a4a7e4bebfe5ae9c-check>
<label for=m-zh-twblog20251205e68aa2e58da0e69c8de58aa1e599a8e698afe4b8aae5a4a7e4bebfe5ae9c-check><a href=/zh-tw/blog/2025/12/05/%E6%8A%A2%E5%8D%A0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E4%B8%AA%E5%A4%A7%E4%BE%BF%E5%AE%9C/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20251205e68aa2e58da0e69c8de58aa1e599a8e698afe4b8aae5a4a7e4bebfe5ae9c><span>抢占服务器是个大便宜</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20251203e5bbbae8adb0e58588e4b88de8a681e4bdbfe794a8e998bfe9878ce99bb2esa_pagee58a9fe883bd-li><input type=checkbox id=m-zh-twblog20251203e5bbbae8adb0e58588e4b88de8a681e4bdbfe794a8e998bfe9878ce99bb2esa_pagee58a9fe883bd-check>
<label for=m-zh-twblog20251203e5bbbae8adb0e58588e4b88de8a681e4bdbfe794a8e998bfe9878ce99bb2esa_pagee58a9fe883bd-check><a href=/zh-tw/blog/2025/12/03/%E5%BB%BA%E8%AD%B0%E5%85%88%E4%B8%8D%E8%A6%81%E4%BD%BF%E7%94%A8%E9%98%BF%E9%87%8C%E9%9B%B2esa_page%E5%8A%9F%E8%83%BD/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20251203e5bbbae8adb0e58588e4b88de8a681e4bdbfe794a8e998bfe9878ce99bb2esa_pagee58a9fe883bd><span>建議先不要使用阿里雲ESA_page功能</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20251202e998bfe9878ce5b7b4e5b7b4esae88887osse79a84e59d91-li><input type=checkbox id=m-zh-twblog20251202e998bfe9878ce5b7b4e5b7b4esae88887osse79a84e59d91-check>
<label for=m-zh-twblog20251202e998bfe9878ce5b7b4e5b7b4esae88887osse79a84e59d91-check><a href=/zh-tw/blog/2025/12/02/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4esa%E8%88%87oss%E7%9A%84%E5%9D%91/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20251202e998bfe9878ce5b7b4e5b7b4esae88887osse79a84e59d91><span>阿里巴巴ESA與OSS的坑</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20251202windowse585b1e4baabe999a4e98cafchromee696b9e6b395-li><input type=checkbox id=m-zh-twblog20251202windowse585b1e4baabe999a4e98cafchromee696b9e6b395-check>
<label for=m-zh-twblog20251202windowse585b1e4baabe999a4e98cafchromee696b9e6b395-check><a href=/zh-tw/blog/2025/12/02/windows%E5%85%B1%E4%BA%AB%E9%99%A4%E9%8C%AFchrome%E6%96%B9%E6%B3%95/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20251202windowse585b1e4baabe999a4e98cafchromee696b9e6b395><span>windows共享除錯chrome方法</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20251202cloudflaree698afe590a6e5ae8ce585a8e58fafe4bfa1-li><input type=checkbox id=m-zh-twblog20251202cloudflaree698afe590a6e5ae8ce585a8e58fafe4bfa1-check>
<label for=m-zh-twblog20251202cloudflaree698afe590a6e5ae8ce585a8e58fafe4bfa1-check><a href=/zh-tw/blog/2025/12/02/cloudflare%E6%98%AF%E5%90%A6%E5%AE%8C%E5%85%A8%E5%8F%AF%E4%BF%A1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20251202cloudflaree698afe590a6e5ae8ce585a8e58fafe4bfa1><span>cloudflare是否完全可信</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20251201e8a696e58a9be694b9e59684e79691e99bb2-li><input type=checkbox id=m-zh-twblog20251201e8a696e58a9be694b9e59684e79691e99bb2-check>
<label for=m-zh-twblog20251201e8a696e58a9be694b9e59684e79691e99bb2-check><a href=/zh-tw/blog/2025/12/01/%E8%A6%96%E5%8A%9B%E6%94%B9%E5%96%84%E7%96%91%E9%9B%B2/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20251201e8a696e58a9be694b9e59684e79691e99bb2><span>視力改善疑雲</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20251129e8a898e4b880e6aca1e99d9ee585b8e59e8be5aeb6e5baade7b6b2e8b7afe5958fe9a18ce68e92e69fa5-li><input type=checkbox id=m-zh-twblog20251129e8a898e4b880e6aca1e99d9ee585b8e59e8be5aeb6e5baade7b6b2e8b7afe5958fe9a18ce68e92e69fa5-check>
<label for=m-zh-twblog20251129e8a898e4b880e6aca1e99d9ee585b8e59e8be5aeb6e5baade7b6b2e8b7afe5958fe9a18ce68e92e69fa5-check><a href=/zh-tw/blog/2025/11/29/%E8%A8%98%E4%B8%80%E6%AC%A1%E9%9D%9E%E5%85%B8%E5%9E%8B%E5%AE%B6%E5%BA%AD%E7%B6%B2%E8%B7%AF%E5%95%8F%E9%A1%8C%E6%8E%92%E6%9F%A5/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20251129e8a898e4b880e6aca1e99d9ee585b8e59e8be5aeb6e5baade7b6b2e8b7afe5958fe9a18ce68e92e69fa5><span>記一次非典型家庭網路問題排查</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20251127freebies-you-can-snag-by-owning-a-domain-li><input type=checkbox id=m-zh-twblog20251127freebies-you-can-snag-by-owning-a-domain-check>
<label for=m-zh-twblog20251127freebies-you-can-snag-by-owning-a-domain-check><a href=/zh-tw/blog/2025/11/27/freebies-you-can-snag-by-owning-a-domain/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20251127freebies-you-can-snag-by-owning-a-domain><span>持有域名可以耗到的羊毛</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20230506windowse6a98be68ea5e69982e79a84ipv6e5958fe9a18c-li><input type=checkbox id=m-zh-twblog20230506windowse6a98be68ea5e69982e79a84ipv6e5958fe9a18c-check>
<label for=m-zh-twblog20230506windowse6a98be68ea5e69982e79a84ipv6e5958fe9a18c-check><a href=/zh-tw/blog/2023/05/06/windows%E6%A9%8B%E6%8E%A5%E6%99%82%E7%9A%84ipv6%E5%95%8F%E9%A1%8C/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20230506windowse6a98be68ea5e69982e79a84ipv6e5958fe9a18c><span>Windows橋接時的IPv6問題</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20240527windowse7b3bbe7b5b1e5ae89e8a39de5928ce5959fe794a8-li><input type=checkbox id=m-zh-twblog20240527windowse7b3bbe7b5b1e5ae89e8a39de5928ce5959fe794a8-check>
<label for=m-zh-twblog20240527windowse7b3bbe7b5b1e5ae89e8a39de5928ce5959fe794a8-check><a href=/zh-tw/blog/2024/05/27/windows%E7%B3%BB%E7%B5%B1%E5%AE%89%E8%A3%9D%E5%92%8C%E5%95%9F%E7%94%A8/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20240527windowse7b3bbe7b5b1e5ae89e8a39de5928ce5959fe794a8><span>Windows系統安裝和啟用</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-zh-twblog20240527k8se58fa2e99b86e4b8ade5a682e4bd95e4bf9de79599e8b2a0e8bc89e59d87e8a1a1e5be8ce79a84e8ab8be6b182e6ba90ip-li><input type=checkbox id=m-zh-twblog20240527k8se58fa2e99b86e4b8ade5a682e4bd95e4bf9de79599e8b2a0e8bc89e59d87e8a1a1e5be8ce79a84e8ab8be6b182e6ba90ip-check checked>
<label for=m-zh-twblog20240527k8se58fa2e99b86e4b8ade5a682e4bd95e4bf9de79599e8b2a0e8bc89e59d87e8a1a1e5be8ce79a84e8ab8be6b182e6ba90ip-check><a href=/zh-tw/blog/2024/05/27/k8s%E5%8F%A2%E9%9B%86%E4%B8%AD%E5%A6%82%E4%BD%95%E4%BF%9D%E7%95%99%E8%B2%A0%E8%BC%89%E5%9D%87%E8%A1%A1%E5%BE%8C%E7%9A%84%E8%AB%8B%E6%B1%82%E6%BA%90ip/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20240527k8se58fa2e99b86e4b8ade5a682e4bd95e4bf9de79599e8b2a0e8bc89e59d87e8a1a1e5be8ce79a84e8ab8be6b182e6ba90ip><span class=td-sidebar-nav-active-item>K8s叢集中如何保留負載均衡後的請求源IP</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20240521wireguarde5b08de68a97e9818be7879fe59586udp-qose79a84e5ae8ce695b4e8a7a3e6b1bae696b9e6a188-li><input type=checkbox id=m-zh-twblog20240521wireguarde5b08de68a97e9818be7879fe59586udp-qose79a84e5ae8ce695b4e8a7a3e6b1bae696b9e6a188-check>
<label for=m-zh-twblog20240521wireguarde5b08de68a97e9818be7879fe59586udp-qose79a84e5ae8ce695b4e8a7a3e6b1bae696b9e6a188-check><a href=/zh-tw/blog/2024/05/21/wireguard%E5%B0%8D%E6%8A%97%E9%81%8B%E7%87%9F%E5%95%86udp-qos%E7%9A%84%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20240521wireguarde5b08de68a97e9818be7879fe59586udp-qose79a84e5ae8ce695b4e8a7a3e6b1bae696b9e6a188><span>WireGuard對抗運營商UDP QoS的完整解決方案</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20240520e5b091e695b8e6b4bee696b0e4babae5a0b1e5b08e-li><input type=checkbox id=m-zh-twblog20240520e5b091e695b8e6b4bee696b0e4babae5a0b1e5b08e-check>
<label for=m-zh-twblog20240520e5b091e695b8e6b4bee696b0e4babae5a0b1e5b08e-check><a href=/zh-tw/blog/2024/05/20/%E5%B0%91%E6%95%B8%E6%B4%BE%E6%96%B0%E4%BA%BA%E5%A0%B1%E5%B0%8E/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20240520e5b091e695b8e6b4bee696b0e4babae5a0b1e5b08e><span>少數派新人報導</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20240509e5808be4babae58c96e68ea8e896a6e698afe4bebfe588a9e7a59ee599a8e98284e698afe8aa8de79fa5e999b7e998b1-li><input type=checkbox id=m-zh-twblog20240509e5808be4babae58c96e68ea8e896a6e698afe4bebfe588a9e7a59ee599a8e98284e698afe8aa8de79fa5e999b7e998b1-check>
<label for=m-zh-twblog20240509e5808be4babae58c96e68ea8e896a6e698afe4bebfe588a9e7a59ee599a8e98284e698afe8aa8de79fa5e999b7e998b1-check><a href=/zh-tw/blog/2024/05/09/%E5%80%8B%E4%BA%BA%E5%8C%96%E6%8E%A8%E8%96%A6%E6%98%AF%E4%BE%BF%E5%88%A9%E7%A5%9E%E5%99%A8%E9%82%84%E6%98%AF%E8%AA%8D%E7%9F%A5%E9%99%B7%E9%98%B1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20240509e5808be4babae58c96e68ea8e896a6e698afe4bebfe588a9e7a59ee599a8e98284e698afe8aa8de79fa5e999b7e998b1><span>個人化推薦：是便利神器還是認知陷阱？</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zh-twblog20240509e9a8b0e8a88ae99bb2e9968be799bce88085e7a4bee7bea4e589b5e4bd9ce9ab94e9a997-li><input type=checkbox id=m-zh-twblog20240509e9a8b0e8a88ae99bb2e9968be799bce88085e7a4bee7bea4e589b5e4bd9ce9ab94e9a997-check>
<label for=m-zh-twblog20240509e9a8b0e8a88ae99bb2e9968be799bce88085e7a4bee7bea4e589b5e4bd9ce9ab94e9a997-check><a href=/zh-tw/blog/2024/05/09/%E9%A8%B0%E8%A8%8A%E9%9B%B2%E9%96%8B%E7%99%BC%E8%80%85%E7%A4%BE%E7%BE%A4%E5%89%B5%E4%BD%9C%E9%AB%94%E9%A9%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-zh-twblog20240509e9a8b0e8a88ae99bb2e9968be799bce88085e7a4bee7bea4e589b5e4bd9ce9ab94e9a997><span>騰訊雲開發者社群創作體驗</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"></div><div class=td-toc data-proofer-ignore><div class=td-toc-title><span class=td-toc-title__text></span>
<a class=td-toc-title__link title href=#></a></div><nav id=TableOfContents><ul><li><a href=#引言>引言</a></li><li><a href=#為什麼源-ip-資訊會丟失>為什麼源 IP 資訊會丟失？</a></li><li><a href=#如何保留源-ip>如何保留源 IP？</a></li><li><a href=#k8s-操作指導>K8S 操作指導</a><ul><li><a href=#創建-deployment>創建 Deployment</a></li><li><a href=#創建-service>創建 Service</a></li><li><a href=#創建-ingress>創建 Ingress</a></li></ul></li><li><a href=#總結>總結</a></li><li><a href=#參考>參考</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Taxonomy Cloud</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/2025/ data-taxonomy-term=2025><span class=taxonomy-label>2025</span><span class=taxonomy-count>8</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>Blog</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/udp-qos/ data-taxonomy-term=udp-qos><span class=taxonomy-label>UDP QoS</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/vpn/ data-taxonomy-term=vpn><span class=taxonomy-label>VPN</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/win%E7%96%91%E9%9B%A3%E9%9B%9C%E7%97%87/ data-taxonomy-term=win%E7%96%91%E9%9B%A3%E9%9B%9C%E7%97%87><span class=taxonomy-label>Win疑難雜症</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/wireguard/ data-taxonomy-term=wireguard><span class=taxonomy-label>WireGuard</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E5%89%B5%E4%BD%9C%E8%80%85%E5%B9%B3%E5%8F%B0/ data-taxonomy-term=%E5%89%B5%E4%BD%9C%E8%80%85%E5%B9%B3%E5%8F%B0><span class=taxonomy-label>創作者平台</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E5%8D%9A%E5%BC%88/ data-taxonomy-term=%E5%8D%9A%E5%BC%88><span class=taxonomy-label>博弈</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E6%95%99%E5%AD%B8/ data-taxonomy-term=%E6%95%99%E5%AD%B8><span class=taxonomy-label>教學</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E6%95%99%E7%A8%8B/ data-taxonomy-term=%E6%95%99%E7%A8%8B><span class=taxonomy-label>教程</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E6%9C%AA%E5%88%86%E9%A1%9E/ data-taxonomy-term=%E6%9C%AA%E5%88%86%E9%A1%9E><span class=taxonomy-label>未分類</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E7%96%91%E9%9B%A3%E9%9B%9C%E7%97%87/ data-taxonomy-term=%E7%96%91%E9%9B%A3%E9%9B%9C%E7%97%87><span class=taxonomy-label>疑難雜症</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E7%B6%B2%E7%B5%A1%E5%84%AA%E5%8C%96/ data-taxonomy-term=%E7%B6%B2%E7%B5%A1%E5%84%AA%E5%8C%96><span class=taxonomy-label>網絡優化</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E7%B6%B2%E8%B7%AF/ data-taxonomy-term=%E7%B6%B2%E8%B7%AF><span class=taxonomy-label>網路</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E8%A9%95%E6%B8%AC/ data-taxonomy-term=%E8%A9%95%E6%B8%AC><span class=taxonomy-label>評測</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E9%81%8B%E7%B6%AD/ data-taxonomy-term=%E9%81%8B%E7%B6%AD><span class=taxonomy-label>運維</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E9%9A%A8%E7%AD%86/ data-taxonomy-term=%E9%9A%A8%E7%AD%86><span class=taxonomy-label>隨筆</span><span class=taxonomy-count>1</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/win%E7%96%91%E9%9B%A3%E9%9B%9C%E7%97%87/ data-taxonomy-term=win%E7%96%91%E9%9B%A3%E9%9B%9C%E7%97%87><span class=taxonomy-label>Win疑難雜症</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E5%8D%9A%E5%BC%88/ data-taxonomy-term=%E5%8D%9A%E5%BC%88><span class=taxonomy-label>博弈</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E6%95%99%E5%AD%B8/ data-taxonomy-term=%E6%95%99%E5%AD%B8><span class=taxonomy-label>教學</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E6%95%99%E7%A8%8B/ data-taxonomy-term=%E6%95%99%E7%A8%8B><span class=taxonomy-label>教程</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E6%9C%AA%E5%88%86%E9%A1%9E/ data-taxonomy-term=%E6%9C%AA%E5%88%86%E9%A1%9E><span class=taxonomy-label>未分類</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E7%B6%B2%E8%B7%AF/ data-taxonomy-term=%E7%B6%B2%E8%B7%AF><span class=taxonomy-label>網路</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E7%B6%B2%E8%B7%AF%E6%8A%80%E8%A1%93/ data-taxonomy-term=%E7%B6%B2%E8%B7%AF%E6%8A%80%E8%A1%93><span class=taxonomy-label>網路技術</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E8%A9%95%E6%B8%AC/ data-taxonomy-term=%E8%A9%95%E6%B8%AC><span class=taxonomy-label>評測</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E9%81%8B%E7%B6%AD/ data-taxonomy-term=%E9%81%8B%E7%B6%AD><span class=taxonomy-label>運維</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E9%9A%A8%E7%AD%86/ data-taxonomy-term=%E9%9A%A8%E7%AD%86><span class=taxonomy-label>隨筆</span><span class=taxonomy-count>1</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><a class=td-rss-button title=RSS href=/zh-tw/blog/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/zh-tw/blog/>Blogs</a></li><li class="breadcrumb-item active" aria-current=page>K8s叢集中如何保留負載均衡後的請求源IP</li></ol></nav><div class=td-content><h1>K8s叢集中如何保留負載均衡後的請求源IP</h1><div class="td-byline mb-4"><time datetime=2024-05-27 class=text-body-secondary>Monday, May 27, 2024</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/%E7%B6%B2%E8%B7%AF/ data-taxonomy-term=%E7%B6%B2%E8%B7%AF><span class=taxonomy-label>網路</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>Blog</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/zh-tw/categories/%E7%B6%B2%E8%B7%AF/ data-taxonomy-term=%E7%B6%B2%E8%B7%AF><span class=taxonomy-label>網路</span></a></li></ul></div></header><h2 id=引言>引言</h2><p><strong>應用部署</strong>不一定總是簡單的<strong>安裝</strong>和<strong>運行</strong>，有時候還需要考慮<strong>網路</strong>的問題。本文將介紹如何在<strong>k8s叢集</strong>中使服務能獲取到請求的<strong>源IP</strong>。</p><p>應用提供服務一般依賴輸入資訊，輸入資訊如果不依賴<strong>五元組</strong>（源 IP、源端口、目的 IP、目的端口、協議），那麼該服務和<strong>網路耦合性低</strong>，不需要關心網路細節。</p><p>因此，對多數人來說都沒有閱讀本文的必要，如果你對網路感興趣，或者希望拓展一點視野，可以繼續閱讀下文，了解更多的服務場景。</p><p>本文基於 k8s <code>v1.29.4</code>，文中部分敘述混用了 pod 和 endpoint，本文場景下可以視為等價。</p><p><strong>如果有錯誤，歡迎指正，我會及時更正。</strong></p><h2 id=為什麼源-ip-資訊會丟失>為什麼源 IP 資訊會丟失？</h2><p>我們首先明確源 IP 是什麼，當 A 向 B 發送請求，B 將請求轉發給 C，雖然 C 看到的 IP 協議的源 IP 是 B 的 IP，但本文把<strong>A的IP</strong>看作源 IP。</p><p>主要有兩類行為會導致源資訊丟失：</p><ol><li><strong>網路地址轉換(NAT)</strong>，目的是節省公網 IPv4，負載均衡等。將導致服務端看到的源 IP 是 <strong>NAT</strong> 設備的 IP，而不是真實的源 IP。</li><li><strong>代理(Proxy)</strong>，<strong>反向代理</strong>(RP, Reverse Proxy)和<strong>負載均衡</strong>(LB, Load Balancer)都屬於這一類，下文統稱<strong>代理伺服器</strong>。這類代理服務會將請求轉發給後端服務，但是會將源 IP 替換為自己的 IP。</li></ol><ul><li>NAT 簡單來說是<strong>以端口空間換IP空間</strong>，IPv4 地址有限，一個 IP 地址可以映射 65535 個端口，絕大多數時候這些端口沒有用完，因而可以多個子網 IP 共用一個公網 IP，在端口上區分不同的服務。其使用形式是：<code>public IP:public port -> private IP_1:private port</code>，更多內容請自行參閱<a href="https://www.google.com/search?q=%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2">網路地址轉換</a></li><li>代理服務是為了<strong>隱藏或暴露</strong>，代理服務會將請求轉發給後端服務，同時將源 IP 替換為自己的 IP，以此來隱藏後端服務的真實 IP，保護後端服務的安全。代理服務的使用形式是：<code>client IP -> proxy IP -> server IP</code>，更多內容請自行參閱<a href="https://www.google.com/search?q=%E4%BB%A3%E7%90%86">代理</a></li></ul><p><strong>NAT</strong>和<strong>代理伺服器</strong>都非常常見，多數服務都無法獲得請求的源 IP。</p><p><em>這是常見的兩類修改源 IP 的途徑，如有其它歡迎補充。</em></p><h2 id=如何保留源-ip>如何保留源 IP？</h2><p>以下是一個 <code>HTTP 請求</code>的例子：</p><table><thead><tr><th>欄位</th><th>長度（位元組）</th><th>位偏移</th><th>描述</th></tr></thead><tbody><tr><td><strong>IP 首部</strong></td><td></td><td></td><td></td></tr><tr><td><code>源 IP</code></td><td>4</td><td>0-31</td><td>發送方的 IP 地址</td></tr><tr><td>目的 IP</td><td>4</td><td>32-63</td><td>接收方的 IP 地址</td></tr><tr><td><strong>TCP 首部</strong></td><td></td><td></td><td></td></tr><tr><td>源端口</td><td>2</td><td>0-15</td><td>發送端口號</td></tr><tr><td>目的端口</td><td>2</td><td>16-31</td><td>接收端口號</td></tr><tr><td>序列號</td><td>4</td><td>32-63</td><td>用於標識發送方發送的資料的位元組流</td></tr><tr><td>確認號</td><td>4</td><td>64-95</td><td>如果設置了 ACK 旗標，則為下一個期望收到的序列號</td></tr><tr><td>資料偏移</td><td>4</td><td>96-103</td><td>資料起始位置相對於 TCP 首部的位元組數</td></tr><tr><td>保留</td><td>4</td><td>104-111</td><td>保留欄位，未使用，設置為 0</td></tr><tr><td>旗標位</td><td>2</td><td>112-127</td><td>各種控制旗標，如 SYN、ACK、FIN 等</td></tr><tr><td>視窗大小</td><td>2</td><td>128-143</td><td>接收方可以接收的資料量</td></tr><tr><td>檢驗和</td><td>2</td><td>144-159</td><td>用於檢測資料是否在傳輸過程中發生了錯誤</td></tr><tr><td>緊急指標</td><td>2</td><td>160-175</td><td>發送方希望接收方盡快處理的緊急資料的位置</td></tr><tr><td>選項</td><td>可變</td><td>176-&mldr;</td><td>可能包括時間戳、最大報文段長度等</td></tr><tr><td><strong>HTTP 首部</strong></td><td></td><td></td><td></td></tr><tr><td>請求行</td><td>可變</td><td>&mldr;-&mldr;</td><td>包括請求方法、URI 和 HTTP 版本</td></tr><tr><td><code>頭部欄位</code></td><td>可變</td><td>&mldr;-&mldr;</td><td>包含各種頭部欄位，如 Host、User-Agent 等</td></tr><tr><td>空行</td><td>2</td><td>&mldr;-&mldr;</td><td>用於分隔頭部和主體部分</td></tr><tr><td>主體</td><td>可變</td><td>&mldr;-&mldr;</td><td>選用的請求或回應正文</td></tr></tbody></table><p>瀏覽以上 HTTP 請求結構，可以發現，有<strong>TCP選項</strong>、<strong>請求行</strong>、<strong>頭部欄位</strong>、<strong>主體</strong>是可變的，其中<strong>TCP選項</strong>空間有限，一般不會用來傳遞源 IP，<strong>請求行</strong>攜帶資訊固定不能擴展，<strong>HTTP主體</strong>加密後不能修改，只有<code>HTTP 頭部欄位</code>適合擴展傳遞源 IP。</p><p>HTTP header 中可以增加<code>X-REAL-IP</code>欄位，用來傳遞源 IP，這個操作通常放在代理伺服器上，然後<strong>代理伺服器</strong>會將請求發送給後端服務，後端服務就可以通過這個欄位獲取到源 IP 資訊。</p><p>注意，需要保證<strong>代理伺服器</strong>在<strong>NAT</strong>設備之前，這樣才能獲取到真實的請求的源 whoami。我們可以在阿里雲的產品中看到<a href=https://slb.console.aliyun.com/overview><strong>負載均衡器</strong></a>這個商品單獨品類，它在網路中的位置不同於普通的應用伺服器。</p><h2 id=k8s-操作指導>K8S 操作指導</h2><p>以<a href=https://github.com/traefik/whoami>whoami</a>項目為例進行部署。</p><h3 id=創建-deployment>創建 Deployment</h3><p>首先創建服務：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/traefik/whoami:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></div><p>這步會創建一個<strong>Deployment</strong>，裡面包含 3 個<strong>Pod</strong>，每個 pod 包含一個容器，該容器會運行<strong>whoami</strong>服務。</p><h3 id=創建-service>創建 Service</h3><p>可以創建<strong>NodePort</strong>或者<strong>LoadBalancer</strong>類型的服務，支持外部訪問，或者創建<strong>ClusterIP</strong>類型的服務，僅支持叢集內部訪問，再增加<strong>Ingress</strong>服務，通過<strong>Ingress</strong>服務暴露外部訪問。</p><p><strong>NodePort</strong>既可以通過<strong>NodeIP:NodePort</strong>訪問，也可以通過<strong>Ingess</strong>服務訪問，方便測試，本節使用<strong>NodePort</strong>服務。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>創建服務後，以<code>curl whoami.example.com:30002</code>訪問，可以看到返回的 IP 是<strong>NodeIP</strong>，而不是請求的源 whoami。</p><blockquote><p>請注意，這並不是正確的客戶端 IP，它們是叢集的內部 IP。這是所發生的事情：</p><ul><li>客戶端發送資料包到 node2:nodePort</li><li>node2 使用它自己的 IP 地址替換資料包的源 IP 地址（SNAT）</li><li>node2 將資料包上的目標 IP 替換為 Pod IP</li><li>資料包被路由到 node1，然後到端點</li><li>Pod 的回覆被路由回 node2</li><li>Pod 的回覆被發送回給客戶端</li></ul></blockquote><p>用圖表示：</p><p><img src=https://s2.loli.net/2024/05/27/fDg2tBx5FIcGMZN.png alt></p><h4 id=配置-externaltrafficpolicy-local>配置 externalTrafficPolicy: Local</h4><blockquote><p>為避免這種情況，Kubernetes 有一個特性可以保留客戶端源 IP。如果將 service.spec.externalTrafficPolicy 設置為 Local，kube-proxy 只會將代理請求代理到本地端點，而不會將流量轉發到其他節點。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>使用<code>curl whoami.example.com:30002</code>進行測試，當<strong>whoami.example.com</strong>映射到叢集多個 node 的 IP 時，有一定比例的幾率無法訪問。需要確認域名記錄只含有 endpoint(pod)所在 node(節點)的 ip。</p><p>這個配置<strong>有其代價</strong>，那就是失去了叢集內的負載均衡能力，客戶端只有訪問部署了 endpoint 的 node 才會得到回應。</p><p><img src=https://s2.loli.net/2024/05/27/PCgiTLF28XE4RKx.png alt=訪問路徑限制></p><p>當客戶端訪問 Node 2 時，不會有回應。</p><h3 id=創建-ingress>創建 Ingress</h3><p>多數服務提供給使用者時使用 <strong>http/https</strong>，<strong>https://ip:port</strong>的形式可能讓使用者感到陌生。一般會使用<strong>Ingress</strong>將上文創建的<strong>NodePort</strong>服務負載到一個域名的 <strong>80/443</strong> 端口下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>external-lb-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>whoami.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>應用後，使用<code>curl whoami.example.com</code>訪問測試，可以看到 ClientIP 總是 endpoint 所在節點上的<code>Ingress Controller</code>的 Pod IP。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@client:~# curl whoami.example.com
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>RemoteAddr: 10.42.1.10:56482
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@worker:~# kubectl get -n ingress-nginx pod -o wide
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE          NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>ingress-nginx-controller-c8f499cfc-xdrg7   1/1     Running   <span class=m>0</span>          3d2h   10.42.1.10   k3s-agent-1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>使用<strong>Ingress</strong>反向代理<strong>NodePort</strong>服務，也就是在 endpoint 前套了兩層 service，下圖展示了二者區別。</p><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:80| B(Ingress)
    B --&gt;|10.43.38.129:32123| C[Service]
    C --&gt;|10.42.1.1:8080| D[Endpoint]</pre><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:30001| B(Service)
    B --&gt;|10.42.1.1:8080| C[Endpoint]</pre><p>在路徑 1 中，外部訪問 Ingress 時，流量先到達的 endpoint 是<code>Ingress Controller</code>，然後再到達 endpoint <strong>whoami</strong>。<br>而<strong>Ingress Controller</strong>實質是一個<strong>LoadBalancer</strong>的服務，</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl -n ingress-nginx get svc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAMESPACE   NAME             CLASS   HOSTS                       ADDRESS                                              PORTS   AGE
</span></span><span class=line><span class=cl>default     echoip-ingress   nginx   ip.example.com       172.16.0.57,2408:4005:3de:8500:4da1:169e:dc47:1707   <span class=m>80</span>      18h
</span></span><span class=line><span class=cl>default     whoami-ingress   nginx   whoami.example.com   172.16.0.57,2408:4005:3de:8500:4da1:169e:dc47:1707   <span class=m>80</span>      16h
</span></span></code></pre></div><p>因此，可以通過將前文提到的<code>externalTrafficPolicy</code>設置到 Ingress Controller 中來保留源 IP。</p><p>同時還需要設置<code>ingress-nginx-controller</code>的<code>configmap</code>中的<code>use-forwarded-headers</code>為<code>true</code>，以便<strong>Ingress Controller</strong>能夠識別<code>X-Forwarded-For</code>或<code>X-REAL-IP</code>欄位。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allow-snippet-annotations</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compute-full-forwarded-for</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>use-forwarded-headers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-real-ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forwarded-for-header</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;X-Real-IP&#34;</span><span class=w> </span><span class=c># X-Real-IP or X-Forwarded-For</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx-controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span></code></pre></div><p><strong>NodePort</strong>服務與<strong>ingress-nginx-controller</strong>服務的區別主要在於，<strong>NodePort</strong>的後端通常不部署在每台 node 上，而<strong>ingress-nginx-controller</strong>的後端通常部署在每台對外暴露的 node 上。</p><p>與<strong>NodePort</strong>服務中設置<code>externalTrafficPolicy</code>會導致跨 node 的請求無回應不同，<strong>Ingress</strong>可以將請求先設置 HEADER 之後再進行代理轉發，實現了<strong>保留源 IP</strong>和<strong>負載均衡</strong>的兩種能力。</p><h2 id=總結>總結</h2><ul><li><strong>地址轉換(NAT)</strong>，<strong>代理(Proxy)</strong>、<strong>反向代理(Reverse Proxy)</strong>，**負載均衡(Load Balance)**會導致源 IP 丟失。</li><li>為防止源 IP 丟失，可以代理伺服器轉發時將真實 IP 設置在 HTTP 頭部欄位<code>X-REAL-IP</code>中，通過代理服務傳遞。如果使用多層代理，則可以使用<code>X-Forwarded-For</code>欄位，該欄位以<strong>堆疊</strong>的形式記錄了源 IP 及代理路徑的 <strong>IP list</strong>。</li><li>叢集<strong>NodePort</strong>服務設置<code>externalTrafficPolicy: Local</code>可以保留源 IP，但會失去負載均衡能力。</li><li><strong>ingress-nginx-controller</strong>以<strong>daemonset</strong>形式部署在所有<strong>loadbalancer</strong>角色 node 上的前提下，設置<code>externalTrafficPolicy: Local</code>可以保留源 IP，且保留負載均衡能力。</li></ul><h2 id=參考>參考</h2><ul><li><a href=https://kubernetes.io/zh-cn/docs/tutorials/services/source-ip/>Kubernetes 使用源 IP</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/>Ingress-Nginx Controller:ConfigMap</a></li><li><a href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/>Ingress Controller</a></li></ul><br><script src=https://giscus.app/client.js data-repo=jqknono/blog data-repo-id=R_kgDONOhENQ data-category=Announcements data-category-id=DIC_kwDONOhENc4CkQDB data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script><br><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/zh-tw/blog/2024/05/21/wireguard%E5%B0%8D%E6%8A%97%E9%81%8B%E7%87%9F%E5%95%86udp-qos%E7%9A%84%E5%AE%8C%E6%95%B4%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%A1%88/ aria-label="上一頁 - WireGuard對抗運營商UDP QoS的完整解決方案" class="btn btn-primary"><span class=me-1>←</span>上一頁</a></li><li><a href=/zh-tw/blog/2024/05/27/windows%E7%B3%BB%E7%B5%B1%E5%AE%89%E8%A3%9D%E5%92%8C%E5%95%9F%E7%94%A8/ aria-label="下一頁 - Windows系統安裝和啟用" class="btn btn-primary">下一頁<span class=ms-1>→</span></a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/jqknono aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2015&ndash;2025
<span class=td-footer__authors>jqknono</span></span><span class=td-footer__all_rights_reserved>保留所有權利</span></div></div></div></footer></div><script type=module async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@latest\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {"theme":"default","version":"latest"};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>