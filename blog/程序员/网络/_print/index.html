<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://blog.techfetch.dev/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/%E7%BD%91%E7%BB%9C/><link rel=alternate type=application/rss+xml href=https://blog.techfetch.dev/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/%E7%BD%91%E7%BB%9C/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>网络 | Nono Blogs</title>
<meta name=description content="网络 网络 绕墙 [wireguard对抗运营商] 网络问题定位 [linux网络问题定位] [windows网络问题定位]"><meta property="og:url" content="https://blog.techfetch.dev/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/%E7%BD%91%E7%BB%9C/"><meta property="og:site_name" content="Nono Blogs"><meta property="og:title" content="网络"><meta property="og:description" content="网络 网络 绕墙 [wireguard对抗运营商] 网络问题定位 [linux网络问题定位] [windows网络问题定位]"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="website"><meta itemprop=name content="网络"><meta itemprop=description content="网络 网络 绕墙 [wireguard对抗运营商] 网络问题定位 [linux网络问题定位] [windows网络问题定位]"><meta itemprop=datePublished content="2024-11-13T13:05:00+08:00"><meta itemprop=dateModified content="2024-11-13T13:05:00+08:00"><meta itemprop=wordCount content="7"><meta itemprop=keywords content="网络"><meta name=twitter:card content="summary"><meta name=twitter:title content="网络"><meta name=twitter:description content="网络 网络 绕墙 [wireguard对抗运营商] 网络问题定位 [linux网络问题定位] [windows网络问题定位]"><link rel=preload href=/scss/main.min.8acecbf86e7556fec1884b2edb0c0a5fcb36544832255924728123faf38ac587.css as=style integrity="sha256-is7L+G51Vv7BiEsu2wwKX8s2VEgyJVkkcoEj+vOKxYc=" crossorigin=anonymous><link href=/scss/main.min.8acecbf86e7556fec1884b2edb0c0a5fcb36544832255924728123faf38ac587.css rel=stylesheet integrity="sha256-is7L+G51Vv7BiEsu2wwKX8s2VEgyJVkkcoEj+vOKxYc=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3FFTG72NE"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3FFTG72NE")}</script></head><body class="td-section td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Nono Blogs</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class="nav-link active" href=/blog/><i class='fas fa-cube'></i><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/docs/><i class='fas fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=https://www.adguardprivate.com target=_blank rel=noopener><span>创建私有Adguard</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)"><svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=站内搜索… aria-label=站内搜索… autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/%E7%BD%91%E7%BB%9C/>返回本页常规视图</a>.</p></div><h1 class=title>网络</h1><ul><li><a href=#pg-931e8eabbd265e7a3bb27d5aa98c3a49>电信IPv6的一些特征</a></li><li><a href=#pg-d088abdb6aab928dad39e27339dd9e87>为什么不应该把TCP思维套在UDP上</a></li><li><a href=#pg-fe14363a9954cb1fb6a2e4a51ef7d5a1>linux网络问题定位</a></li><li><a href=#pg-953696aca9e6689f10d238a6951f475a>如何提升自建DNS服务下的网络体验</a></li><li><a href=#pg-b0ccb01b3aa156438a93cad783d70d49>ChatGPT VPN识别绕过方法</a></li></ul><div class=content><ul><li><input disabled type=checkbox> 网络</li></ul><h1 id=网络>网络</h1><ul><li>绕墙<ul><li>[<a href=wireguard%E5%AF%B9%E6%8A%97%E8%BF%90%E8%90%A5%E5%95%86 title=wireguard对抗运营商>wireguard对抗运营商</a>]</li></ul></li><li>网络问题定位<ul><li>[<a href=/blog/2024/05/28/linux%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/ title=linux网络问题定位>linux网络问题定位</a>]</li><li>[<a href=windows%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D title=windows网络问题定位>windows网络问题定位</a>]</li></ul></li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-931e8eabbd265e7a3bb27d5aa98c3a49>电信IPv6的一些特征</h1><div class="td-byline mb-4"><time datetime=2024-06-28 class=text-body-secondary>Friday, June 28, 2024</time></div><ul><li><p><input disabled type=checkbox> 电信IPv6的一些特征</p></li><li><p><input disabled type=checkbox> 电信 IPv6 的一些特征</p></li></ul><p>国内已经全面铺开 ipv6 使用, ipv6 地址池足够大, 个人的每个设备都可以获取到一个 ipv6 地址.<br>家庭用户使用时需要全栈设备都支持 ipv6 才能最终使用到 ipv6, 由于已经推了很多年, 目前来说 2016 年以后买的设备基本都支持 ipv6 了.</p><p>全栈设备包括: 城域设备->小区路由->家庭路由(光猫,路由器)->终端设备(手机,电脑,电视等)</p><p>这里不讨论标准的 ipv6 协议, 只讨论电信的 ipv6 的一些特征.</p><h2 id=地址分配>地址分配</h2><p>首先是地址分配方式, ipv6 有三种分配方式: 静态分配, SLAAC, DHCPv6.<br>湖北电信使用的是 SLAAC, 也就是说电信的 ipv6 地址是由设备自动分配的, 由于电信的 ipv6 地址池足够大, 所以不会出现地址冲突的问题.</p><p>电信 ipv6 地址是随机分配的, 24 小时后重新分配. 如果要从外部访问, 必须使用 DDNS 服务.</p><h2 id=防火墙>防火墙</h2><p>目前可以发现常见的<code>80</code>, <code>139</code>, <code>445</code>等端口已对齐 ipv4 防火前已经都封了, 这非常容易理解, 运营商级的防火墙确实能保护到缺乏网络安全意识的普通用户. 2020 年时电信 ipv6 都是开放的, 现在已经封了一些常用端口.</p><p><code>443</code>端口在电信网内偶尔开放, 但对移动联通不开放. 开发者应注意这一点. 在开发环境测试好的服务, 甚至电信网路手机也能访问, 但移动手机网络却访问不了.</p><p>基于简单的防火墙测试, 建议开发者牢记对运营商防火墙的不信任, 选择一个<strong>5 位数</strong>的端口提供服务.</p><p>另外, 电信防火墙没有屏蔽<code>22</code>端口, Windows 的远程桌面服务端口<code>3389</code>也没有屏蔽.<br>也就是可以远程登录控制, 这会导致一些风险.</p><p>攻击者获取到 IP 或者 DDNS 域名后, 就可以开始展开针对攻击, 利用暴力破解的方式获取到密码, 从而获取到控制权, 域名也会暴露一些个人信息, 例如姓名, 住址等, 也可能利用社会工程学的方式获取到更多信息以加快破解速度.</p><p>建议关闭 <code>ssh</code> 的密码登录, 仅使用密钥登录, 或者使用 VPN 的方式进行远程登录, 或者使用跳板机的方式进行远程登录.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d088abdb6aab928dad39e27339dd9e87>为什么不应该把TCP思维套在UDP上</h1><div class="td-byline mb-4"><time datetime=2024-06-28 class=text-body-secondary>Friday, June 28, 2024</time></div><ul><li><input disabled type=checkbox> 为什么不应该把TCP思维套在UDP上</li></ul><h1 id=为什么不应该把-tcp-思维套在-udp-上>为什么不应该把 TCP 思维套在 UDP 上?</h1><h2 id=结构差异>结构差异</h2><p><img alt=TCP表头 src=https://s2.loli.net/2023/06/30/ndPGpzMRX1L4Q6D.png><br><img alt=UDP表头 src=https://s2.loli.net/2023/06/30/ofdBYKb6iqaICA9.png></p><p>TCP 上的概念很多: 建立通路, 资源使用, 数据传输, 可靠传输, 基于重复累计确认的重传, 超时重传, 校验和, 流量控制, 拥塞控制, 最大分段大小, 选择确认, TCP 窗口缩放选项, TCP 时间戳, 强制数据递交, 终结通路.</p><p>以上这些能力, UDP 基本上都没有, 它仅比链路层多一点区分应用层目的的能力. UDP 足够简单意味着足够灵活.</p><h2 id=如果可能发生则一定会发生>如果可能发生,则一定会发生</h2><p>墨菲定律:</p><blockquote><p>如果有多过一种方式去做某事，而其中一种方式将导致灾难，则必定有人会这样选择。</p></blockquote><p>通常介绍 UDP 适合应用在游戏/语音/视频等场景, 少量的错包不影响业务.
为什么 UDP 适合这些场景? 它能用在这些场景, 不代表它是这些场景的最优方案, 必然是存在 TCP 无法解决的问题, 才让这些服务选择了功能简陋的 UDP 协议. 错包不影响业务扩展开来讲是指 TCP 协议在乎错包, UDP 不在乎错包, 更在乎实时性/连续性. UDP 的特点就是它不在乎 TCP 在乎的因素, 这些因素影响了实时性.</p><p>在代码实现上, UDP 只需要创建一个 socket, 绑定到一个端口上, 即可以开始收发. 通常 socket 用完时, 端口也用完了.</p><p>因此我可以这样使用 UDP:</p><ol><li>往任意 IP 的任意端口发送随机报文, 看看哪个端口有响应</li><li>甲通过 A 端口, 将请求报文发送到乙的 B 端口; 乙将响应报文用 C 端口, 发给甲的 D 端口</li><li>甲通过 A 端口, 将请求报文发送到乙的 B 端口; 乙委托丙将响应报文用 C 端口, 发给甲的 D 端口</li><li>甲通过 A 端口, 将请求报文发送到乙的 B 端口, 但将发送报文的源 IP 修改为了丙的 IP, 乙将会将响应报文发往丙</li><li>双方协商各用 10 个 UDP 端口, 同时进行接受和发送</li></ol><p>这些方法在 TCP 里自然是行不通的, 但在 UDP 协议中, 只要可以这样做, 就一定会有人这样做. 所以当把 TCP 的一些思维套在 UDP 上是一种理想主义, 真实情况常常不是我们能枚举完的.</p><p>UDP 的报文非常简单, 使用也非常灵活, 原本没有连接的概念, 需要自己定义 UDP 连接. 尝试了一些定义方法, 都不能完全准确达到连接方向判断意图, 这时需要接纳一些容错, 毕竟原本就没有 UDP 连接的定义, 当各方对 UDP 连接的定义不一致时, 必然会导致行为与预期不一样.</p><h2 id=客户端视角的-udp>客户端视角的 UDP</h2><p>语音/视频等业务常会产生丢包, 但是丢包方式的不同对业务有着不同的影响. 比如 30%的丢包是均匀发生的, 还是全丢在某个时间段, 对体验的影响有明显的区分. 显然, 我们期待的是更均匀的丢包. 可是 UDP 没有流量控制防止方法, 如何丢包则有一些方法. 尽管 UDP 通信常被描述为"尽力而为", 但是不同方式的"尽力"会达到不同的效果.</p><h2 id=服务商视角的-udp>服务商视角的 UDP</h2><p>如果是 TCP 攻击, 客户端需要一定的开销, 创建连接, 维护连接, 也就是攻击者需要付出一定的代价. 而在 UDP 攻击中, 攻击者付出的代价小很多, 如果攻击者想消耗的就是服务方的带宽流量, UDP 是一个很好的方式. 比如说服务购买了 100GB 的不限速流量, 处理能力仅 10MB 每秒, 但接受速度 1GB 每秒, 那么 90%的请求流量无效, 但这些流量不是免费的. 服务方应该避免产生这种情况.</p><h2 id=运营商的视角的-udp>运营商的视角的 UDP</h2><p>完成一次通信需包含多个终端以及通信通道, 受关注的总是服务端和客户端, 其实运营商的视角同样重要. DDoS 攻击中, 我们常关心服务端的资源消耗情况, 实际上运营商的资源也是有限的, 服务端简单不响应请求, 但接收流量却已经消耗了带宽, 只是这个资源一般属于运营商. 我们在压力测试中常用到"丢包率"指标, 这个指标表达的完整通信链条中的丢包, 而不仅仅是服务端的丢包. 运营商也会丢包. 在运营商看, 服务方仅购买了 1MB/s 的带宽, 但客户端以 1GB/s 的速度发送, 双方都不必为浪费的流量付费, 是运营商承担了这部分带宽的代价. 因此, 运营商必然想办法屏蔽这种流量, 也就是 UDP 的 QoS. 在 TCP 中有拥塞控制, 但在 UDP 中, 运营商可以通过丢包来控制流量. 实际情况中, 运营商更加简单粗暴, 直接屏蔽长时间使用的端口的流量, 也就是 UDP 的端口屏蔽. 在微信通话的实际测试中发现, 每一通电话客户端会使用多个端口, 其中有一个 UDP 端口会和同一服务器的 6 个 UDP 端口进行通信, 推测就是为了应对运营商的端口屏蔽.</p><h2 id=总结>总结</h2><p>UDP 的灵活表示在实现一个目标时, 它有着多种实现方式, 并且都是合法的, 只要能最终实现稳定的通信, 不管它实现的如何和 TCP 大相径庭, 都是"存在即合理"的. 因而, 我们不能完全将 TCP 的概念套用在 UDP 上, 即便为了产品设计, 创造了新的 UDP 连接定义, 也应该能预期并允许出错, 毕竟"允许出错"就是 UDP 的核心功能, 这是 UDP 的优势, 不是它的缺点, 是服务主动选择的协议核心能力, 而不是不得不接受的缺点.</p><h2 id=更多阅读>更多阅读</h2><ul><li><a href=https://cloud.tencent.com/developer/article/1708535>2 万字带你学习 Qos 原理</a></li><li><a href=https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE>传输控制协议</a></li><li><a href=https://zh.wikipedia.org/wiki/%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E6%8A%A5%E5%8D%8F%E8%AE%AE>用户数据报协议</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fe14363a9954cb1fb6a2e4a51ef7d5a1>linux网络问题定位</h1><div class="td-byline mb-4"><time datetime=2024-05-28 class=text-body-secondary>Tuesday, May 28, 2024</time></div><h2 id=排障工具>排障工具</h2><table><thead><tr><th>工具</th><th>说明</th><th>用法</th><th>说明</th></tr></thead><tbody><tr><td>ping</td><td>测试网络连通性</td><td>ping baidu.com</td><td></td></tr><tr><td>traceroute</td><td>路由跟踪</td><td>traceroute ip</td><td></td></tr><tr><td>route</td><td>路由表</td><td>route -n</td><td></td></tr><tr><td>netstat</td><td>网络连接</td><td>netstat -ano</td><td></td></tr><tr><td>nslookup</td><td>DNS 解析</td><td>nslookup baidu.com</td><td></td></tr><tr><td>ifconfig</td><td>网络配置</td><td>ifconfig</td><td></td></tr><tr><td>arp</td><td>ARP 缓存</td><td>arp -a</td><td></td></tr><tr><td>nbtstat</td><td>NetBIOS</td><td>nbtstat -n</td><td></td></tr><tr><td>netsh</td><td>网络配置</td><td>netsh</td><td></td></tr><tr><td>net</td><td>网络配置</td><td>net</td><td></td></tr><tr><td>tcpdump</td><td>网络抓包</td><td>tcpdump</td><td></td></tr><tr><td>wireshark</td><td>网络抓包</td><td>wireshark</td><td></td></tr><tr><td>ip</td><td>网络配置</td><td>ip addr show</td><td></td></tr><tr><td>ss</td><td>网络连接</td><td>ss -tunlp</td><td></td></tr><tr><td>netstat</td><td>查看网络连接状态</td><td>netstat -anp</td><td></td></tr><tr><td>tcpdump</td><td>抓包工具</td><td>tcpdump -i eth0 -nn -s 0 -c 1000 -w /tmp/tcpdump.pcap</td><td></td></tr><tr><td>iptables</td><td>防火墙</td><td>iptables -L -n -v -t nat -t mangle -t filter</td><td></td></tr><tr><td>ss</td><td>netstat 的替代品</td><td>ss -anp</td><td></td></tr><tr><td>ifconfig</td><td>查看网卡信息</td><td>ifconfig eth0</td><td></td></tr><tr><td>ip</td><td>查看网卡信息</td><td>ip addr show eth0</td><td></td></tr><tr><td>route</td><td>查看路由表</td><td>route -n</td><td></td></tr><tr><td>traceroute</td><td>查看路由跳数</td><td>traceroute <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>ping</td><td>测试网络连通性</td><td>ping <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>telnet</td><td>测试端口连通性</td><td>telnet <a href=https://www.baidu.com>www.baidu.com</a> 80</td><td></td></tr><tr><td>nslookup</td><td>域名解析</td><td>nslookup <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>dig</td><td>域名解析</td><td>dig <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>arp</td><td>查看 arp 缓存</td><td>arp -a</td><td></td></tr><tr><td>netcat</td><td>网络调试工具</td><td>nc -l 1234</td><td></td></tr><tr><td>nmap</td><td>端口扫描工具</td><td>nmap -sT -p 80 <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>mtr</td><td>网络连通性测试工具</td><td>mtr <a href=https://www.baidu.com>www.baidu.com</a></td><td></td></tr><tr><td>iperf</td><td>网络性能测试工具</td><td>iperf -s -p 1234</td><td></td></tr><tr><td>iptraf</td><td>网络流量监控工具</td><td>iptraf -i eth0</td><td></td></tr><tr><td>ipcalc</td><td>IP 地址计算工具</td><td>ipcalc</td><td></td></tr><tr><td>iftop</td><td>网络流量监控工具</td><td>iftop -i eth0</td><td></td></tr><tr><td>iostat</td><td>磁盘 IO 监控工具</td><td>iostat -x 1 10</td><td></td></tr><tr><td>vmstat</td><td>虚拟内存监控工具</td><td>vmstat 1 10</td><td></td></tr><tr><td>sar</td><td>系统性能监控工具</td><td>sar -n DEV 1 10</td><td></td></tr><tr><td>lsof</td><td>查看文件打开情况</td><td>lsof -i:80</td><td></td></tr><tr><td>strace</td><td>跟踪系统调用</td><td>strace -p 1234</td><td></td></tr><tr><td>tcpflow</td><td>抓包工具</td><td>tcpflow -i eth0 -c -C -p -o /tmp/tcpflow</td><td></td></tr><tr><td>tcpick</td><td>抓包工具</td><td>tcpick -i eth0 -C -p -o /tmp/tcpick</td><td></td></tr><tr><td>tcptrace</td><td>抓包工具</td><td>tcptrace -i eth0 -C -p -o /tmp/tcptrace</td><td></td></tr><tr><td>tcpslice</td><td>抓包工具</td><td>tcpslice -i eth0 -C -p -o /tmp/tcpslice</td><td></td></tr><tr><td>tcpstat</td><td>抓包工具</td><td>tcpstat -i eth0 -C -p -o /tmp/tcpstat</td><td></td></tr><tr><td>tcpdump</td><td>抓包工具</td><td>tcpdump -i eth0 -C -p -o /tmp/tcpdump</td><td></td></tr><tr><td>tshark</td><td>抓包工具</td><td>tshark -i eth0 -C -p -o /tmp/tshark</td><td></td></tr><tr><td>wireshark</td><td>抓包工具</td><td>wireshark -i eth0 -C -p -o /tmp/wireshark</td><td></td></tr><tr><td>socat</td><td>网络调试工具</td><td>socat -d -d TCP-LISTEN:1234,fork TCP:www.baidu.com:80</td><td></td></tr><tr><td>ncat</td><td>网络调试工具</td><td>ncat -l 1234 -c &rsquo;ncat <a href=https://www.baidu.com>www.baidu.com</a> 80'</td><td></td></tr><tr><td>netperf</td><td>网络性能测试工具</td><td>netperf -H <a href=https://www.baidu.com>www.baidu.com</a> -l 60 -t TCP_STREAM</td><td></td></tr><tr><td>netcat</td><td>网络调试工具</td><td>netcat -l 1234</td><td></td></tr><tr><td>nc</td><td>网络调试工具</td><td>nc -l 1234</td><td></td></tr><tr><td>netpipe</td><td>网络性能测试工具</td><td>netpipe -l 1234</td><td></td></tr><tr><td>netkit</td><td>网络调试工具</td><td>netkit -l 1234</td><td></td></tr><tr><td>bridge</td><td>网桥工具</td><td>bridge -s</td><td></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-953696aca9e6689f10d238a6951f475a>如何提升自建DNS服务下的网络体验</h1><div class="td-byline mb-4"><time datetime=2024-05-18 class=text-body-secondary>Saturday, May 18, 2024</time></div><h2 id=网络质量和网络体验>网络质量和网络体验</h2><blockquote><p>什么都不做, 即可以获得最好的网络体验</p></blockquote><p>需要明确, 这里<code>网络质量</code>和<code>网络体验</code>是两个不同的概念. 通信是一个过程, 涉及多个设备, 我们可以称单个设备的上下行表现为<code>网络质量</code>, 而整个端到端的通信表现, 我们可以称为<code>网络体验</code>.</p><h2 id=如何衡量网络质量>如何衡量网络质量</h2><p>衡量网络质量通常涉及多个指标和方法。以下是一些常见的衡量网络质量的方法和指标：</p><ol><li><strong>带宽（Bandwidth）</strong>：带宽是指网络传输数据的能力，通常以每秒传输的数据量（比特/秒）来衡量。更高的带宽通常表示更好的网络质量。</li><li><strong>延迟（Latency）</strong>：延迟是指数据从发送端到接收端所需的时间。低延迟表示数据传输速度快，网络响应更快。</li><li><strong>丢包率（Packet Loss Rate）</strong>：丢包率是指在数据传输过程中丢失的数据包的比例。较低的丢包率通常意味着网络质量较好。</li><li><strong>抖动（Jitter）</strong>：抖动是指数据包在传输过程中的变化或波动。较小的抖动表示网络稳定性较高。</li><li><strong>吞吐量（Throughput）</strong>：吞吐量是指网络传输的实际数据量，通常以单位时间内的数据传输量来衡量。更高的吞吐量表示网络质量更好。</li><li><strong>网络拓扑（Network Topology）</strong>：网络拓扑描述了网络中节点之间的连接方式和结构。合理的网络拓扑设计可以提高网络性能和质量。</li><li><strong>服务质量（Quality of Service，QoS）</strong>：QoS 是一组技术和机制，用于确保在网络中的数据传输中实现可接受的服务质量。QoS 可以通过各种方式实现，包括流量控制、优先级队列等。</li><li><strong>网络协议分析（Protocol Analysis）</strong>：通过分析网络协议和数据包，可以了解网络中的性能指标和问题，例如使用 Wireshark 等网络分析工具。</li></ol><p>综合利用这些指标和方法，可以全面地评估网络质量，确定网络性能的优势和改进的空间。 但这些是运营商关注的指标, 对于普通用户, 只需要购买价格合适的路由器即可, 现代路由器都有自动调整网络质量的功能.</p><h2 id=如何衡量网络体验>如何衡量网络体验</h2><p>首先是<strong>可访问性</strong>, 能访问是最重要的基础. 因此, 域名解析服务需要满足基础的能力:</p><ul><li>全面, 上级 DNS 服务需要权威, 且能够解析更多的域名</li><li>正确, 解析结果需要正确, 不能出现解析错误. 部分 DNS 服务商会对一些域名进行劫持或污染, 解析到广告页面.</li><li>及时, ip 地址变更后, 需要及时更新解析结果, 而不是返回旧的 ip 地址</li></ul><p>其次是 DNS 解析结果的 IP 所能提供服务的<code>网络质量</code>.</p><p>互联网服务所能提供的<code>网络质量</code>, 通常<strong>强依赖地域</strong>, 服务器和客户端在地域上越接近, 则服务质量越好.</p><p>许多付费 DNS 解析服务商都支持按地域解析不同 IP, 例如这是阿里云能提供的一部分服务:</p><blockquote><p>（1）运营商线路：支持按联通、电信、移动、教育网、鹏博士、广电网智能解析，细分到省份；<br>（2）海外地区线路：支持，细分到大洲、国家；<br>（3）阿里云线路：支持，细分到各个地区；<br>（4）自定义线路：支持自定义 IP 地址范围智能解析；</p></blockquote><p><img src=https://s2.loli.net/2024/06/20/WRfDMcdJiKHqAzG.png></p><p>按区域解析不同 IP 的机制, 意味着不同地域的用户访问同一个域名时, 会得到不同的解析结果, 自然而然的, 优先解析到距离用户更近的服务器, 将会有更好的网络体验.</p><p>而优化用户网络体验这件事, 一般都是服务提供商根据用户的真实 IP 地址来做优化. 也就是对多数用户来说, <code>什么都不做, 即可以获得最好的网络体验</code>.</p><h2 id=自建-dns-服务如何选择上游-dns-服务>自建 DNS 服务如何选择上游 DNS 服务</h2><p>中文互联网你搜索到的所有资料都会推荐你选择权威 DNS 服务商, 例如阿里云, 腾讯云, Cloudflare, 谷歌等. 这些 DNS 可以满足网络服务的的<code>可访问性</code>, 因为它们全面/正确/及时, 但是, 它们未必会给你解析到最近的服务器 IP.</p><p>互联网上大量的资料推荐大企业的 DNS 服务有其历史原因.</p><p>曾经我国的 ISP 运营商, 仅靠 DNS 劫持加上 HTTP 的中间人攻击, 就能够实现对用户的流量劫持, 从而实现广告推送. 现如今随着 https 的普及, 这种劫持方式已较为少见, 但部分地区的小区宽带仍然可能存在这种问题. 针对 DNS 劫持问题, 实际上改 DNS IP 无济于事, 因为劫持可以针对 53 端口, 而绝大多数 DNS 请求都是未加密的.</p><p>此外, 一些特殊用户希望访问特殊网站, 而部分 DNS 服务商存在 IP 污染问题, 会将特殊网站的域名解析到错误的 IP 地址, 导致无法访问. 而权威 DNS 服务商则较少出现这样问题.</p><p>因此, 这里存在三个问题需要考虑:</p><ol><li>IP 污染</li><li>DNS 劫持</li><li>最优服务体验</li></ol><p>权威 DNS 服务商可以解决问题 1 , 加密协议(DoT/DoH/QUIC)可以解决问题 2.</p><p><strong>想要解决问题 3, 你需要使用回宽带运营商的默认 DNS 服务.</strong>, 正如本文开头所说, <code>什么都不做, 即可以获得最好的网络体验</code>.</p><p>但如果你是一个有追求的人, 或者特殊用户, 下文将介绍如何配置 <code>AdguardHome</code> 及 <code>Clash</code> 两种工具的配置, 以同时解决这三个问题.</p><h2 id=权威且智能的-dns-服务>权威且智能的 DNS 服务</h2><h3 id=adguardhome-配置>AdguardHome 配置</h3><p><a href=https://github.com/AdguardTeam/AdGuardHome>AdguardHome</a>, 以下简称<code>ADG</code> 是一个网络广告拦截与隐私保护软件, 也是一个 DNS 服务. 它支持自定义上游 DNS 服务, 以及自定义 DNS 规则.</p><p><code>ADG</code> 默认的向上游请求 DNS 的方式是<code>负载均衡</code>, 用户可以设置多个上游, <code>ADG</code>将根据历史 DNS 查询加权权重选择其中 DNS 响应最快的上游. 简单说, <code>ADG</code> 会以更高的概率选择更快的 DNS 上游来解析域名, 以较低的概率选择非最优的 DNS 上游.</p><p>我们可以选择第三个选项: <code>最快的IP地址</code>.</p><p><img src=https://s2.loli.net/2024/06/20/oyFdIMDXratRb4q.png></p><p>该选项带来的好处, <code>ADG</code>自行测试上游 DNS 的 IP 解析结果, 将其中延迟最低的 IP 返回给下游客户端. 以下是<strong>bilibili</strong>的常规解析结果.</p><p><img src=https://s2.loli.net/2024/06/20/6ulLerFTCNbhIgo.png></p><p>你可以看到 IP 非常多, 如果<code>ADG</code>不测试 IP 解析结果, 而将所有 IP 返回给客户端, 那么客户端会做什么?</p><p>有的客户端会选择第一个 IP, 有的客户端会选择最后一个 IP, 有的客户端会随机选择一个 IP. 不管是哪种, 都未必是最优的选择.</p><p>开启<code>最快的IP地址</code>选项后, 以下是<strong>bilibili</strong>的优选解析结果, <strong>这一步将会带来<code>网络体验</code>的提升</strong>.</p><p><img src=https://s2.loli.net/2024/06/20/EsG7ekxqLX8fwHA.png></p><p><strong><code>最快的IP地址</code>为什么不是默认选择? 这个功能这么实用, 为什么不默认开启?</strong></p><p>因为它的代价是<em>等待所有上游 DNS 的 IP 解析结果</em>, 当你的上游同时有多个 DNS 服务商时, 向上游的查询时间以其中最慢的为准. 例如, 你的上游有平均服务时长<code>50ms</code>的阿里和平均服务时长<code>500ms</code>谷歌, <code>ADG</code>的上游查询时间将是<code>500ms+</code>.</p><p>因此用户在配置此选项时, 需要权衡上游 DNS 的服务质量和数量, 不要贪多.<br>这里我推荐设置两个上游, <strong>一个权威(<a href=https://dns.alidns.com/dns-query>https://dns.alidns.com/dns-query</a>)</strong>, 加上<strong>一个运营商 DNS</strong>.</p><p>运营商的 DNS IP 各地都不相同, 可以点击<a href=https://ipw.cn/doc/else/dns.html>这里</a>查看自己所在地区的运营商 DNS.</p><p>或者, 你可以在路由器的管理界面上查看运营商推荐的 DNS :</p><p><img src=https://s2.loli.net/2024/06/20/kpmK1nlWyxj4Uiv.png></p><h3 id=clash-配置>Clash 配置</h3><p>特殊需求用户看重 DNS 劫持和 IP 污染问题, 但又不想放弃最优服务体验, 可以使用<code>Clash</code>的<code>dns</code>模块.</p><p>其中<code>nameserver-policy</code>可以指定不同的域名使用不同的 DNS 服务商, 以下是一个示例配置:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>default-nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tls://223.5.5.5:853</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tls://1.12.12.12:853</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://one.one.one.one/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://dns.google/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;geosite:cn,private,apple&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>202.103.24.68</span><span class=w> </span><span class=c># 自己所在地的运营商 DNS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;geosite:geolocation-!cn&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://one.one.one.one/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://dns.google/dns-query</span><span class=w>
</span></span></span></code></pre></div><p>它的含义是:</p><ul><li>default-nameserver: 用于解析配置<code>nameserver</code>中的 DNS 服务的 IP</li><li>nameserver: 用于解析网络请求的域名</li><li>nameserver-policy: 根据策略, 指定不同的域名使用不同的 DNS 服务</li></ul><h2 id=感谢阅读>感谢阅读</h2><p>如果本文对您有所帮助, 还请点个赞. 也非常欢迎留言讨论.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b0ccb01b3aa156438a93cad783d70d49>ChatGPT VPN识别绕过方法</h1><div class="td-byline mb-4"><time datetime=2024-05-09 class=text-body-secondary>Thursday, May 09, 2024</time></div><p>如何处理 ChatGPT 报错<br>&ldquo;Unable to load site&rdquo;<br>&ldquo;Please try again later, if you are using a VPN, try turning it off.&rdquo;<br>&ldquo;Check the status page for information on outages.&rdquo;</p><h2 id=前言>前言</h2><p><img src=https://s2.loli.net/2024/05/09/dT4xi1mwFgYRKhq.png></p><p>chatgpt 目前仍然是使用体验最好的聊天机器人，但是在国内使用时，由于网络环境的限制，我们需要使用梯子来访问 chatgpt。但是 chatgpt 对梯子的检测较为严格，如果检测到使用了梯子，会直接拒绝访问。这里介绍一种绕过 chatgpt 对梯子检测的方法。</p><p>有其他人提到更换 IP 来绕过封锁, 但我们一般使用 IP 的地域已经是可以提供服务的地区, 所以这种方法并不一定是实际的拒绝服务原因.</p><p>另外有人提到梯子使用人数较多容易被识别, 劝人购买较贵的使用人数少的梯子, 这也很难成为合理理由, 在 ipv4 短缺的今天, 即便是海外, 也存在大量的社区使用 nat 分配端口, 共用一个 ipv4 的情况. chatgpt 一封就要封一大片, 作为一个被广泛使用的服务, 这样的检测设计肯定是不合理的.</p><p>对大众服务来说, 检测源 IP 一致性则更为合理. 付费梯子的特征通常是限制流量或限制网速, 因此多数使用梯子的用户选择按规则绕过. 绕过自己的运营商可直接访问的地址, 以减少流量消耗, 或者获得更快的访问速度, 仅在访问被防火墙拦截的地址时导入流量到代理. 这种访问目标服务的不同方式, 可能会造成源地址不一致. 例如访问 A 服务需要同时和域名 X 和域名 Y 进行通信, 而防火墙仅拦截了域名 X, 那么在 A 服务看到的同一请求的不同阶段的访问来源 IP 不一致.</p><p><strong>解决代理策略导致的源 IP 不一致问题, 即可绕过 chatgpt 的梯子识别.</strong></p><p>梯子规则中通常会含有<code>域名规则</code>, <code>IP规则</code>等.</p><p>我们还需要知道<code>域名解析</code>的 IP 结果是可以根据地域而变化的, 比如我在 A 地区时解析到附近的服务 IP, 在 B 地区时则解析到不同的 IP. 因此, DNS 的选择也非常重要.</p><h2 id=dns-选择>DNS 选择</h2><p>现在 DNS 有很多的协议, <code>UDP:53</code> 已经是非常落后而且极不安全的协议, 我国甚至已将 DNS 服务列入企业经营中的一级条目. 这主要来源于过去几十年我国的各级运行商使用<code>DNS劫持</code>加<code>HTTP</code>塞入了大量的跳转广告, 蒙骗不少网络小白, 招致大量投诉. 尽管现在<code>Chrome/Edge</code>已经标配自动跳转<code>HTTPS</code>, 标记<code>HTTP</code>网站为不安全, 但我国还存在许多的地方小区级的网络服务提供商, 以及国内各种老版本的<code>Chromium</code>封装魔改, 导致 DNS 劫持和 HTTP 劫持仍然存在.</p><p>因此, 我们需要选择一个安全的 DNS 服务协议, 以避免 DNS 劫持. 根据个人经验, 阿里云的<code>223.5.5.5</code>体验足够好. 当然, 当我提<code>223.5.5.5</code>时, 肯定不是<code>UDP:53</code>的 alidns, 而是<code>DoH</code>或<code>DoT</code>协议. 在配置时, 你需要使用<code>tls://223.5.5.5</code>, 或者<code>https://dns.alidns.com/dns-query</code>写入配置.</p><p>alidns 服务在绝大多数时候都不会污染, 仅在少数敏感时期会出现污染, 你也可以使用我自建的长期 dns 服务<code>tls://dns.jqknono.com</code>, 上游来自<code>8.8.8.8</code>和<code>1.1.1.1</code>, 通过缓存来加速访问.</p><h2 id=域名规则>域名规则</h2><p>首先打开的检测网页会包含检测逻辑, 通过向不同<em>域名</em>发送请求来验证源 IP, 因此这里需要保持域名代理的一致性.</p><p>chatgpt 网页访问的域名除了自己的域名<code>openai</code>外, 还有<code>auth0</code>, <code>cloudflare</code>等第三方域名.</p><p>可以手动写入以下规则:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># openai</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,chatgpt.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,openai.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,openai.org,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,auth0.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,cloudflare.com,PROXY</span><span class=w>
</span></span></span></code></pre></div><h3 id=如何试验域名规则>如何试验域名规则</h3><p>上边列举的域名可能随着 ChatGPT 业务发展而有所变化, 下面说明域名的获取方法.</p><ol><li>浏览器打开 InPrivate 页面, 隐私页面可以避免缓存/cookies 等的影响</li><li>按<code>F12</code>打开控制台, 选择<code>Network</code>/<code>网络</code>选项卡</li><li>访问<code>chat.openai.com</code>, 或者<code>chatgpt.com</code></li><li>下图展示了这篇文章写成时 ChatGPT 使用的域名</li></ol><p><img alt=ChatGPT使用的域名 src=https://s2.loli.net/2024/05/09/SOtMedp8KrGyfzi.png></p><p>仅添加这几个域名可能仍然不够, 这里分析访问失败的连接具体细节. 看到<strong>challenge</strong>的请求的<strong>Content-Security-Policy</strong>中含有众多域名, 我们将其一一添加到代理策略.</p><p><img alt=Content-Security-Policy中的域名 src=https://s2.loli.net/2024/05/09/aYseB9Df3xQqWRz.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># openai</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,chatgpt.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,openai.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,openai.org,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,auth0.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,cloudflare.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># additional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,oaistatic.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,oaiusercontent.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,intercomcdn.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,intercom.io,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,mixpanel.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,statsigapi.net,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,featuregates.org,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,stripe.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,browser-intake-datadoghq.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,sentry.io,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,live.net,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,live.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,windows.net,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,onedrive.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,microsoft.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,azure.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,sharepoint.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,gstatic.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,google.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,googleapis.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>DOMAIN-SUFFIX,googleusercontent.com,PROXY</span><span class=w>
</span></span></span></code></pre></div><h2 id=ip-规则>IP 规则</h2><p>如果上述步骤尝试后仍然不能访问<em>chatgpt.com</em>, 则可能还存在基于<em>IP</em>的检测行为, 以下是我在连接跟踪中尝试出的一些 IP, 你可以自行尝试使用, 需要说明这些 IP 并不一定适用于每个地区, 你或许需要自行尝试.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># openai</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>IP-CIDR6,2606:4700:4400::6812:231c/96,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>IP-CIDR,17.253.84.253/24,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>IP-CIDR,172.64.152.228/24,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>IP-CIDR,104.18.35.28/16,PROXY</span><span class=w>
</span></span></span></code></pre></div><h3 id=如何试验-ip-规则>如何试验 IP 规则</h3><p>你需要了解自己的梯子客户端工具, 在连接跟踪显示页面, 观察新增的连接, 通过这些连接的 IP 地址来尝试添加规则.</p><p>以下是简单的步骤描述:</p><ol><li>浏览器打开 InPrivate 页面, 隐私页面可以避免缓存/cookies 等的影响</li><li>访问<code>chat.openai.com</code>, 或者<code>chatgpt.com</code></li><li>梯子客户端中观察新增连接, 将这些连接加入到代理规则</li></ol><h2 id=协议规则>协议规则</h2><p><code>QUIC</code>是基于<code>UDP</code>的加密协议, chatgpt 大量使用了 <em>QUIC</em> 流量, 因此梯子的服务端/客户端需要支持 UDP 代理, 有许多梯子是不支持 UDP 的, 这也是导致 chatgpt 无法访问的原因之一. 客户端和服务端都支持 UDP, 还需要用户明确配置, 一些客户端会配置默认不代理 UDP 流量. 如果对 UDP 设置不熟悉, 可以设置屏蔽代理客户端的 QUIC 流量, 或者在浏览器设置屏蔽 QUIC. 浏览器发现 QUIC 不通会自动切换到基于 <em>TCP</em> 的 HTTP/2. QUIC 是基于 UDP 的加密协议, 多数时候可以获得更流畅的体验, 有兴趣的可以自行尝试.</p><p><img src=https://s2.loli.net/2024/05/09/UAzbdgQT1y5J63w.png></p><h2 id=最简单配置--白名单模式>最简单配置&ndash;白名单模式</h2><p>配置仅中国 IP 直连, 未匹配到的流量走代理, 这样可以保证 chatgpt 的访问, 也可以保证其他国外服务的访问.</p><p>这种方式的缺点就是流量消耗大, 网络流畅度体验依赖梯子的网络质量, 如果您对自己的梯子有信心, 可以尝试这种方式.</p><p>当然, 您还得记得开启<code>UDP</code>代理.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/jqknono aria-label=Telegram><i class="fab fa-telegram"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/jqknono aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2015&ndash;2024
<span class=td-footer__authors><a href=mailto:jqknono@gmail.com>jqknono@gmail.com</a></span></span><span class=td-footer__all_rights_reserved>保留所有权利</span></div></div></div></footer></div><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><script src=/js/deflate.js></script><script src=/js/main.min.a36b697f1493ff7e687efd36b7ca266315795eb9f468ead1d5c58663f90233fa.js integrity="sha256-o2tpfxST/35ofv02t8omYxV5Xrn0aOrR1cWGY/kCM/o=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>