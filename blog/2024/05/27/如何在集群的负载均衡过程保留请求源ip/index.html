<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>如何在集群的负载均衡过程保留请求源IP | Nono Blogs</title>
<meta name=description content="引言 应用部署不一定总是简单的安装和运行, 有时候还需要考虑网络的问题. 本文将介绍如何在k8s集群中使服务能获取到请求的源IP.
应用提供服务一般依赖输入信息, 输入信息如果不依赖五元组(源 IP, 源端口, 目的 IP, 目的端口, 协议), 那么该服务和网络耦合性低, 不需要关心网络细节.
因此, 对多数人来说都没有阅读本文的必要, 如果你对网络感兴趣, 或者希望拓宽一点视野, 可以继续阅读下文, 了解更多的服务场景.
本文基于 k8s v1.29.4, 文中部分叙述混用了 pod 和 endpoint, 本文场景下可以视为等价.
如果有错误, 欢迎指正, 我会及时更正.
为什么源 IP 信息会丢失? 我们首先明确源 IP 是什么, 当 A 向 B 发送请求, B 将请求转发给 C, 虽然 C 看到的 IP 协议的源 IP 是 B 的 IP, 但本文把A的IP看作源 IP.
主要有两类行为会导致源信息丢失:
网络地址转换(NAT), 目的是节省公网 IPv4, 负载均衡等. 将导致服务端看到的源 IP 是 NAT 设备的 IP, 而不是真实的源 IP. 代理(Proxy), 反向代理(RP, Reverse Proxy)和负载均衡(LB, Load Balancer)都属于这一类, 下文统称代理服务器. 这类代理服务会将请求转发给后端服务, 但是会将源 IP 替换为自己的 IP. NAT 简单来说是以端口空间换IP空间, IPv4 地址有限, 一个 IP 地址可以映射 65535 个端口, 绝大多数时候这些端口没有用完, 因而可以多个子网 IP 共用一个公网 IP, 在端口上区分不同的服务. 其使用形式是: public IP:public port -> private IP_1:private port, 更多内容请自行参阅网络地址转换 代理服务是为了隐藏或暴露, 代理服务会将请求转发给后端服务, 同时将源 IP 替换为自己的 IP, 以此来隐藏后端服务的真实 IP, 保护后端服务的安全. 代理服务的使用形式是: client IP -> proxy IP -> server IP, 更多内容请自行参阅代理 NAT和代理服务器都非常常见, 多数服务都无法获得请求的源 IP."><meta property="og:url" content="https://blog.jqknono.com/blog/2024/05/27/%E5%A6%82%E4%BD%95%E5%9C%A8%E9%9B%86%E7%BE%A4%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%BF%87%E7%A8%8B%E4%BF%9D%E7%95%99%E8%AF%B7%E6%B1%82%E6%BA%90ip/"><meta property="og:site_name" content="Nono Blogs"><meta property="og:title" content="如何在集群的负载均衡过程保留请求源IP"><meta property="og:description" content="引言 应用部署不一定总是简单的安装和运行, 有时候还需要考虑网络的问题. 本文将介绍如何在k8s集群中使服务能获取到请求的源IP.
应用提供服务一般依赖输入信息, 输入信息如果不依赖五元组(源 IP, 源端口, 目的 IP, 目的端口, 协议), 那么该服务和网络耦合性低, 不需要关心网络细节.
因此, 对多数人来说都没有阅读本文的必要, 如果你对网络感兴趣, 或者希望拓宽一点视野, 可以继续阅读下文, 了解更多的服务场景.
本文基于 k8s v1.29.4, 文中部分叙述混用了 pod 和 endpoint, 本文场景下可以视为等价.
如果有错误, 欢迎指正, 我会及时更正.
为什么源 IP 信息会丢失? 我们首先明确源 IP 是什么, 当 A 向 B 发送请求, B 将请求转发给 C, 虽然 C 看到的 IP 协议的源 IP 是 B 的 IP, 但本文把A的IP看作源 IP.
主要有两类行为会导致源信息丢失:
网络地址转换(NAT), 目的是节省公网 IPv4, 负载均衡等. 将导致服务端看到的源 IP 是 NAT 设备的 IP, 而不是真实的源 IP. 代理(Proxy), 反向代理(RP, Reverse Proxy)和负载均衡(LB, Load Balancer)都属于这一类, 下文统称代理服务器. 这类代理服务会将请求转发给后端服务, 但是会将源 IP 替换为自己的 IP. NAT 简单来说是以端口空间换IP空间, IPv4 地址有限, 一个 IP 地址可以映射 65535 个端口, 绝大多数时候这些端口没有用完, 因而可以多个子网 IP 共用一个公网 IP, 在端口上区分不同的服务. 其使用形式是: public IP:public port -> private IP_1:private port, 更多内容请自行参阅网络地址转换 代理服务是为了隐藏或暴露, 代理服务会将请求转发给后端服务, 同时将源 IP 替换为自己的 IP, 以此来隐藏后端服务的真实 IP, 保护后端服务的安全. 代理服务的使用形式是: client IP -> proxy IP -> server IP, 更多内容请自行参阅代理 NAT和代理服务器都非常常见, 多数服务都无法获得请求的源 IP."><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2024-05-27T11:52:22+08:00"><meta property="article:modified_time" content="2024-05-27T11:52:22+08:00"><meta property="article:tag" content="网络"><meta property="article:tag" content="Blog"><meta itemprop=name content="如何在集群的负载均衡过程保留请求源IP"><meta itemprop=description content="引言 应用部署不一定总是简单的安装和运行, 有时候还需要考虑网络的问题. 本文将介绍如何在k8s集群中使服务能获取到请求的源IP.
应用提供服务一般依赖输入信息, 输入信息如果不依赖五元组(源 IP, 源端口, 目的 IP, 目的端口, 协议), 那么该服务和网络耦合性低, 不需要关心网络细节.
因此, 对多数人来说都没有阅读本文的必要, 如果你对网络感兴趣, 或者希望拓宽一点视野, 可以继续阅读下文, 了解更多的服务场景.
本文基于 k8s v1.29.4, 文中部分叙述混用了 pod 和 endpoint, 本文场景下可以视为等价.
如果有错误, 欢迎指正, 我会及时更正.
为什么源 IP 信息会丢失? 我们首先明确源 IP 是什么, 当 A 向 B 发送请求, B 将请求转发给 C, 虽然 C 看到的 IP 协议的源 IP 是 B 的 IP, 但本文把A的IP看作源 IP.
主要有两类行为会导致源信息丢失:
网络地址转换(NAT), 目的是节省公网 IPv4, 负载均衡等. 将导致服务端看到的源 IP 是 NAT 设备的 IP, 而不是真实的源 IP. 代理(Proxy), 反向代理(RP, Reverse Proxy)和负载均衡(LB, Load Balancer)都属于这一类, 下文统称代理服务器. 这类代理服务会将请求转发给后端服务, 但是会将源 IP 替换为自己的 IP. NAT 简单来说是以端口空间换IP空间, IPv4 地址有限, 一个 IP 地址可以映射 65535 个端口, 绝大多数时候这些端口没有用完, 因而可以多个子网 IP 共用一个公网 IP, 在端口上区分不同的服务. 其使用形式是: public IP:public port -> private IP_1:private port, 更多内容请自行参阅网络地址转换 代理服务是为了隐藏或暴露, 代理服务会将请求转发给后端服务, 同时将源 IP 替换为自己的 IP, 以此来隐藏后端服务的真实 IP, 保护后端服务的安全. 代理服务的使用形式是: client IP -> proxy IP -> server IP, 更多内容请自行参阅代理 NAT和代理服务器都非常常见, 多数服务都无法获得请求的源 IP."><meta itemprop=datePublished content="2024-05-27T11:52:22+08:00"><meta itemprop=dateModified content="2024-05-27T11:52:22+08:00"><meta itemprop=wordCount content="688"><meta itemprop=keywords content="网络,Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="如何在集群的负载均衡过程保留请求源IP"><meta name=twitter:description content="引言 应用部署不一定总是简单的安装和运行, 有时候还需要考虑网络的问题. 本文将介绍如何在k8s集群中使服务能获取到请求的源IP.
应用提供服务一般依赖输入信息, 输入信息如果不依赖五元组(源 IP, 源端口, 目的 IP, 目的端口, 协议), 那么该服务和网络耦合性低, 不需要关心网络细节.
因此, 对多数人来说都没有阅读本文的必要, 如果你对网络感兴趣, 或者希望拓宽一点视野, 可以继续阅读下文, 了解更多的服务场景.
本文基于 k8s v1.29.4, 文中部分叙述混用了 pod 和 endpoint, 本文场景下可以视为等价.
如果有错误, 欢迎指正, 我会及时更正.
为什么源 IP 信息会丢失? 我们首先明确源 IP 是什么, 当 A 向 B 发送请求, B 将请求转发给 C, 虽然 C 看到的 IP 协议的源 IP 是 B 的 IP, 但本文把A的IP看作源 IP.
主要有两类行为会导致源信息丢失:
网络地址转换(NAT), 目的是节省公网 IPv4, 负载均衡等. 将导致服务端看到的源 IP 是 NAT 设备的 IP, 而不是真实的源 IP. 代理(Proxy), 反向代理(RP, Reverse Proxy)和负载均衡(LB, Load Balancer)都属于这一类, 下文统称代理服务器. 这类代理服务会将请求转发给后端服务, 但是会将源 IP 替换为自己的 IP. NAT 简单来说是以端口空间换IP空间, IPv4 地址有限, 一个 IP 地址可以映射 65535 个端口, 绝大多数时候这些端口没有用完, 因而可以多个子网 IP 共用一个公网 IP, 在端口上区分不同的服务. 其使用形式是: public IP:public port -> private IP_1:private port, 更多内容请自行参阅网络地址转换 代理服务是为了隐藏或暴露, 代理服务会将请求转发给后端服务, 同时将源 IP 替换为自己的 IP, 以此来隐藏后端服务的真实 IP, 保护后端服务的安全. 代理服务的使用形式是: client IP -> proxy IP -> server IP, 更多内容请自行参阅代理 NAT和代理服务器都非常常见, 多数服务都无法获得请求的源 IP."><link rel=preload href=/scss/main.min.8acecbf86e7556fec1884b2edb0c0a5fcb36544832255924728123faf38ac587.css as=style integrity="sha256-is7L+G51Vv7BiEsu2wwKX8s2VEgyJVkkcoEj+vOKxYc=" crossorigin=anonymous><link href=/scss/main.min.8acecbf86e7556fec1884b2edb0c0a5fcb36544832255924728123faf38ac587.css rel=stylesheet integrity="sha256-is7L+G51Vv7BiEsu2wwKX8s2VEgyJVkkcoEj+vOKxYc=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-F3FFTG72NE"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-F3FFTG72NE")}</script></head><body class="td-page td-blog"><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Nono Blogs</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class="nav-link active" href=/blog/><i class='fas fa-cube'></i><span>Blog</span></a></li><li class=nav-item><a class=nav-link href=/docs/><i class='fas fa-book'></i><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=https://www.adguardprivate.com target=_blank rel=noopener><i class="fa-solid fa-fire"></i><span>创建私有Adguard</span><sup><i class="ps-1 fa-solid fa-up-right-from-square fa-xs" aria-hidden=true></i></sup></a></li><li class="td-light-dark-menu nav-item dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown data-bs-display=static aria-label="Toggle theme (auto)"><svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=bd-theme-text><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></li></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=站内搜索… aria-label=站内搜索… autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder=站内搜索… aria-label=站内搜索… autocomplete=off></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="td-sidebar-nav collapse td-sidebar-nav--search-disabled foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge4b8aae4babae99a8fe7ac94-li><input type=checkbox id=m-bloge4b8aae4babae99a8fe7ac94-check>
<label for=m-bloge4b8aae4babae99a8fe7ac94-check><a href=/blog/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge4b8aae4babae99a8fe7ac94><span>个人随笔</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloge4b8aae4babae99a8fe7ac94e99885e8afbb-li><input type=checkbox id=m-bloge4b8aae4babae99a8fe7ac94e99885e8afbb-check>
<label for=m-bloge4b8aae4babae99a8fe7ac94e99885e8afbb-check><a href=/blog/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/%E9%98%85%E8%AF%BB/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge4b8aae4babae99a8fe7ac94e99885e8afbb><span>阅读</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge4b8aae4babae99a8fe7ac94e58d9ae5bc88-li><input type=checkbox id=m-bloge4b8aae4babae99a8fe7ac94e58d9ae5bc88-check>
<label for=m-bloge4b8aae4babae99a8fe7ac94e58d9ae5bc88-check><a href=/blog/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/%E5%8D%9A%E5%BC%88/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge4b8aae4babae99a8fe7ac94e58d9ae5bc88><span>博弈</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230627okre79a84e999b7e998b1e4b88ee58aa9e58a9b-li><input type=checkbox id=m-blog20230627okre79a84e999b7e998b1e4b88ee58aa9e58a9b-check>
<label for=m-blog20230627okre79a84e999b7e998b1e4b88ee58aa9e58a9b-check><a href=/blog/2023/06/27/okr%E7%9A%84%E9%99%B7%E9%98%B1%E4%B8%8E%E5%8A%A9%E5%8A%9B/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230627okre79a84e999b7e998b1e4b88ee58aa9e58a9b><span>OKR的陷阱与助力</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240518e6ada6e6b189e5b08fe9be99e899bee5b882e59cbae68f90e4be9be58aa0e5b7a5e69c8de58aa1e4ba86-li><input type=checkbox id=m-blog20240518e6ada6e6b189e5b08fe9be99e899bee5b882e59cbae68f90e4be9be58aa0e5b7a5e69c8de58aa1e4ba86-check>
<label for=m-blog20240518e6ada6e6b189e5b08fe9be99e899bee5b882e59cbae68f90e4be9be58aa0e5b7a5e69c8de58aa1e4ba86-check><a href=/blog/2024/05/18/%E6%AD%A6%E6%B1%89%E5%B0%8F%E9%BE%99%E8%99%BE%E5%B8%82%E5%9C%BA%E6%8F%90%E4%BE%9B%E5%8A%A0%E5%B7%A5%E6%9C%8D%E5%8A%A1%E4%BA%86/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240518e6ada6e6b189e5b08fe9be99e899bee5b882e59cbae68f90e4be9be58aa0e5b7a5e69c8de58aa1e4ba86><span>武汉小龙虾市场提供加工服务了</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloge4b8aae4babae99a8fe7ac94e8b5b0e8b5b0e5819ce5819c-li><input type=checkbox id=m-bloge4b8aae4babae99a8fe7ac94e8b5b0e8b5b0e5819ce5819c-check>
<label for=m-bloge4b8aae4babae99a8fe7ac94e8b5b0e8b5b0e5819ce5819c-check><a href=/blog/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/%E8%B5%B0%E8%B5%B0%E5%81%9C%E5%81%9C/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge4b8aae4babae99a8fe7ac94e8b5b0e8b5b0e5819ce5819c><span>走走停停</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloge4b8aae4babae99a8fe7ac94e8a782e5bdb1-li><input type=checkbox id=m-bloge4b8aae4babae99a8fe7ac94e8a782e5bdb1-check>
<label for=m-bloge4b8aae4babae99a8fe7ac94e8a782e5bdb1-check><a href=/blog/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/%E8%A7%82%E5%BD%B1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge4b8aae4babae99a8fe7ac94e8a782e5bdb1><span>观影</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge8b083e7a094-li><input type=checkbox id=m-bloge8b083e7a094-check>
<label for=m-bloge8b083e7a094-check><a href=/blog/%E8%B0%83%E7%A0%94/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge8b083e7a094><span>调研</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge8b083e7a094e7a4bee58cbae8a784e58899e58886e69e90-li><input type=checkbox id=m-bloge8b083e7a094e7a4bee58cbae8a784e58899e58886e69e90-check>
<label for=m-bloge8b083e7a094e7a4bee58cbae8a784e58899e58886e69e90-check><a href=/blog/%E8%B0%83%E7%A0%94/%E7%A4%BE%E5%8C%BA%E8%A7%84%E5%88%99%E5%88%86%E6%9E%90/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge8b083e7a094e7a4bee58cbae8a784e58899e58886e69e90><span>社区规则分析</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20231113e4ba9ae9a9ace9808ae59586e5ba97e7a4bee58cbae8a784e58899-li><input type=checkbox id=m-blog20231113e4ba9ae9a9ace9808ae59586e5ba97e7a4bee58cbae8a784e58899-check>
<label for=m-blog20231113e4ba9ae9a9ace9808ae59586e5ba97e7a4bee58cbae8a784e58899-check><a href=/blog/2023/11/13/%E4%BA%9A%E9%A9%AC%E9%80%8A%E5%95%86%E5%BA%97%E7%A4%BE%E5%8C%BA%E8%A7%84%E5%88%99/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20231113e4ba9ae9a9ace9808ae59586e5ba97e7a4bee58cbae8a784e58899><span>亚马逊商店社区规则</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloge8b083e7a094e58d8ee4b8ba-li><input type=checkbox id=m-bloge8b083e7a094e58d8ee4b8ba-check>
<label for=m-bloge8b083e7a094e58d8ee4b8ba-check><a href=/blog/%E8%B0%83%E7%A0%94/%E5%8D%8E%E4%B8%BA/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge8b083e7a094e58d8ee4b8ba><span>huawei</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge781b5e6849fadguard-li><input type=checkbox id=m-bloge781b5e6849fadguard-check>
<label for=m-bloge781b5e6849fadguard-check><a href=/blog/%E7%81%B5%E6%84%9F/adguard/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge781b5e6849fadguard><span>adguard</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240612e588a9e794a8dnse69c8de58aa1e5b9b3e6bb91e58887e68da2e7bd91e7bb9ce69c8de58aa1-li><input type=checkbox id=m-blog20240612e588a9e794a8dnse69c8de58aa1e5b9b3e6bb91e58887e68da2e7bd91e7bb9ce69c8de58aa1-check>
<label for=m-blog20240612e588a9e794a8dnse69c8de58aa1e5b9b3e6bb91e58887e68da2e7bd91e7bb9ce69c8de58aa1-check><a href=/blog/2024/06/12/%E5%88%A9%E7%94%A8dns%E6%9C%8D%E5%8A%A1%E5%B9%B3%E6%BB%91%E5%88%87%E6%8D%A2%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240612e588a9e794a8dnse69c8de58aa1e5b9b3e6bb91e58887e68da2e7bd91e7bb9ce69c8de58aa1><span>利用DNS服务平滑切换网络服务</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge79691e99abee69d82e79787-li><input type=checkbox id=m-bloge79691e99abee69d82e79787-check>
<label for=m-bloge79691e99abee69d82e79787-check><a href=/blog/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge79691e99abee69d82e79787><span>疑难杂症</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20241106windows-server-2019e995bfe697b6e997b4e8bf90e8a18cipv6e696ade8bf9ee997aee9a298-li><input type=checkbox id=m-blog20241106windows-server-2019e995bfe697b6e997b4e8bf90e8a18cipv6e696ade8bf9ee997aee9a298-check>
<label for=m-blog20241106windows-server-2019e995bfe697b6e997b4e8bf90e8a18cipv6e696ade8bf9ee997aee9a298-check><a href=/blog/2024/11/06/windows-server-2019%E9%95%BF%E6%97%B6%E9%97%B4%E8%BF%90%E8%A1%8Cipv6%E6%96%AD%E8%BF%9E%E9%97%AE%E9%A2%98/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20241106windows-server-2019e995bfe697b6e997b4e8bf90e8a18cipv6e696ade8bf9ee997aee9a298><span>Windows Server 2019长时间运行ipv6断连问题</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628openvpne7bd91e7bb9ce4b88de9809a-li><input type=checkbox id=m-blog20240628openvpne7bd91e7bb9ce4b88de9809a-check>
<label for=m-blog20240628openvpne7bd91e7bb9ce4b88de9809a-check><a href=/blog/2024/06/28/openvpn%E7%BD%91%E7%BB%9C%E4%B8%8D%E9%80%9A/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628openvpne7bd91e7bb9ce4b88de9809a><span>openvpn网络不通</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230506windowse6a1a5e68ea5e697b6e79a84ipv6e997aee9a298-li><input type=checkbox id=m-blog20230506windowse6a1a5e68ea5e697b6e79a84ipv6e997aee9a298-check>
<label for=m-blog20230506windowse6a1a5e68ea5e697b6e79a84ipv6e997aee9a298-check><a href=/blog/2023/05/06/windows%E6%A1%A5%E6%8E%A5%E6%97%B6%E7%9A%84ipv6%E9%97%AE%E9%A2%98/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230506windowse6a1a5e68ea5e697b6e79a84ipv6e997aee9a298><span>Windows桥接时的IPv6问题</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240603e5ae9de5a194dockere6ba90e58aa0e9809f-li><input type=checkbox id=m-blog20240603e5ae9de5a194dockere6ba90e58aa0e9809f-check>
<label for=m-blog20240603e5ae9de5a194dockere6ba90e58aa0e9809f-check><a href=/blog/2024/06/03/%E5%AE%9D%E5%A1%94docker%E6%BA%90%E5%8A%A0%E9%80%9F/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240603e5ae9de5a194dockere6ba90e58aa0e9809f><span>宝塔docker源加速</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240507windows-edgee6b58fe8a788e599a8e58da1e9a1bfe79a84e4b880e7a78de8a7a3e586b3e58a9ee6b395-li><input type=checkbox id=m-blog20240507windows-edgee6b58fe8a788e599a8e58da1e9a1bfe79a84e4b880e7a78de8a7a3e586b3e58a9ee6b395-check>
<label for=m-blog20240507windows-edgee6b58fe8a788e599a8e58da1e9a1bfe79a84e4b880e7a78de8a7a3e586b3e58a9ee6b395-check><a href=/blog/2024/05/07/windows-edge%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8D%A1%E9%A1%BF%E7%9A%84%E4%B8%80%E7%A7%8D%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240507windows-edgee6b58fe8a788e599a8e58da1e9a1bfe79a84e4b880e7a78de8a7a3e586b3e58a9ee6b395><span>Windows Edge浏览器卡顿的一种解决办法</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog10101-li><input type=checkbox id=m-blog10101-check>
<label for=m-blog10101-check><a href=/blog/1/01/01/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog10101><span></span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge7a88be5ba8fe59198-li><input type=checkbox id=m-bloge7a88be5ba8fe59198-check>
<label for=m-bloge7a88be5ba8fe59198-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198><span>程序员</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge7a88be5ba8fe59198e7bd91e7bb9c-li><input type=checkbox id=m-bloge7a88be5ba8fe59198e7bd91e7bb9c-check>
<label for=m-bloge7a88be5ba8fe59198e7bd91e7bb9c-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/%E7%BD%91%E7%BB%9C/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198e7bd91e7bb9c><span>网络</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e794b5e4bfa1ipv6e79a84e4b880e4ba9be789b9e5be81-li><input type=checkbox id=m-blog20240628e794b5e4bfa1ipv6e79a84e4b880e4ba9be789b9e5be81-check>
<label for=m-blog20240628e794b5e4bfa1ipv6e79a84e4b880e4ba9be789b9e5be81-check><a href=/blog/2024/06/28/%E7%94%B5%E4%BF%A1ipv6%E7%9A%84%E4%B8%80%E4%BA%9B%E7%89%B9%E5%BE%81/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e794b5e4bfa1ipv6e79a84e4b880e4ba9be789b9e5be81><span>电信IPv6的一些特征</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e4b8bae4bb80e4b988e4b88de5ba94e8afa5e68a8atcpe6809de7bbb4e5a597e59ca8udpe4b88a-li><input type=checkbox id=m-blog20240628e4b8bae4bb80e4b988e4b88de5ba94e8afa5e68a8atcpe6809de7bbb4e5a597e59ca8udpe4b88a-check>
<label for=m-blog20240628e4b8bae4bb80e4b988e4b88de5ba94e8afa5e68a8atcpe6809de7bbb4e5a597e59ca8udpe4b88a-check><a href=/blog/2024/06/28/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E5%BA%94%E8%AF%A5%E6%8A%8Atcp%E6%80%9D%E7%BB%B4%E5%A5%97%E5%9C%A8udp%E4%B8%8A/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e4b8bae4bb80e4b988e4b88de5ba94e8afa5e68a8atcpe6809de7bbb4e5a597e59ca8udpe4b88a><span>为什么不应该把TCP思维套在UDP上</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240528linuxe7bd91e7bb9ce997aee9a298e5ae9ae4bd8d-li><input type=checkbox id=m-blog20240528linuxe7bd91e7bb9ce997aee9a298e5ae9ae4bd8d-check>
<label for=m-blog20240528linuxe7bd91e7bb9ce997aee9a298e5ae9ae4bd8d-check><a href=/blog/2024/05/28/linux%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240528linuxe7bd91e7bb9ce997aee9a298e5ae9ae4bd8d><span>linux网络问题定位</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240518e5a682e4bd95e68f90e58d87e887aae5bbbadnse69c8de58aa1e4b88be79a84e7bd91e7bb9ce4bd93e9aa8c-li><input type=checkbox id=m-blog20240518e5a682e4bd95e68f90e58d87e887aae5bbbadnse69c8de58aa1e4b88be79a84e7bd91e7bb9ce4bd93e9aa8c-check>
<label for=m-blog20240518e5a682e4bd95e68f90e58d87e887aae5bbbadnse69c8de58aa1e4b88be79a84e7bd91e7bb9ce4bd93e9aa8c-check><a href=/blog/2024/05/18/%E5%A6%82%E4%BD%95%E6%8F%90%E5%8D%87%E8%87%AA%E5%BB%BAdns%E6%9C%8D%E5%8A%A1%E4%B8%8B%E7%9A%84%E7%BD%91%E7%BB%9C%E4%BD%93%E9%AA%8C/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240518e5a682e4bd95e68f90e58d87e887aae5bbbadnse69c8de58aa1e4b88be79a84e7bd91e7bb9ce4bd93e9aa8c><span>如何提升自建DNS服务下的网络体验</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240509chatgpt-vpne8af86e588abe7bb95e8bf87e696b9e6b395-li><input type=checkbox id=m-blog20240509chatgpt-vpne8af86e588abe7bb95e8bf87e696b9e6b395-check>
<label for=m-blog20240509chatgpt-vpne8af86e588abe7bb95e8bf87e696b9e6b395-check><a href=/blog/2024/05/09/chatgpt-vpn%E8%AF%86%E5%88%AB%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240509chatgpt-vpne8af86e588abe7bb95e8bf87e696b9e6b395><span>ChatGPT VPN识别绕过方法</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge7a88be5ba8fe59198e69d82e8b088-li><input type=checkbox id=m-bloge7a88be5ba8fe59198e69d82e8b088-check>
<label for=m-bloge7a88be5ba8fe59198e69d82e8b088-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/%E6%9D%82%E8%B0%88/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198e69d82e8b088><span>杂谈</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e7acace4b889e696b9e5ba93e79a84e999b7e998b1-li><input type=checkbox id=m-blog20240628e7acace4b889e696b9e5ba93e79a84e999b7e998b1-check>
<label for=m-blog20240628e7acace4b889e696b9e5ba93e79a84e999b7e998b1-check><a href=/blog/2024/06/28/%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E7%9A%84%E9%99%B7%E9%98%B1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e7acace4b889e696b9e5ba93e79a84e999b7e998b1><span>第三方库的陷阱</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e696b9e6a188e8aebee8aea1e6a8a1e69dbf-li><input type=checkbox id=m-blog20240628e696b9e6a188e8aebee8aea1e6a8a1e69dbf-check>
<label for=m-blog20240628e696b9e6a188e8aebee8aea1e6a8a1e69dbf-check><a href=/blog/2024/06/28/%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%A8%A1%E6%9D%BF/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e696b9e6a188e8aebee8aea1e6a8a1e69dbf><span>方案设计模板</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e591bde4bba4e8a18ce8afade6b395e7baa6e5ae9a-li><input type=checkbox id=m-blog20240628e591bde4bba4e8a18ce8afade6b395e7baa6e5ae9a-check>
<label for=m-blog20240628e591bde4bba4e8a18ce8afade6b395e7baa6e5ae9a-check><a href=/blog/2024/06/28/%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%AF%AD%E6%B3%95%E7%BA%A6%E5%AE%9A/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e591bde4bba4e8a18ce8afade6b395e7baa6e5ae9a><span>命令行语法约定</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e591bde4bba4e8a18ce6898be5868ce4b8ade68bace58fb7e79a84e590abe4b989-li><input type=checkbox id=m-blog20240628e591bde4bba4e8a18ce6898be5868ce4b8ade68bace58fb7e79a84e590abe4b989-check>
<label for=m-blog20240628e591bde4bba4e8a18ce6898be5868ce4b8ade68bace58fb7e79a84e590abe4b989-check><a href=/blog/2024/06/28/%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%89%8B%E5%86%8C%E4%B8%AD%E6%8B%AC%E5%8F%B7%E7%9A%84%E5%90%AB%E4%B9%89/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e591bde4bba4e8a18ce6898be5868ce4b8ade68bace58fb7e79a84e590abe4b989><span>命令行手册中括号的含义</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e58d8ee4b8bac-e7bc96e7a88be8a784e88c83-li><input type=checkbox id=m-blog20240628e58d8ee4b8bac-e7bc96e7a88be8a784e88c83-check>
<label for=m-blog20240628e58d8ee4b8bac-e7bc96e7a88be8a784e88c83-check><a href=/blog/2024/06/28/%E5%8D%8E%E4%B8%BAc-%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e58d8ee4b8bac-e7bc96e7a88be8a784e88c83><span>华为C++编程规范</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloge7a88be5ba8fe59198e997aee9a298e5ae9ae4bd8d-li><input type=checkbox id=m-bloge7a88be5ba8fe59198e997aee9a298e5ae9ae4bd8d-check>
<label for=m-bloge7a88be5ba8fe59198e997aee9a298e5ae9ae4bd8d-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198e997aee9a298e5ae9ae4bd8d><span>问题定位</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge7a88be5ba8fe59198environment-li><input type=checkbox id=m-bloge7a88be5ba8fe59198environment-check>
<label for=m-bloge7a88be5ba8fe59198environment-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/environment/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198environment><span>environment</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e8999ae68b9fe58685e5ad98e7a381e79b98e9858de7bdae-li><input type=checkbox id=m-blog20240628e8999ae68b9fe58685e5ad98e7a381e79b98e9858de7bdae-check>
<label for=m-blog20240628e8999ae68b9fe58685e5ad98e7a381e79b98e9858de7bdae-check><a href=/blog/2024/06/28/%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%A3%81%E7%9B%98%E9%85%8D%E7%BD%AE/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e8999ae68b9fe58685e5ad98e7a381e79b98e9858de7bdae><span>虚拟内存磁盘配置</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628wsl-li><input type=checkbox id=m-blog20240628wsl-check>
<label for=m-blog20240628wsl-check><a href=/blog/2024/06/28/wsl/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628wsl><span>wsl</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221113vs-remote-debug-li><input type=checkbox id=m-blog20221113vs-remote-debug-check>
<label for=m-blog20221113vs-remote-debug-check><a href=/blog/2022/11/13/vs-remote-debug/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221113vs-remote-debug><span>vs-remote-debug</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloge7a88be5ba8fe59198environmentvscode-li><input type=checkbox id=m-bloge7a88be5ba8fe59198environmentvscode-check>
<label for=m-bloge7a88be5ba8fe59198environmentvscode-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/environment/vscode/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198environmentvscode><span>vscode</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge7a88be5ba8fe59198os-li><input type=checkbox id=m-bloge7a88be5ba8fe59198os-check>
<label for=m-bloge7a88be5ba8fe59198os-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/os/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198os><span>OS</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge7a88be5ba8fe59198oslinux-li><input type=checkbox id=m-bloge7a88be5ba8fe59198oslinux-check>
<label for=m-bloge7a88be5ba8fe59198oslinux-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/os/linux/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198oslinux><span>linux</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628linuxe5afbce8a788-li><input type=checkbox id=m-blog20240628linuxe5afbce8a788-check>
<label for=m-blog20240628linuxe5afbce8a788-check><a href=/blog/2024/06/28/linux%E5%AF%BC%E8%A7%88/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628linuxe5afbce8a788><span>linux导览</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge7a88be5ba8fe59198oswindows-li><input type=checkbox id=m-bloge7a88be5ba8fe59198oswindows-check>
<label for=m-bloge7a88be5ba8fe59198oswindows-check><a href=/blog/%E7%A8%8B%E5%BA%8F%E5%91%98/os/windows/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge7a88be5ba8fe59198oswindows><span>windows</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e79086e8a7a3windowse7bd91e7bb9c_wfp-li><input type=checkbox id=m-blog20240628e79086e8a7a3windowse7bd91e7bb9c_wfp-check>
<label for=m-blog20240628e79086e8a7a3windowse7bd91e7bb9c_wfp-check><a href=/blog/2024/06/28/%E7%90%86%E8%A7%A3windows%E7%BD%91%E7%BB%9C_wfp/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e79086e8a7a3windowse7bd91e7bb9c_wfp><span>理解Windows网络_WFP</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e79086e8a7a3windowse4ba8be4bbb6e8b79fe8b8aa_etw-li><input type=checkbox id=m-blog20240628e79086e8a7a3windowse4ba8be4bbb6e8b79fe8b8aa_etw-check>
<label for=m-blog20240628e79086e8a7a3windowse4ba8be4bbb6e8b79fe8b8aa_etw-check><a href=/blog/2024/06/28/%E7%90%86%E8%A7%A3windows%E4%BA%8B%E4%BB%B6%E8%B7%9F%E8%B8%AA_etw/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e79086e8a7a3windowse4ba8be4bbb6e8b79fe8b8aa_etw><span>理解Windows事件跟踪_ETW</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628wireguarde9858de7bdae-li><input type=checkbox id=m-blog20240628wireguarde9858de7bdae-check>
<label for=m-blog20240628wireguarde9858de7bdae-check><a href=/blog/2024/06/28/wireguard%E9%85%8D%E7%BD%AE/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628wireguarde9858de7bdae><span>wireguard配置</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628windowse998bbe696ade7bd91e7bb9ce6b581e9878fe88eb7e58f96-li><input type=checkbox id=m-blog20240628windowse998bbe696ade7bd91e7bb9ce6b581e9878fe88eb7e58f96-check>
<label for=m-blog20240628windowse998bbe696ade7bd91e7bb9ce6b581e9878fe88eb7e58f96-check><a href=/blog/2024/06/28/windows%E9%98%BB%E6%96%AD%E7%BD%91%E7%BB%9C%E6%B5%81%E9%87%8F%E8%8E%B7%E5%8F%96/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628windowse998bbe696ade7bd91e7bb9ce6b581e9878fe88eb7e58f96><span>Windows阻断网络流量获取</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628windowse998b2e781abe5a299e7aea1e79086-netsh-li><input type=checkbox id=m-blog20240628windowse998b2e781abe5a299e7aea1e79086-netsh-check>
<label for=m-blog20240628windowse998b2e781abe5a299e7aea1e79086-netsh-check><a href=/blog/2024/06/28/windows%E9%98%B2%E7%81%AB%E5%A2%99%E7%AE%A1%E7%90%86-netsh/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628windowse998b2e781abe5a299e7aea1e79086-netsh><span>Windows防火墙管理-netsh</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628windowse79bb8e585b3e8b584e6ba90-li><input type=checkbox id=m-blog20240628windowse79bb8e585b3e8b584e6ba90-check>
<label for=m-blog20240628windowse79bb8e585b3e8b584e6ba90-check><a href=/blog/2024/06/28/windows%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628windowse79bb8e585b3e8b584e6ba90><span>Windows相关资源</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628windowse5afbce8a788-li><input type=checkbox id=m-blog20240628windowse5afbce8a788-check>
<label for=m-blog20240628windowse5afbce8a788-check><a href=/blog/2024/06/28/windows%E5%AF%BC%E8%A7%88/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628windowse5afbce8a788><span>Windows导览</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628windows-ipv6e7aea1e79086-li><input type=checkbox id=m-blog20240628windows-ipv6e7aea1e79086-check>
<label for=m-blog20240628windows-ipv6e7aea1e79086-check><a href=/blog/2024/06/28/windows-ipv6%E7%AE%A1%E7%90%86/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628windows-ipv6e7aea1e79086><span>windows-ipv6管理</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628window-message-li><input type=checkbox id=m-blog20240628window-message-check>
<label for=m-blog20240628window-message-check><a href=/blog/2024/06/28/window-message/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628window-message><span>window-message</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628win-to-go-li><input type=checkbox id=m-blog20240628win-to-go-check>
<label for=m-blog20240628win-to-go-check><a href=/blog/2024/06/28/win-to-go/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628win-to-go><span>Win-to-go</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240516e8aebee8aea1e6a8a1e5bc8fe7a9b6e7ab9fe69c89e587a0e4b8aae58e9fe58899-li><input type=checkbox id=m-blog20240516e8aebee8aea1e6a8a1e5bc8fe7a9b6e7ab9fe69c89e587a0e4b8aae58e9fe58899-check>
<label for=m-blog20240516e8aebee8aea1e6a8a1e5bc8fe7a9b6e7ab9fe69c89e587a0e4b8aae58e9fe58899-check><a href=/blog/2024/05/16/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%A9%B6%E7%AB%9F%E6%9C%89%E5%87%A0%E4%B8%AA%E5%8E%9F%E5%88%99/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240516e8aebee8aea1e6a8a1e5bc8fe7a9b6e7ab9fe69c89e587a0e4b8aae58e9fe58899><span>设计模式究竟有几个原则</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240509e5a49ae5b9b3e58fb0e58685e5aeb9e58f91e5b883e5b7a5e585b7--e89a81e5b08fe4ba8ce4bd93e9aa8c-li><input type=checkbox id=m-blog20240509e5a49ae5b9b3e58fb0e58685e5aeb9e58f91e5b883e5b7a5e585b7--e89a81e5b08fe4ba8ce4bd93e9aa8c-check>
<label for=m-blog20240509e5a49ae5b9b3e58fb0e58685e5aeb9e58f91e5b883e5b7a5e585b7--e89a81e5b08fe4ba8ce4bd93e9aa8c-check><a href=/blog/2024/05/09/%E5%A4%9A%E5%B9%B3%E5%8F%B0%E5%86%85%E5%AE%B9%E5%8F%91%E5%B8%83%E5%B7%A5%E5%85%B7--%E8%9A%81%E5%B0%8F%E4%BA%8C%E4%BD%93%E9%AA%8C/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240509e5a49ae5b9b3e58fb0e58685e5aeb9e58f91e5b883e5b7a5e585b7--e89a81e5b08fe4ba8ce4bd93e9aa8c><span>多平台内容发布工具--蚁小二体验</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240509e7ae80e4b9a6e79a84e5889be4bd9ce4bd93e9aa8c-li><input type=checkbox id=m-blog20240509e7ae80e4b9a6e79a84e5889be4bd9ce4bd93e9aa8c-check>
<label for=m-blog20240509e7ae80e4b9a6e79a84e5889be4bd9ce4bd93e9aa8c-check><a href=/blog/2024/05/09/%E7%AE%80%E4%B9%A6%E7%9A%84%E5%88%9B%E4%BD%9C%E4%BD%93%E9%AA%8C/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240509e7ae80e4b9a6e79a84e5889be4bd9ce4bd93e9aa8c><span>简书的创作体验</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge5b7a5e585b7-li><input type=checkbox id=m-bloge5b7a5e585b7-check>
<label for=m-bloge5b7a5e585b7-check><a href=/blog/%E5%B7%A5%E5%85%B7/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge5b7a5e585b7><span>工具</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge5b7a5e585b7docker-li><input type=checkbox id=m-bloge5b7a5e585b7docker-check>
<label for=m-bloge5b7a5e585b7docker-check><a href=/blog/%E5%B7%A5%E5%85%B7/docker/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge5b7a5e585b7docker><span>docker</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628dockere4bb8be7bb8d-li><input type=checkbox id=m-blog20240628dockere4bb8be7bb8d-check>
<label for=m-blog20240628dockere4bb8be7bb8d-check><a href=/blog/2024/06/28/docker%E4%BB%8B%E7%BB%8D/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628dockere4bb8be7bb8d><span>docker介绍</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge5b7a5e585b7e6b58be8af95e5b7a5e585b7-li><input type=checkbox id=m-bloge5b7a5e585b7e6b58be8af95e5b7a5e585b7-check>
<label for=m-bloge5b7a5e585b7e6b58be8af95e5b7a5e585b7-check><a href=/blog/%E5%B7%A5%E5%85%B7/%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge5b7a5e585b7e6b58be8af95e5b7a5e585b7><span>测试工具</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e7ae80e69893server-cliente4bba3e7a081-li><input type=checkbox id=m-blog20240628e7ae80e69893server-cliente4bba3e7a081-check>
<label for=m-blog20240628e7ae80e69893server-cliente4bba3e7a081-check><a href=/blog/2024/06/28/%E7%AE%80%E6%98%93server-client%E4%BB%A3%E7%A0%81/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e7ae80e69893server-cliente4bba3e7a081><span>简易server-client代码</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge5b7a5e585b7ai-li><input type=checkbox id=m-bloge5b7a5e585b7ai-check>
<label for=m-bloge5b7a5e585b7ai-check><a href=/blog/%E5%B7%A5%E5%85%B7/ai/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge5b7a5e585b7ai><span>AI</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-bloge5b7a5e585b7aicopilote7b3bbe58897-li><input type=checkbox id=m-bloge5b7a5e585b7aicopilote7b3bbe58897-check>
<label for=m-bloge5b7a5e585b7aicopilote7b3bbe58897-check><a href=/blog/%E5%B7%A5%E5%85%B7/ai/copilot%E7%B3%BB%E5%88%97/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge5b7a5e585b7aicopilote7b3bbe58897><span>Copilot系列</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-bloge5ae89e585a8-li><input type=checkbox id=m-bloge5ae89e585a8-check>
<label for=m-bloge5ae89e585a8-check><a href=/blog/%E5%AE%89%E5%85%A8/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-bloge5ae89e585a8><span>安全</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20241112e981bfe5858de58d9ae5aea2e6b384e99cb2e4b8aae4babae4bfa1e681af-li><input type=checkbox id=m-blog20241112e981bfe5858de58d9ae5aea2e6b384e99cb2e4b8aae4babae4bfa1e681af-check>
<label for=m-blog20241112e981bfe5858de58d9ae5aea2e6b384e99cb2e4b8aae4babae4bfa1e681af-check><a href=/blog/2024/11/12/%E9%81%BF%E5%85%8D%E5%8D%9A%E5%AE%A2%E6%B3%84%E9%9C%B2%E4%B8%AA%E4%BA%BA%E4%BF%A1%E6%81%AF/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20241112e981bfe5858de58d9ae5aea2e6b384e99cb2e4b8aae4babae4bfa1e681af><span>避免博客泄露个人信息</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628snort-li><input type=checkbox id=m-blog20240628snort-check>
<label for=m-blog20240628snort-check><a href=/blog/2024/06/28/snort/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628snort><span>snort</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e58fafe4bfa1e8aebee8aea1-li><input type=checkbox id=m-blog20240628e58fafe4bfa1e8aebee8aea1-check>
<label for=m-blog20240628e58fafe4bfa1e8aebee8aea1-check><a href=/blog/2024/06/28/%E5%8F%AF%E4%BF%A1%E8%AE%BE%E8%AE%A1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e58fafe4bfa1e8aebee8aea1><span>可信设计</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e58d8ee4b8bae58fafe4bfa1e6a682e5bfb5-li><input type=checkbox id=m-blog20240628e58d8ee4b8bae58fafe4bfa1e6a682e5bfb5-check>
<label for=m-blog20240628e58d8ee4b8bae58fafe4bfa1e6a682e5bfb5-check><a href=/blog/2024/06/28/%E5%8D%8E%E4%B8%BA%E5%8F%AF%E4%BF%A1%E6%A6%82%E5%BF%B5/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e58d8ee4b8bae58fafe4bfa1e6a682e5bfb5><span>华为可信概念</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628e58d8ee4b8bae58685e7bd91e7bd91e7bb9ce5ae89e585a8e58886e69e90-li><input type=checkbox id=m-blog20240628e58d8ee4b8bae58685e7bd91e7bd91e7bb9ce5ae89e585a8e58886e69e90-check>
<label for=m-blog20240628e58d8ee4b8bae58685e7bd91e7bd91e7bb9ce5ae89e585a8e58886e69e90-check><a href=/blog/2024/06/28/%E5%8D%8E%E4%B8%BA%E5%86%85%E7%BD%91%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628e58d8ee4b8bae58685e7bd91e7bd91e7bb9ce5ae89e585a8e58886e69e90><span>华为内网网络安全分析</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240628dose998b2e88c83-li><input type=checkbox id=m-blog20240628dose998b2e88c83-check>
<label for=m-blog20240628dose998b2e88c83-check><a href=/blog/2024/06/28/dos%E9%98%B2%E8%8C%83/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240628dose998b2e88c83><span>DoS防范</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog10101-li><input type=checkbox id=m-blog10101-check>
<label for=m-blog10101-check><a href=/blog/1/01/01/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog10101><span></span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog10101-li><input type=checkbox id=m-blog10101-check>
<label for=m-blog10101-check><a href=/blog/1/01/01/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-blog10101><span></span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#引言>引言</a></li><li><a href=#为什么源-ip-信息会丢失>为什么源 IP 信息会丢失?</a></li><li><a href=#如何保留源-ip>如何保留源 IP?</a></li><li><a href=#k8s-操作指导>K8S 操作指导</a><ul><li><a href=#创建-deployment>创建 Deployment</a></li><li><a href=#创建-service>创建 Service</a></li><li><a href=#创建-ingress>创建 Ingress</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-tags"><h5 class=taxonomy-title>Taxonomy Cloud</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/adguard/ data-taxonomy-term=adguard><span class=taxonomy-label>Adguard</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/adguard%E7%B3%BB%E5%88%97/ data-taxonomy-term=adguard%E7%B3%BB%E5%88%97><span class=taxonomy-label>Adguard系列</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>Blog</span><span class=taxonomy-count>7</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/copilot%E7%B3%BB%E5%88%97/ data-taxonomy-term=copilot%E7%B3%BB%E5%88%97><span class=taxonomy-label>Copilot系列</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/dns/ data-taxonomy-term=dns><span class=taxonomy-label>DNS</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/docker/ data-taxonomy-term=docker><span class=taxonomy-label>Docker</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/environment/ data-taxonomy-term=environment><span class=taxonomy-label>Environment</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/kubenetes%E7%B3%BB%E5%88%97/ data-taxonomy-term=kubenetes%E7%B3%BB%E5%88%97><span class=taxonomy-label>Kubenetes系列</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/kubenetes%E9%9B%86%E7%BE%A4%E7%B3%BB%E5%88%97/ data-taxonomy-term=kubenetes%E9%9B%86%E7%BE%A4%E7%B3%BB%E5%88%97><span class=taxonomy-label>Kubenetes集群系列</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/linux/ data-taxonomy-term=linux><span class=taxonomy-label>Linux</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/windows/ data-taxonomy-term=windows><span class=taxonomy-label>Windows</span><span class=taxonomy-count>10</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/ data-taxonomy-term=%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94><span class=taxonomy-label>个人随笔</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E5%88%9B%E4%BD%9C%E8%80%85%E5%B9%B3%E5%8F%B0/ data-taxonomy-term=%E5%88%9B%E4%BD%9C%E8%80%85%E5%B9%B3%E5%8F%B0><span class=taxonomy-label>创作者平台</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E5%8D%9A%E5%BC%88/ data-taxonomy-term=%E5%8D%9A%E5%BC%88><span class=taxonomy-label>博弈</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E5%AE%89%E5%85%A8/ data-taxonomy-term=%E5%AE%89%E5%85%A8><span class=taxonomy-label>安全</span><span class=taxonomy-count>7</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E5%AE%9D%E5%A1%94%E7%B3%BB%E5%88%97/ data-taxonomy-term=%E5%AE%9D%E5%A1%94%E7%B3%BB%E5%88%97><span class=taxonomy-label>宝塔系列</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E5%B7%A5%E5%85%B7/ data-taxonomy-term=%E5%B7%A5%E5%85%B7><span class=taxonomy-label>工具</span><span class=taxonomy-count>9</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E6%95%99%E7%A8%8B/ data-taxonomy-term=%E6%95%99%E7%A8%8B><span class=taxonomy-label>教程</span><span class=taxonomy-count>14</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E6%9C%AA%E5%88%86%E7%B1%BB/ data-taxonomy-term=%E6%9C%AA%E5%88%86%E7%B1%BB><span class=taxonomy-label>未分类</span><span class=taxonomy-count>5</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E6%9D%82%E8%B0%88/ data-taxonomy-term=%E6%9D%82%E8%B0%88><span class=taxonomy-label>杂谈</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7/ data-taxonomy-term=%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7><span class=taxonomy-label>测试工具</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/ data-taxonomy-term=%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87><span class=taxonomy-label>疑难杂症</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E7%A4%BE%E5%8C%BA%E8%A7%84%E5%88%99%E5%88%86%E6%9E%90/ data-taxonomy-term=%E7%A4%BE%E5%8C%BA%E8%A7%84%E5%88%99%E5%88%86%E6%9E%90><span class=taxonomy-label>社区规则分析</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/ data-taxonomy-term=%E7%A8%8B%E5%BA%8F%E5%91%98><span class=taxonomy-label>程序员</span><span class=taxonomy-count>6</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E7%B3%BB%E7%BB%9F/ data-taxonomy-term=%E7%B3%BB%E7%BB%9F><span class=taxonomy-label>系统</span><span class=taxonomy-count>6</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E7%B4%A2%E5%BC%95/ data-taxonomy-term=%E7%B4%A2%E5%BC%95><span class=taxonomy-label>索引</span><span class=taxonomy-count>7</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E7%BD%91%E7%BB%9C/ data-taxonomy-term=%E7%BD%91%E7%BB%9C><span class=taxonomy-label>网络</span><span class=taxonomy-count>15</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E8%A7%82%E5%BD%B1/ data-taxonomy-term=%E8%A7%82%E5%BD%B1><span class=taxonomy-label>观影</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E8%AE%BE%E5%A4%87/ data-taxonomy-term=%E8%AE%BE%E5%A4%87><span class=taxonomy-label>设备</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E8%AF%84%E6%B5%8B/ data-taxonomy-term=%E8%AF%84%E6%B5%8B><span class=taxonomy-label>评测</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E8%B0%83%E7%A0%94/ data-taxonomy-term=%E8%B0%83%E7%A0%94><span class=taxonomy-label>调研</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E8%B5%B0%E8%B5%B0%E5%81%9C%E5%81%9C/ data-taxonomy-term=%E8%B5%B0%E8%B5%B0%E5%81%9C%E5%81%9C><span class=taxonomy-label>走走停停</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E8%BF%90%E7%BB%B4/ data-taxonomy-term=%E8%BF%90%E7%BB%B4><span class=taxonomy-label>运维</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E9%98%85%E8%AF%BB/ data-taxonomy-term=%E9%98%85%E8%AF%BB><span class=taxonomy-label>阅读</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E9%98%BF%E9%87%8C%E4%BA%91%E7%B3%BB%E5%88%97/ data-taxonomy-term=%E9%98%BF%E9%87%8C%E4%BA%91%E7%B3%BB%E5%88%97><span class=taxonomy-label>阿里云系列</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E9%9B%86%E7%BE%A4/ data-taxonomy-term=%E9%9B%86%E7%BE%A4><span class=taxonomy-label>集群</span><span class=taxonomy-count>3</span></a></li></ul></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E5%8D%9A%E5%BC%88/ data-taxonomy-term=%E5%8D%9A%E5%BC%88><span class=taxonomy-label>博弈</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E5%AE%89%E5%85%A8/ data-taxonomy-term=%E5%AE%89%E5%85%A8><span class=taxonomy-label>安全</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E5%B7%A5%E5%85%B7/ data-taxonomy-term=%E5%B7%A5%E5%85%B7><span class=taxonomy-label>工具</span><span class=taxonomy-count>9</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E6%95%99%E7%A8%8B/ data-taxonomy-term=%E6%95%99%E7%A8%8B><span class=taxonomy-label>教程</span><span class=taxonomy-count>14</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/ data-taxonomy-term=%E6%9C%AA%E5%88%86%E7%B1%BB><span class=taxonomy-label>未分类</span><span class=taxonomy-count>4</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/ data-taxonomy-term=%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87><span class=taxonomy-label>疑难杂症</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E7%B3%BB%E7%BB%9F/ data-taxonomy-term=%E7%B3%BB%E7%BB%9F><span class=taxonomy-label>系统</span><span class=taxonomy-count>6</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E7%B4%A2%E5%BC%95/ data-taxonomy-term=%E7%B4%A2%E5%BC%95><span class=taxonomy-label>索引</span><span class=taxonomy-count>7</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E7%BD%91%E7%BB%9C/ data-taxonomy-term=%E7%BD%91%E7%BB%9C><span class=taxonomy-label>网络</span><span class=taxonomy-count>14</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E8%AF%84%E6%B5%8B/ data-taxonomy-term=%E8%AF%84%E6%B5%8B><span class=taxonomy-label>评测</span><span class=taxonomy-count>3</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E8%B0%83%E7%A0%94/ data-taxonomy-term=%E8%B0%83%E7%A0%94><span class=taxonomy-label>调研</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E8%BF%90%E7%BB%B4/ data-taxonomy-term=%E8%BF%90%E7%BB%B4><span class=taxonomy-label>运维</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E9%9B%86%E7%BE%A4/ data-taxonomy-term=%E9%9B%86%E7%BE%A4><span class=taxonomy-label>集群</span><span class=taxonomy-count>3</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><div class=td-content><h1>如何在集群的负载均衡过程保留请求源IP</h1><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-tags"><h5 class=taxonomy-title>Tags:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/%E7%BD%91%E7%BB%9C/ data-taxonomy-term=%E7%BD%91%E7%BB%9C><span class=taxonomy-label>网络</span></a></li><li><a class=taxonomy-term href=https://blog.jqknono.com/tags/blog/ data-taxonomy-term=blog><span class=taxonomy-label>Blog</span></a></li></ul></div><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://blog.jqknono.com/categories/%E7%BD%91%E7%BB%9C/ data-taxonomy-term=%E7%BD%91%E7%BB%9C><span class=taxonomy-label>网络</span></a></li></ul></div></header><h2 id=引言>引言</h2><p><strong>应用部署</strong>不一定总是简单的<strong>安装</strong>和<strong>运行</strong>, 有时候还需要考虑<strong>网络</strong>的问题. 本文将介绍如何在<strong>k8s集群</strong>中使服务能获取到请求的<strong>源IP</strong>.</p><p>应用提供服务一般依赖输入信息, 输入信息如果不依赖<strong>五元组</strong>(源 IP, 源端口, 目的 IP, 目的端口, 协议), 那么该服务和<strong>网络耦合性低</strong>, 不需要关心网络细节.</p><p>因此, 对多数人来说都没有阅读本文的必要, 如果你对网络感兴趣, 或者希望拓宽一点视野, 可以继续阅读下文, 了解更多的服务场景.</p><p>本文基于 k8s <code>v1.29.4</code>, 文中部分叙述混用了 pod 和 endpoint, 本文场景下可以视为等价.</p><p><strong>如果有错误, 欢迎指正, 我会及时更正.</strong></p><h2 id=为什么源-ip-信息会丢失>为什么源 IP 信息会丢失?</h2><p>我们首先明确源 IP 是什么, 当 A 向 B 发送请求, B 将请求转发给 C, 虽然 C 看到的 IP 协议的源 IP 是 B 的 IP, 但本文把<strong>A的IP</strong>看作源 IP.</p><p>主要有两类行为会导致源信息丢失:</p><ol><li><strong>网络地址转换(NAT)</strong>, 目的是节省公网 IPv4, 负载均衡等. 将导致服务端看到的源 IP 是 <strong>NAT</strong> 设备的 IP, 而不是真实的源 IP.</li><li><strong>代理(Proxy)</strong>, <strong>反向代理</strong>(RP, Reverse Proxy)和<strong>负载均衡</strong>(LB, Load Balancer)都属于这一类, 下文统称<strong>代理服务器</strong>. 这类代理服务会将请求转发给后端服务, 但是会将源 IP 替换为自己的 IP.</li></ol><ul><li>NAT 简单来说是<strong>以端口空间换IP空间</strong>, IPv4 地址有限, 一个 IP 地址可以映射 65535 个端口, 绝大多数时候这些端口没有用完, 因而可以多个子网 IP 共用一个公网 IP, 在端口上区分不同的服务. 其使用形式是: <code>public IP:public port -> private IP_1:private port</code>, 更多内容请自行参阅<a href="https://www.google.com/search?q=%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2">网络地址转换</a></li><li>代理服务是为了<strong>隐藏或暴露</strong>, 代理服务会将请求转发给后端服务, 同时将源 IP 替换为自己的 IP, 以此来隐藏后端服务的真实 IP, 保护后端服务的安全. 代理服务的使用形式是: <code>client IP -> proxy IP -> server IP</code>, 更多内容请自行参阅<a href="https://www.google.com/search?q=%E4%BB%A3%E7%90%86">代理</a></li></ul><p><strong>NAT</strong>和<strong>代理服务器</strong>都非常常见, 多数服务都无法获得请求的源 IP.</p><p><em>这是常见的两类修改源 IP 的途径, 如有其它欢迎补充.</em></p><h2 id=如何保留源-ip>如何保留源 IP?</h2><p>以下是一个 <code>HTTP 请求</code>的例子:</p><table><thead><tr><th>字段</th><th>长度（字节）</th><th>位偏移</th><th>描述</th></tr></thead><tbody><tr><td><strong>IP 首部</strong></td><td></td><td></td><td></td></tr><tr><td><code>源 IP</code></td><td>4</td><td>0-31</td><td>发送方的 IP 地址</td></tr><tr><td>目的 IP</td><td>4</td><td>32-63</td><td>接收方的 IP 地址</td></tr><tr><td><strong>TCP 首部</strong></td><td></td><td></td><td></td></tr><tr><td>源端口</td><td>2</td><td>0-15</td><td>发送端口号</td></tr><tr><td>目的端口</td><td>2</td><td>16-31</td><td>接收端口号</td></tr><tr><td>序列号</td><td>4</td><td>32-63</td><td>用于标识发送方发送的数据的字节流</td></tr><tr><td>确认号</td><td>4</td><td>64-95</td><td>如果设置了 ACK 标志，则为下一个期望收到的序列号</td></tr><tr><td>数据偏移</td><td>4</td><td>96-103</td><td>数据起始位置相对于 TCP 首部的字节数</td></tr><tr><td>保留</td><td>4</td><td>104-111</td><td>保留字段，未使用，设置为 0</td></tr><tr><td>标志位</td><td>2</td><td>112-127</td><td>各种控制标志，如 SYN、ACK、FIN 等</td></tr><tr><td>窗口大小</td><td>2</td><td>128-143</td><td>接收方可以接收的数据量</td></tr><tr><td>检验和</td><td>2</td><td>144-159</td><td>用于检测数据是否在传输过程中发生了错误</td></tr><tr><td>紧急指针</td><td>2</td><td>160-175</td><td>发送方希望接收方尽快处理的紧急数据的位置</td></tr><tr><td>选项</td><td>可变</td><td>176-&mldr;</td><td>可能包括时间戳、最大报文段长度等</td></tr><tr><td><strong>HTTP 首部</strong></td><td></td><td></td><td></td></tr><tr><td>请求行</td><td>可变</td><td>&mldr;-&mldr;</td><td>包括请求方法、URI 和 HTTP 版本</td></tr><tr><td><code>头部字段</code></td><td>可变</td><td>&mldr;-&mldr;</td><td>包含各种头部字段，如 Host、User-Agent 等</td></tr><tr><td>空行</td><td>2</td><td>&mldr;-&mldr;</td><td>用于分隔头部和主体部分</td></tr><tr><td>主体</td><td>可变</td><td>&mldr;-&mldr;</td><td>可选的请求或响应正文</td></tr></tbody></table><p>浏览以上 HTTP 请求结构, 可以发现, 有<strong>TCP选项</strong>,<strong>请求行</strong>, <strong>头部字段</strong>,<strong>主体</strong>是可变的, 其中<strong>TCP选项</strong>空间有限, 一般不会用来传递源 IP, <strong>请求行</strong>携带信息固定不能扩展, <strong>HTTP主体</strong>加密后不能修改, 只有<code>HTTP 头部字段</code>适合扩展传递源 IP.</p><p>HTTP header 中可以增加<code>X-REAL-IP</code>字段, 用来传递源 IP, 这个操作通常放在代理服务器上, 然后<strong>代理服务器</strong>会将请求发送给后端服务, 后端服务就可以通过这个字段获取到源 IP 信息.</p><p>注意, 需要保证<strong>代理服务器</strong>在<strong>NAT</strong>设备之前, 这样才能获取到真实的请求的源 whoami. 我们可以在阿里云的产品中看到<a href=https://slb.console.aliyun.com/overview><strong>负载均衡器</strong></a>这个商品单独品类, 它在网络中的位置不同于普通的应用服务器.</p><h2 id=k8s-操作指导>K8S 操作指导</h2><p>以<a href=https://github.com/traefik/whoami>whoami</a>项目为例进行部署.</p><h3 id=创建-deployment>创建 Deployment</h3><p>首先创建服务:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.io/traefik/whoami:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></div><p>这步会创建一个<strong>Deployment</strong>, 里面包含 3 个<strong>Pod</strong>, 每个 pod 包含一个容器, 该容器会运行<strong>whoami</strong>服务.</p><h3 id=创建-service>创建 Service</h3><p>可以创建<strong>NodePort</strong>或者<strong>LoadBalancer</strong>类型的服务, 支持外部访问, 或者创建<strong>ClusterIP</strong>类型的服务, 仅支持集群内部访问, 再增加<strong>Ingress</strong>服务, 通过<strong>Ingress</strong>服务暴露外部访问.</p><p><strong>NodePort</strong>既可以通过<strong>NodeIP:NodePort</strong>访问, 也可以通过<strong>Ingess</strong>服务访问, 方便测试, 本节使用<strong>NodePort</strong>服务.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>创建服务后, 以<code>curl whoami.example.com:30002</code>访问, 可以看到返回的 IP 是<strong>NodeIP</strong>, 而不是请求的源 whoami.</p><blockquote><p>请注意，这并不是正确的客户端 IP，它们是集群的内部 IP。这是所发生的事情：</p><ul><li>客户端发送数据包到 node2:nodePort</li><li>node2 使用它自己的 IP 地址替换数据包的源 IP 地址（SNAT）</li><li>node2 将数据包上的目标 IP 替换为 Pod IP</li><li>数据包被路由到 node1，然后到端点</li><li>Pod 的回复被路由回 node2</li><li>Pod 的回复被发送回给客户端</li></ul></blockquote><p>用图表示：</p><p><img src=https://s2.loli.net/2024/05/27/fDg2tBx5FIcGMZN.png></p><h4 id=配置-externaltrafficpolicy-local>配置 externalTrafficPolicy: Local</h4><blockquote><p>为避免这种情况，Kubernetes 有一个特性可以保留客户端源 IP。 如果将 service.spec.externalTrafficPolicy 设置为 Local， kube-proxy 只会将代理请求代理到本地端点，而不会将流量转发到其他节点。</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalTrafficPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>whoami</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span></code></pre></div><p>使用<code>curl whoami.example.com:30002</code>进行测试, 当<strong>whoami.example.com</strong>映射到集群多个 node 的 IP 时, 有一定比例的几率无法访问. 需要确认域名记录只含有 endpoint(pod)所在 node(节点)的 ip.</p><p>这个配置<strong>有其代价</strong>, 那就是失去了集群内的负载均衡能力, 客户端只有访问部署了 endpoint 的 node 才会得到响应.</p><p><img alt=访问路径限制 src=https://s2.loli.net/2024/05/27/PCgiTLF28XE4RKx.png></p><p>当客户端访问 Node 2 时, 不会有响应.</p><h3 id=创建-ingress>创建 Ingress</h3><p>多数服务提供给用户时使用 <strong>http/https</strong>, <strong>https://ip:port</strong>的形式可能让用户感到陌生. 一般会使用<strong>Ingress</strong>将上文创建的<strong>NodePort</strong>服务负载到一个域名的 <strong>80/443</strong> 端口下.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>external-lb-default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>whoami.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>whoami-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>应用后, 使用<code>curl whoami.example.com</code>访问测试, 可以看到 ClientIP 总是 endpoint 所在节点上的<code>Ingress Controller</code>的 Pod IP.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@client:~# curl whoami.example.com
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>RemoteAddr: 10.42.1.10:56482
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@worker:~# kubectl get -n ingress-nginx pod -o wide
</span></span><span class=line><span class=cl>NAME                                       READY   STATUS    RESTARTS   AGE    IP           NODE          NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>ingress-nginx-controller-c8f499cfc-xdrg7   1/1     Running   <span class=m>0</span>          3d2h   10.42.1.10   k3s-agent-1   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>使用<strong>Ingress</strong>反向代理<strong>NodePort</strong>服务, 也就是在 endpoint 前套了两层 service, 下图展示了二者区别.</p><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:80| B(Ingress)
    B --&gt;|10.43.38.129:32123| C[Service]
    C --&gt;|10.42.1.1:8080| D[Endpoint]</pre><pre class=mermaid>graph LR
    A[Client] --&gt;|whoami.example.com:30001| B(Service)
    B --&gt;|10.42.1.1:8080| C[Endpoint]</pre><p>在路径 1 中, 外部访问 Ingress 时, 流量先到达的 endpoint 是<code>Ingress Controller</code>, 然后再到达 endpoint <strong>whoami</strong>.<br>而<strong>Ingress Controller</strong>实质是一个<strong>LoadBalancer</strong>的服务,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl -n ingress-nginx get svc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAMESPACE   NAME             CLASS   HOSTS                       ADDRESS                                              PORTS   AGE
</span></span><span class=line><span class=cl>default     echoip-ingress   nginx   ip.example.com       172.16.0.57,2408:4005:3de:8500:4da1:169e:dc47:1707   <span class=m>80</span>      18h
</span></span><span class=line><span class=cl>default     whoami-ingress   nginx   whoami.example.com   172.16.0.57,2408:4005:3de:8500:4da1:169e:dc47:1707   <span class=m>80</span>      16h
</span></span></code></pre></div><p>因此, 可以通过将前文提到的<code>externalTrafficPolicy</code>设置到 Ingress Controller 中来保留源 IP.</p><p>同时还需要设置<code>ingress-nginx-controller</code>的<code>configmap</code>中的<code>use-forwarded-headers</code>为<code>true</code>, 以便<strong>Ingress Controller</strong>能够识别<code>X-Forwarded-For</code>或<code>X-REAL-IP</code>字段.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>allow-snippet-annotations</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>compute-full-forwarded-for</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>use-forwarded-headers</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable-real-ip</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>forwarded-for-header</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;X-Real-IP&#34;</span><span class=w> </span><span class=c># X-Real-IP or X-Forwarded-For</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/instance</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/part-of</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>1.10.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx-controller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ingress-nginx</span><span class=w>
</span></span></span></code></pre></div><p><strong>NodePort</strong>服务与<strong>ingress-nginx-controller</strong>服务的区别主要在于, <strong>NodePort</strong>的后端通常不部署在每台 node 上, 而<strong>ingress-nginx-controller</strong>的后端通常部署在每台对外暴露的 node 上.</p><p>与<strong>NodePort</strong>服务中设置<code>externalTrafficPolicy</code>会导致跨 node 的请求无响应不同, <strong>Ingress</strong>可以将请求先设置 HEADER 之后再进行代理转发, 实现了<strong>保留源 IP</strong>和<strong>负载均衡</strong>的两种能力.</p><h2 id=总结>总结</h2><ul><li><strong>地址转换(NAT)</strong>, <strong>代理(Proxy)</strong>,<strong>反向代理(Reverse Proxy)</strong>, **负载均衡(Load Balance)**会导致源 IP 丢失.</li><li>为防止源 IP 丢失, 可以代理服务器转发时将真实 IP 设置在 HTTP 头部字段<code>X-REAL-IP</code>中, 通过代理服务传递. 如果使用多层代理, 则可以使用<code>X-Forwarded-For</code>字段, 该字段以<strong>栈</strong>的形式记录了源 IP 及代理路径的 <strong>IP list</strong>.</li><li>集群<strong>NodePort</strong>服务设置<code>externalTrafficPolicy: Local</code>可以保留源 IP, 但会失去负载均衡能力.</li><li><strong>ingress-nginx-controller</strong>以<strong>daemonset</strong>形式部署在所有<strong>loadbalancer</strong>角色 node 上的前提下, 设置<code>externalTrafficPolicy: Local</code>可以保留源 IP, 且保留负载均衡能力.</li></ul><h2 id=参考>参考</h2><ul><li><a href=https://kubernetes.io/zh-cn/docs/tutorials/services/source-ip/>Kubernetes 使用源 IP</a></li><li><a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/>Ingress-Nginx Controller:ConfigMap</a></li><li><a href=https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/>Ingress Controller</a></li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>反馈</h2><p class=feedback--question>此页面是否有用？</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">是</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">否</button><p class="feedback--response feedback--response-yes">"很高兴听到这个消息！请 <a href=https://github.com/jqknono/blog/issues/new>告诉我们如何改进</a>"</p><p class="feedback--response feedback--response-no">"很抱歉听到这个消息！请 <a href=https://github.com/jqknono/blog/issues/new>告诉我们如何改进</a>"</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof gtag!="function")return;gtag("event","page_helpful",{event_category:"Helpful",event_label:window.location.pathname,value:e})};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(100)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/jqknono aria-label=Telegram><i class="fab fa-telegram"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/jqknono aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/jqknono aria-label="User mailing list"><i class=envelope></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2015&ndash;2024
<span class=td-footer__authors><a href=mailto:jqknono@gmail.com>jqknono@gmail.com</a></span></span><span class=td-footer__all_rights_reserved>保留所有权利</span></div></div></div></footer></div><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><script src=/js/deflate.js></script><script type=module async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@10.9.0\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {"theme":"default","version":"10.9.0"};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script><script src=/js/main.min.e5bf9790270b64e45f5b1b8bc98f9afd914460c3cefe6f98bf8c2010180f7de9.js integrity="sha256-5b+XkCcLZORfWxuLyY+a/ZFEYMPO/m+Yv4wgEBgPfek=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>